<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imobiliária Nova Serrana - V19.9 (Versão Final Estável)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #4f46e5; --primary-hover: #4338ca; --secondary-color: #6b7280; --accent-color: #4f46e5;
            --success-color: #16a34a; --warning-color: #f59e0b; --danger-color: #dc2626; --info-color: #0ea5e9;
            --bg-color: #f9fafb; --text-color: #374151; --card-bg: #ffffff; --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --border-radius: 8px; --border-radius-sm: 6px; --transition-speed: 0.2s ease-in-out;
            --sidebar-width: 260px; --sidebar-width-collapsed: 80px;
        }
        body.dark-mode {
            --primary-color: #818cf8; --primary-hover: #6366f1; --secondary-color: #9ca3af; --accent-color: #818cf8;
            --success-color: #4ade80; --warning-color: #fcd34d; --danger-color: #f87171; --info-color: #38bdf8;
            --bg-color: #111827; --text-color: #d1d5db; --card-bg: #1f2937; --border-color: #374151;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2); --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); transition: background-color var(--transition-speed), color var(--transition-speed); }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: #1f2937; color: #d1d5db; position: fixed; height: 100vh; z-index: 1000; transition: width var(--transition-speed); display: flex; flex-direction: column; border-right: 1px solid #374151; }
        .sidebar-header { padding: 20px; background: #111827; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; height: 65px; flex-shrink: 0; }
        .sidebar-header .logo-text { font-size: 1.2rem; display: flex; align-items: center; gap: 10px; white-space: nowrap; color: #f9fafb; }
        .sidebar-toggle { background: transparent; border: none; color: #9ca3af; font-size: 1.2rem; cursor: pointer; transition: color var(--transition-speed), transform var(--transition-speed); }
        .sidebar-toggle:hover { color: #fff; }
        .sidebar-menu { padding: 10px 0; overflow-y: auto; flex-grow: 1; }
        .menu-category { color: #9ca3af; font-size: 0.75rem; padding: 20px 25px 10px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; white-space: nowrap; }
        .menu-item { display: flex; align-items: center; padding: 12px 25px; color: #d1d5db; text-decoration: none; transition: all var(--transition-speed); border-left: 4px solid transparent; font-weight: 500; white-space: nowrap; }
        .menu-item:hover { background: #374151; color: white; }
        .menu-item.active { background: var(--primary-color); color: white; border-left-color: #a5b4fc; font-weight: 600; }
        body:not(.dark-mode) .menu-item.active { background: var(--primary-color); border-left-color: #c7d2fe; }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-footer { padding: 15px 0; border-top: 1px solid #374151; flex-shrink: 0; }
        #logout-btn:hover { background: rgba(220, 53, 69, 0.2); border-left-color: var(--danger-color); }
        .app-container.sidebar-collapsed .sidebar { width: var(--sidebar-width-collapsed); }
        .app-container.sidebar-collapsed .sidebar .logo-text span, .app-container.sidebar-collapsed .sidebar .menu-item span, .app-container.sidebar-collapsed .sidebar .menu-category { display: none; }
        .app-container.sidebar-collapsed .sidebar-header, .app-container.sidebar-collapsed .menu-item { justify-content: center; }
        .app-container.sidebar-collapsed .menu-item i { margin-right: 0; }
        .app-container.sidebar-collapsed .main-content { margin-left: var(--sidebar-width-collapsed); }
        .main-content { flex-grow: 1; margin-left: var(--sidebar-width); transition: margin-left var(--transition-speed); }
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: var(--card-bg); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 999; height: 65px; border-bottom: 1px solid var(--border-color); }
        #sidebar-toggle-top { display: none; }
        .app-container.sidebar-collapsed #sidebar-toggle-top { display: block; }
        .search-bar { position: relative; display: flex; align-items: center; background: var(--bg-color); border-radius: var(--border-radius); padding: 8px 15px; width: 350px; border: 1px solid var(--border-color); }
        .search-bar input { border: none; background: transparent; outline: none; width: 100%; padding-left: 10px; color: var(--text-color); font-size: 0.9rem; }
        .search-bar .clear-search { display: none; position: absolute; right: 10px; background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 1.1rem; }
        .top-nav-actions { display: flex; align-items: center; gap: 25px; }
        #theme-toggle, .notification-bell, #favorites-btn { color: var(--secondary-color); background: none; border: none; font-size: 1.3rem; cursor: pointer; transition: color var(--transition-speed); position:relative; }
        #theme-toggle:hover, .notification-bell:hover, #favorites-btn:hover { color: var(--text-color); }
        .notification-count, #favorites-count { position: absolute; top: -5px; right: -8px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        #favorites-count { background: var(--warning-color); color: #111; }
        .notification-dropdown { display: none; position: absolute; top: 40px; right: -20px; width: 340px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1002; max-height: 400px; border: 1px solid var(--border-color); flex-direction: column; }
        .notification-dropdown-header { padding: 12px 15px; font-weight: bold; border-bottom: 1px solid var(--border-color); }
        #notification-list { flex-grow: 1; overflow-y: auto; }
        .notification-dropdown a { display: flex; align-items: flex-start; gap: 12px; padding: 12px 15px; text-decoration: none; color: var(--text-color); border-bottom: 1px solid var(--border-color); }
        .notification-dropdown a:hover { background: var(--bg-color); }
        .notification-dropdown-footer { padding: 8px 15px; text-align: center; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .notification-dropdown-footer button { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .notification-dropdown-footer button:hover { text-decoration: underline; }
        .content-area { padding: 30px; }
        .content-wrapper { max-width: 1600px; margin: 0 auto; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; max-width: 1600px; margin-left: auto; margin-right: auto;}
        .page-title h1 { font-size: 1.6rem; font-weight: 600; color: var(--text-color); text-transform: uppercase; letter-spacing: 0.5px; }
        .page-actions { display: flex; gap: 10px; }
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); margin-bottom: 30px; border: 1px solid var(--border-color); overflow: hidden; transition: all var(--transition-speed); }
        .card-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg); }
        .card-header h3 { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px;}
        .card-body { padding: 25px; }
        .dashboard-card { background: linear-gradient(135deg, var(--card-bg) 0%, color-mix(in srgb, var(--card-bg) 85%, var(--primary-color)) 100%); }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .dashboard-card-value { font-size: 2.0rem; font-weight: 700; color: var(--primary-color); }
        .form-row { display: flex; margin: 0 -15px; flex-wrap: wrap; }
        .form-col { flex: 1; padding: 0 15px; min-width: 200px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        .form-label.required:after { content: ' *'; color: var(--danger-color); }
        .form-control { width: 100%; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; background: var(--bg-color); color: var(--text-color); transition: border-color var(--transition-speed), box-shadow var(--transition-speed); }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent); }
        .form-control.is-invalid { border-color: var(--danger-color); }
        .invalid-feedback { color: var(--danger-color); font-size: 0.8rem; margin-top: 4px; display: none; }
        .form-control.is-invalid ~ .invalid-feedback { display: block; }
        fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 20px; margin-bottom: 25px; }
        legend { padding: 0 10px; font-weight: 600; color: var(--secondary-color); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px; border: 1px solid transparent; border-radius: var(--border-radius-sm); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all var(--transition-speed); text-decoration: none; }
        .btn:disabled { background-color: #bdc3c7 !important; color: #7f8c8d !important; cursor: not-allowed; opacity: 0.6; }
        .btn i { margin-right: 8px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background: #b91c1c; }
        .btn-info { background: var(--info-color); color: white; }
        .btn-warning { background: var(--warning-color); color: #111827; }
        body.dark-mode .btn-warning { color: #1f2937; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #525a66; }
        .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); background-color: transparent;}
        .btn-outline-primary:hover { background-color: var(--primary-color); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-lg { padding: 12px 24px; font-size: 1.0rem; }
        .table-responsive { overflow-x: auto; } .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; transition: padding 0.2s ease-in-out; }
        .table.compact-view th, .table.compact-view td { padding: 8px 15px; font-size: 0.9rem; }
        .table th { background: var(--bg-color); font-weight: 600; color: var(--secondary-color); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; cursor: pointer; }
        .table th:hover { background-color: var(--border-color); }
        .table th .sort-indicator { margin-left: 5px; opacity: 0.5; }
        .table tr:hover { background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-bg)); }
        .table .price-entry { color: var(--success-color); font-weight: 600; } .table .price-exit { color: var(--danger-color); font-weight: 600;}
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .status-badge.pendente { background-color: color-mix(in srgb, var(--warning-color) 25%, transparent); color: var(--warning-color); }
        .status-badge.pago { background-color: color-mix(in srgb, var(--success-color) 25%, transparent); color: var(--success-color); }
        .status-badge.atrasado { background-color: color-mix(in srgb, var(--danger-color) 25%, transparent); color: var(--danger-color); }
        .pagination-container { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .pagination-info { font-size: 0.9rem; color: var(--secondary-color); }
        .pagination-controls button { margin-left: 5px; }
        .property-card { position: relative; flex-direction: column; display: flex; border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; }
        .property-card-img-wrapper { width: 100%; height: 180px; background-color: var(--bg-color); position: relative; }
        .property-card-img { width: 100%; height: 100%; object-fit: cover; }
        .property-card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .property-card-price { font-size: 1.3rem; font-weight: bold; color: var(--primary-color); margin-bottom: 8px; }
        .property-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 12px; height: 40px; overflow: hidden; }
        .property-card-details { display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85rem; color: var(--secondary-color); margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .property-card-details span { display: flex; align-items: center; gap: 6px; }
        .property-card-actions { padding: 15px; display: flex; gap: 10px; }
        .favorite-star { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; color: rgba(255,255,255,0.7); cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: color 0.2s, transform 0.2s; }
        .favorite-star:hover { transform: scale(1.2); }
        .favorite-star.favorited { color: var(--warning-color); }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1001; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal-content { background: var(--card-bg); border-radius: var(--border-radius); width: 900px; max-width: 95%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: var(--shadow); transform: scale(0.95); animation: scaleUp 0.3s ease forwards; }
        @keyframes scaleUp { to { transform: scale(1); } }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 25px; overflow-y: auto; flex-grow: 1; min-height: 0; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; background-color: var(--bg-color); flex-shrink: 0; }
        .notification { position: fixed; top: 80px; right: 20px; padding: 15px 20px; border-radius: var(--border-radius); color: white; box-shadow: var(--shadow); z-index: 1100; animation: slideIn 0.3s, fadeOut 0.5s 4.5s forwards; display: flex; align-items: center; gap: 10px;}
        .notification i { font-size: 1.5rem; }
        .notification.success { background: var(--success-color); } .notification.error { background: var(--danger-color); } .notification.info { background: var(--info-color); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fa-spinner { animation: spin 1s linear infinite; }
        .spinner-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; color: var(--primary-color); }
        .file-upload-input { display: none; }
        .file-attachment-group { padding: 15px; background: var(--bg-color); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); }
        .file-list-form { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; margin-bottom: 10px; }
        .file-list-form .file-info { display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-list-form .file-actions button { background: none; border: none; cursor: pointer; color: var(--secondary-color); transition: color var(--transition-speed); padding: 2px 5px; }
        .file-list-form .file-actions button:hover { color: var(--text-color); }
        .file-list-form .file-actions .download-btn:hover { color: var(--success-color); }
        .file-list-form .file-actions .remove-btn:hover { color: var(--danger-color); }
        .kanban-board { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; }
        .kanban-column { flex: 1 1 320px; background: color-mix(in srgb, var(--bg-color) 50%, var(--card-bg)); border-radius: var(--border-radius); }
        .kanban-column-header { font-weight: bold; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); flex-wrap: wrap; gap: 5px; }
        .kanban-column-header .kanban-stage-title { font-size: 1.1rem; }
        .kanban-column-header .kanban-stage-count { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        .kanban-column-header .kanban-stage-total { font-size: 0.9rem; font-weight: 500; width: 100%; text-align: right; }
        .kanban-column[data-stage="lead"] .kanban-column-header { background-color: #6b7280; }
        .kanban-column[data-stage="contacted"] .kanban-column-header { background-color: #0ea5e9; }
        .kanban-column[data-stage="visiting"] .kanban-column-header { background-color: #f59e0b; }
        .kanban-column[data-stage="proposal"] .kanban-column-header { background-color: #4f46e5; }
        .kanban-column[data-stage="won"] .kanban-column-header { background-color: #16a34a; }
        .kanban-column[data-stage="lost"] .kanban-column-header { background-color: #dc2626; }
        .kanban-cards { min-height: 100px; padding: 15px; }
        .kanban-card { background: var(--card-bg); padding: 15px; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-sm); margin-bottom: 10px; cursor: grab; border-left: 4px solid var(--border-color); }
        .kanban-card:hover { border-left-color: var(--primary-color); box-shadow: var(--shadow); }
        .kanban-card:active { cursor: grabbing; background: var(--bg-color); }
        .kanban-card strong { display: block; margin-bottom: 5px; }
        .kanban-card-deal { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); font-weight: bold; color: var(--success-color); }
        .kanban-card.stagnated-card { border-left-color: var(--danger-color) !important; animation: pulse-danger 2s infinite; }
        @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-color) 40%, transparent); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        #global-search-results { display: none; position: absolute; top: 55px; left: 0; width: 100%; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1003; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); }
        .search-result-category { font-weight: bold; text-transform: uppercase; font-size: 0.8rem; padding: 10px 15px 5px; color: var(--secondary-color); }
        .search-result-item { display: block; padding: 10px 15px; color: var(--text-color); text-decoration: none; }
        .search-result-item:hover { background: var(--bg-color); }
        .search-result-item i { margin-right: 10px; color: var(--accent-color); }
        .dossie-section { margin-bottom: 25px; }
        .dossie-section h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .note-item { background: var(--bg-color); padding: 10px; border-radius: var(--border-radius-sm); margin-bottom: 10px; }
        .note-item-meta { font-size: 0.8rem; color: var(--secondary-color); margin-bottom: 5px; }
        .action-item { padding: 12px 15px; margin-bottom: 10px; border-radius: var(--border-radius-sm); border-left: 4px solid; cursor: pointer; transition: background-color var(--transition-speed); display: flex; align-items: center; gap: 10px; }
        .action-item:hover { background-color: var(--bg-color); }
        .action-item.warning { border-color: var(--warning-color); background-color: color-mix(in srgb, var(--warning-color) 15%, transparent); }
        .action-item.info { border-color: var(--info-color); background-color: color-mix(in srgb, var(--info-color) 15%, transparent); }
        .action-item.birthday { border-color: #db2777; background-color: color-mix(in srgb, #db2777 15%, transparent); }
        .action-item.birthday-soon { border-color: var(--success-color); background-color: color-mix(in srgb, var(--success-color) 15%, transparent); }
        .action-item.backup { border-color: var(--danger-color); background-color: color-mix(in srgb, var(--danger-color) 15%, transparent); }
        .action-item.agenda { border-color: var(--primary-color); background-color: color-mix(in srgb, var(--primary-color) 15%, transparent); }
        .action-item.postsale { border-color: #6d28d9; background-color: color-mix(in srgb, #6d28d9 15%, transparent); }
        .post-sale-task { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: var(--bg-color); border-radius: var(--border-radius-sm); margin-bottom: 8px; }
        .post-sale-task.completed { text-decoration: line-through; color: var(--secondary-color); background-color: transparent; border: 1px solid var(--border-color); }
        .post-sale-task.completed .btn { display: none; }
        .post-sale-task-info { display: flex; align-items: center; gap: 10px; }
        .public-page-container { max-width: 900px; margin: 40px auto; padding: 30px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .public-page-container h1 { font-size: 2rem; color: var(--primary-color); }
        .public-page-container .photos { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .public-page-container .photos img { width: 100%; height: auto; object-fit: cover; border-radius: var(--border-radius-sm); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--border-color); border: 1px solid var(--border-color); }
        .calendar-day-header, .calendar-day { padding: 8px; background-color: var(--card-bg); }
        .calendar-day-header { text-align: center; font-weight: bold; }
        .calendar-day { min-height: 100px; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day:hover { background-color: var(--bg-color); }
        .calendar-day.today .day-number { font-weight: bold; background-color: var(--primary-color); color: white; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; }
        .calendar-event { font-size: 0.8rem; background: var(--info-color); color: white; padding: 2px 5px; margin-top: 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .simulation-nav { display: flex; gap: 10px; margin-bottom: 25px; }
        .simulation-nav .btn { flex: 1; padding: 12px; font-size: 1rem; }
        .simulation-content { display: none; animation: fadeIn 0.4s; }
        .simulation-content.active { display: block; }
        .simulation-results-wrapper { display: none; margin-top: 30px; padding: 25px; background-color: var(--bg-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); animation: fadeIn 0.5s ease; }
        .simulation-results-header { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .simulation-result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .simulation-result-card { background-color: var(--card-bg); padding: 20px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); }
        .simulation-result-card h4 { font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .simulation-result-card p { font-size: 1rem; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .simulation-result-card p span:first-child { display: flex; align-items: center; gap: 8px; color: var(--secondary-color); }
        .simulation-result-card p span:last-child { font-weight: 700; font-size: 1.1rem; color: var(--primary-color); }
        .simulation-result-card p .total-value { color: var(--success-color); font-size: 1.2rem; }
        .contract-template-container { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5; padding: 40px; background: white; color: black; margin: 0 auto; max-width: 21cm; }
        body.dark-mode .contract-template-container { background: #e2e8f0; color: #111827; }
        .empty-state { text-align: center; padding: 50px; color: var(--secondary-color); }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; color: var(--border-color); }
        .empty-state p { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; }
        .detail-modal-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top: 15px; }
        .detail-modal-gallery img { width: 100px; height: 75px; object-fit: cover; border-radius: var(--border-radius-sm); cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .detail-modal-gallery img:hover, .detail-modal-gallery img.active { opacity: 1; border: 2px solid var(--primary-color); }
        .template-variable-list { list-style-type: none; padding: 10px; background-color: var(--bg-color); border-radius: var(--border-radius-sm); font-family: monospace; font-size: 0.9rem; }
        .template-variable-list li { margin-bottom: 5px; }
        .matching-list { max-height: 200px; overflow-y: auto; padding-right: 10px; }
        .matching-item { background: var(--bg-color); padding: 10px; border-radius: var(--border-radius-sm); margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; }
        .matching-item:hover { background-color: var(--border-color); }
        .matching-item strong { display: block; }
        .contextual-actions-bar { display: none; padding: 10px 15px; background-color: var(--primary-color); color: white; margin-bottom: 20px; border-radius: var(--border-radius); align-items: center; justify-content: space-between; animation: fadeIn 0.3s; }
        .contextual-actions-bar span { font-weight: 600; }
        .contextual-actions-bar .actions { display: flex; gap: 10px; }
        .missing-info-highlight { color: var(--danger-color); font-weight: bold; background-color: color-mix(in srgb, var(--warning-color) 20%, transparent); padding: 2px; border-radius: 3px; }
    </style>
</head>
<body style="visibility: hidden;"> <!-- Adicionado visibility: hidden -->
    <div id="app-view">
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 class="logo-text"><i class="fas fa-building"></i> <span>Nova Serrana</span></h3>
                <button class="sidebar-toggle" id="sidebar-toggle-main"><i class="fas fa-bars"></i></button>
            </div>
            <div class="sidebar-menu">
                <div class="menu-category">Principal</div>
                <a href="#" class="menu-item active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                <a href="#" class="menu-item" data-tab="funil"><i class="fas fa-filter"></i><span>Funil de Vendas</span></a>
                <div class="menu-category">Cadastros</div>
                <a href="#" class="menu-item" data-tab="clientes"><i class="fas fa-users"></i><span>Clientes</span></a>
                <a href="#" class="menu-item" data-tab="imoveis"><i class="fas fa-home"></i><span>Imóveis</span></a>
                <a href="#" class="menu-item" data-tab="corretores"><i class="fas fa-user-tie"></i><span>Corretores</span></a>
                <div class="menu-category">Operações</div>
                <a href="#" class="menu-item" data-tab="contratos"><i class="fas fa-file-contract"></i><span>Contratos</span></a>
                <a href="#" class="menu-item" data-tab="agenda"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a>
                <a href="#" class="menu-item" data-tab="simulacao"><i class="fas fa-calculator"></i><span>Simulação</span></a>
                <a href="#" class="menu-item" data-tab="comissoes"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span></a>
                <div class="menu-category">Sistema</div>
                <a href="#" class="menu-item" data-tab="financeiro" data-role="admin-only"><i class="fas fa-coins"></i><span>Financeiro</span></a>
                <a href="#" class="menu-item" data-tab="analises" data-role="admin-only"><i class="fas fa-chart-line"></i><span>Análises</span></a>
                <a href="#" class="menu-item" data-tab="relatorios" data-role="admin-only"><i class="fas fa-chart-bar"></i><span>Relatórios</span></a>
                <a href="#" class="menu-item" data-tab="ajuda"><i class="fas fa-question-circle"></i><span>Ajuda</span></a>
                <a href="#" class="menu-item" data-tab="config" data-role="admin-only"><i class="fas fa-cog"></i><span>Configurações</span></a>
            </div>
            <div class="sidebar-footer">
                <a href="#" class="menu-item" id="logout-btn" title="Sair do Sistema"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
            </div>
        </div>

        <div class="main-content">
            <div class="top-nav">
                <button class="sidebar-toggle" id="sidebar-toggle-top"><i class="fas fa-bars"></i></button>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="main-search-bar" placeholder="Pesquisar em todo o sistema...">
                    <button class="clear-search" id="clear-search-btn" title="Limpar pesquisa">×</button>
                    <div id="global-search-results"></div>
                </div>
                <div class="top-nav-actions">
                    <button id="favorites-btn" title="Imóveis Favoritos">
                        <i class="fas fa-star"></i>
                        <span class="notification-count" id="favorites-count">0</span>
                    </button>
                    <div class="notification-bell" id="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notification-count">0</span>
                        <div class="notification-dropdown" id="notification-dropdown">
                            <div class="notification-dropdown-header">Notificações</div>
                            <div id="notification-list"></div>
                            <div class="notification-dropdown-footer"><button id="clear-notifications-btn">Limpar todas</button></div>
                        </div>
                    </div>
                    <button id="theme-toggle" title="Alternar tema"><i class="fas fa-moon"></i></button>
                </div>
            </div>
            <div class="content-area">
                <div class="tab-content active" id="dashboard">
                    <div class="page-header">
                        <div class="page-title"><h1>Dashboard</h1></div>
                        <div class="page-actions" id="dashboard-filters">
                            <select id="dashboard-period-select" class="form-control" style="width: 200px;">
                                <option value="all_time">Todo o Período</option>
                                <option value="this_month" selected>Este Mês</option>
                                <option value="last_30_days">Últimos 30 Dias</option>
                                <option value="this_year">Este Ano</option>
                            </select>
                        </div>
                    </div>
                    <div class="content-wrapper">
                        <div class="form-row">
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4>Vendas (VGV)</h4><div class="dashboard-card-value" id="db-total-vendas">R$ 0,00</div></div></div></div>
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4>Receita Aluguéis (Mês)</h4><div class="dashboard-card-value" id="db-total-alugueis">R$ 0,00</div></div></div></div>
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4>Clientes Ativos</h4><div class="dashboard-card-value" id="db-total-clientes">0</div></div></div></div>
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4>Contratos Ativos</h4><div class="dashboard-card-value" id="db-total-contratos">0</div></div></div></div>
                        </div>
                        <div id="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                            <div class="card" style="grid-column: span 2;"><div class="card-header"><h3>Vendas por Mês</h3></div><div class="card-body"><canvas id="salesChart"></canvas></div></div>
                            <div class="card"><div class="card-header"><h3>Imóveis por Tipo</h3></div><div class="card-body"><canvas id="propertyTypeChart"></canvas></div></div>
                            <div class="card" style="grid-column: 1 / -1;">
                                <div class="card-header"><h3><i class="fas fa-exclamation-circle" style="color: var(--primary-color);"></i>Ações Recomendadas</h3></div>
                                <div class="card-body" id="actionable-items-container"></div>
                            </div>
                            <div class="card" style="grid-column: 1 / -1;"><div class="card-header"><h3>Atividades Recentes</h3></div><div class="card-body activity-feed" id="activity-feed"></div></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="funil">
                    <div class="page-header"><div class="page-title"><h1>Funil de Vendas</h1></div></div>
                    <div class="content-wrapper">
                        <div class="kanban-board" id="kanban-board">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="clientes">
                    <div class="page-header"><div class="page-title"><h1>Clientes</h1></div><div class="page-actions"><button class="btn btn-primary" id="novo-cliente-btn"><i class="fas fa-plus"></i> Novo Cliente (Alt+C)</button></div></div>
                    <div class="content-wrapper"><div class="card"><div class="card-header"><h3><i class="fas fa-users"></i>Lista de Clientes</h3></div><div class="card-body">
                        <div class="table-filter-container" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="clientes-filter-text" class="form-control" placeholder="Filtrar por nome, CPF/CNPJ ou e-mail..." style="flex-grow: 2; min-width: 250px;">
                            <select id="clientes-filter-spc" class="form-control" style="flex-grow: 1; min-width: 150px;">
                                <option value="">Todos Status SPC</option>
                                <option value="nao_verificado">Não Verificado</option>
                                <option value="limpo">Limpo</option>
                                <option value="restricao">Com Restrição</option>
                            </select>
                            <button id="clientes-clear-filters" class="btn btn-secondary">Limpar</button>
                            <button id="clientes-compact-view-toggle" class="btn btn-outline-primary" style="margin-left: auto;"><i class="fas fa-compress-arrows-alt"></i> Visão Compacta</button>
                        </div>
                        <div id="clientes-contextual-bar" class="contextual-actions-bar">
                            <span id="clientes-selection-count"></span>
                            <div class="actions">
                                 <button class="btn btn-sm btn-warning" id="clientes-export-selected-btn"><i class="fas fa-file-excel"></i> Exportar</button>
                            </div>
                        </div>
                        <div class="table-responsive"><table class="table" id="clientes-table"><thead><tr id="clientes-table-header"></tr></thead><tbody id="clientes-table-body"></tbody></table></div>
                        <div class="pagination-container" id="clientes-pagination"></div>
                    </div></div></div>
                </div>

                <div class="tab-content" id="imoveis">
                     <div class="page-header"><div class="page-title"><h1>Imóveis</h1></div><div class="page-actions"><button class="btn btn-sm" id="imoveis-view-toggle"><i class="fas fa-list"></i> Tabela</button><button class="btn btn-primary" id="novo-imovel-btn"><i class="fas fa-plus"></i> Novo Imóvel (Alt+I)</button></div></div>
                     <div class="content-wrapper"><div class="card"><div class="card-header"><h3><i class="fas fa-home"></i>Lista de Imóveis</h3></div><div class="card-body">
                        <div class="table-filter-container" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="imoveis-filter-text" class="form-control" placeholder="Filtrar por endereço ou proprietário..." style="flex-grow: 2; min-width: 250px;">
                            <select id="imoveis-filter-tipo" class="form-control" style="flex-grow: 1; min-width: 150px;">
                                <option value="">Todos os Tipos</option>
                                <option>Apartamento</option><option>Casa</option><option>Galpão</option><option>Kitnet</option><option>Quadra</option><option>Sala Comercial</option><option>Terreno</option>
                            </select>
                             <select id="imoveis-filter-quartos" class="form-control" style="flex-grow: 1; min-width: 120px;">
                                <option value="">Quartos (Todos)</option>
                                <option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option>
                            </select>
                            <select id="imoveis-filter-status" class="form-control" style="flex-grow: 1; min-width: 150px;">
                                <option value="">Todos os Status</option>
                                <option>Disponível</option><option>Vendido</option><option>Alugado</option>
                            </select>
                            <button id="imoveis-clear-filters" class="btn btn-secondary">Limpar</button>
                            <button id="imoveis-compact-view-toggle" class="btn btn-outline-primary" style="margin-left: auto; display: none;"><i class="fas fa-compress-arrows-alt"></i> Visão Compacta</button>
                        </div>
                        <div id="imoveis-table-view-container" style="display: none;">
                            <div id="imoveis-contextual-bar" class="contextual-actions-bar">
                                <span id="imoveis-selection-count"></span>
                                <div class="actions">
                                    <select id="imoveis-bulk-status-select" class="form-control btn-sm" style="height: 35px;">
                                        <option value="">Alterar Status...</option>
                                        <option>Disponível</option><option>Vendido</option><option>Alugado</option>
                                    </select>
                                    <button class="btn btn-sm btn-info" id="imoveis-bulk-action-btn">Aplicar</button>
                                    <button class="btn btn-sm btn-warning" id="imoveis-export-selected-btn"><i class="fas fa-file-excel"></i> Exportar</button>
                                </div>
                            </div>
                            <div class="table-responsive"><table class="table" id="imoveis-table"><thead><tr id="imoveis-table-header"></tr></thead><tbody id="imoveis-table-body"></tbody></table></div>
                            <div class="pagination-container" id="imoveis-pagination"></div>
                        </div>
                        <div id="imoveis-netflix-view" style="display: block;"></div>
                    </div></div></div>
                </div>

                <div class="tab-content" id="corretores">
                    <div class="page-header"><div class="page-title"><h1>Corretores</h1></div><div class="page-actions"><button class="btn btn-primary" id="novo-corretor-btn"><i class="fas fa-plus"></i> Novo Corretor (Alt+R)</button></div></div>
                    <div class="content-wrapper"><div class="card"><div class="card-header"><h3><i class="fas fa-user-tie"></i>Lista de Corretores</h3></div><div class="card-body">
                        <div class="table-filter-container" style="margin-bottom: 20px;"><input type="text" class="form-control" id="corretores-filter" placeholder="Filtrar corretores por nome ou CRECI..."></div>
                        <div class="table-responsive"><table class="table" id="corretores-table"><thead><tr id="corretores-table-header"></tr></thead><tbody id="corretores-table-body"></tbody></table></div>
                        <div class="pagination-container" id="corretores-pagination"></div>
                    </div></div></div>
                </div>
<div class="tab-content" id="contratos">
                    <div class="page-header"><div class="page-title"><h1>Contratos</h1></div><div class="page-actions"><button class="btn btn-primary" id="novo-contrato-btn"><i class="fas fa-plus"></i> Novo Contrato</button></div></div>
                    <div class="content-wrapper"><div class="card"><div class="card-header"><h3><i class="fas fa-file-contract"></i>Lista de Contratos</h3></div><div class="card-body">
                        <div class="table-filter-container" style="margin-bottom: 20px;"><input type="text" class="form-control" id="contratos-filter" placeholder="Filtrar contratos por número, cliente ou imóvel..."></div>
                        <div class="table-responsive"><table class="table"><thead><tr id="contratos-table-header"></tr></thead><tbody id="contratos-table-body"></tbody></table></div>
                        <div class="pagination-container" id="contratos-pagination"></div>
                    </div></div></div>
                </div>

                <div class="tab-content" id="agenda">
                    <div class="page-header"><div class="page-title"><h1>Agenda</h1></div></div>
                    <div class="content-wrapper">
                        <div class="card">
                            <div class="card-header">
                               <div class="calendar-controls" style="display: flex; align-items: center; gap: 10px;">
                                    <button class="btn btn-sm" id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                                    <h4 id="current-month-year" style="margin:0;"></h4>
                                    <button class="btn btn-sm" id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="calendar-view-toggle">
                                    <button class="btn btn-sm" id="grid-view-btn" title="Visão em Grade"><i class="fas fa-th"></i></button>
                                    <button class="btn btn-sm" id="list-view-btn" title="Visão em Lista"><i class="fas fa-list"></i></button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="calendar-container">
                                    <div class="calendar-grid" id="calendar-grid-view"></div>
                                    <div id="calendar-list-view" style="display: none;"><div class="table-responsive"><table class="table"><thead><tr><th>Data</th><th>Horário</th><th>Evento</th></tr></thead><tbody></tbody></table></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
 
                <div class="tab-content" id="simulacao">
                    <div class="page-header"><div class="page-title"><h1>Simulações</h1></div></div>
                    <div class="content-wrapper">
                        <div class="simulation-nav">
                            <button class="btn btn-primary" data-target="#financiamento-container"><i class="fas fa-home"></i> Financiamento de Imóvel</button>
                            <button class="btn btn-outline-primary" data-target="#lote-container"><i class="fas fa-map-marked-alt"></i> Parcelamento de Lote</button>
                        </div>
                        <div id="financiamento-container" class="simulation-content active">
                            <div class="card"><div class="card-header"><h3>Dados para Simulação de Financiamento</h3></div>
                                <div class="card-body">
                                    <form id="financiamento-form">
                                        <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Valor do Imóvel (R$)</label><input type="text" id="fin-valor-imovel" class="form-control currency-input" placeholder="Ex: 350.000,00" required></div></div><div class="form-col"><div class="form-group"><label class="form-label">Valor da Entrada (R$)</label><input type="text" id="fin-valor-entrada" class="form-control currency-input" placeholder="Ex: 70.000,00" required></div></div><div class="form-col"><div class="form-group"><label class="form-label">Prazo (anos)</label><input type="number" id="fin-prazo-anos" class="form-control" placeholder="Ex: 30" required></div></div><div class="form-col"><div class="form-group"><label class="form-label">Juros Anual (%)</label><input type="number" step="0.01" id="fin-taxa-juros" class="form-control" placeholder="Ex: 8.5" required></div></div></div>
                                        <div class="form-group" style="max-width: 300px;"><label class="form-label">Índice Correção Anual (IGPM/IPCA %)</label><input type="number" step="0.1" id="fin-taxa-correcao" class="form-control" value="5.0" placeholder="Ex: 5.0"></div>
                                        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;"><i class="fas fa-play-circle"></i> Simular Financiamento</button>
                                    </form>
                                </div>
                            </div>
                            <div class="simulation-results-wrapper" id="financiamento-resultados-wrapper">
                                <div class="simulation-results-header"><i class="fas fa-poll"></i>Resultados da Simulação de Financiamento</div>
                                <div class="simulation-result-grid"><div class="simulation-result-card" id="price-result-card"><h4>Tabela PRICE</h4><p><span><i class="fas fa-wallet"></i> Parcela Fixa Mensal</span> <span id="price-res-parcela"></span></p><p><span><i class="fas fa-chart-line"></i> Custo Total</span> <span id="price-res-total-pago"></span></p><p><span><i class="fas fa-percent"></i> Total de Juros</span> <span class="total-value" id="price-res-total-juros"></span></p></div><div class="simulation-result-card" id="sac-result-card"><h4>Tabela SAC</h4><p><span><i class="fas fa-arrow-up"></i> 1ª Parcela</span> <span id="sac-res-primeira-parcela"></span></p><p><span><i class="fas fa-arrow-down"></i> Última Parcela</span> <span id="sac-res-ultima-parcela"></span></p><p><span><i class="fas fa-chart-line"></i> Custo Total</span> <span id="sac-res-total-pago"></span></p><p><span><i class="fas fa-percent"></i> Total de Juros</span> <span class="total-value" id="sac-res-total-juros"></span></p></div><div class="simulation-result-card" id="gradiente-result-card"><h4>Gradiente (c/ Correção)</h4><p><span><i class="far fa-calendar-alt"></i> Parcela 1º Ano (aprox.)</span> <span id="grad-res-parcela-ano1"></span></p><p><span><i class="far fa-calendar-check"></i> Parcela 2º Ano (est.)</span> <span id="grad-res-parcela-ano2"></span></p><p><span><i class="fas fa-chart-line"></i> Custo Total (Estimado)</span> <span id="grad-res-total-pago"></span></p><p><span><i class="fas fa-info-circle"></i> Base</span> <span style="font-size:0.9rem;">SAC + Correção Anual</span></p></div></div>
                                <div class="modal-footer" style="background: transparent; padding-top: 20px;">
                                    <select id="fin-sim-cliente-select" class="form-control" style="width: 250px;"></select>
                                    <button class="btn btn-primary" id="save-fin-simulation-btn"><i class="fas fa-save"></i> Salvar no Dossiê</button>
                                </div>
                            </div>
                        </div>
                        <div id="lote-container" class="simulation-content">
                           <div class="card">
                                <div class="card-header"><h3>Dados para Simulação de Lote</h3></div>
                                <div class="card-body">
                                    <form id="lote-form">
                                        <div class="form-row">
                                            <div class="form-col"><div class="form-group"><label class="form-label">Valor do Lote (R$)</label><input type="text" id="lote-valor" class="form-control currency-input" placeholder="Ex: 120.000,00" required></div></div>
                                            <div class="form-col"><div class="form-group"><label class="form-label">Valor da Entrada (R$)</label><input type="text" id="lote-entrada" class="form-control currency-input" placeholder="Ex: 12.000,00" required></div></div>
                                            <div class="form-col"><div class="form-group"><label class="form-label">Valor da Corretagem (R$)</label><input type="text" id="lote-corretagem" class="form-control currency-input" placeholder="Ex: 5.000,00"></div></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-col" style="flex: 0 0 33.33%;"><div class="form-group"><label class="form-label">Nº de Parcelas</label><input type="number" id="lote-parcelas" class="form-control" placeholder="Ex: 120" required><div style="margin-top: 10px; display:flex; gap: 5px;"><button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('lote-parcelas').value = 96;">96x</button><button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('lote-parcelas').value = 120;">120x</button><button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('lote-parcelas').value = 144;">144x</button></div></div></div>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%"><i class="fas fa-play-circle"></i> Simular Parcelamento</button>
                                    </form>
                                </div>
                            </div>
                            <div class="simulation-results-wrapper" id="lote-resultados-wrapper">
                                <div class="simulation-results-header"><i class="fas fa-poll"></i>Resultado do Parcelamento</div>
                                 <div class="simulation-result-grid" style="grid-template-columns: 1fr;"><div class="simulation-result-card"><h4>Detalhes do Parcelamento</h4><p><span><i class="fas fa-file-invoice-dollar"></i> Saldo a Parcelar</span> <span id="lote-res-saldo"></span></p><p><span><i class="fas fa-money-bill-wave"></i> Parcela Mensal</span> <span class="total-value" id="lote-res-parcela"></span></p><p><span><i class="fas fa-calendar-check"></i> Início do Pagamento</span> <span id="lote-res-data-inicio"></span></p><p><span><i class="fas fa-calendar-times"></i> Fim do Pagamento</span> <span id="lote-res-data-fim"></span></p></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="comissoes">
                    <div class="page-header"><div class="page-title"><h1>Cálculo de Comissão</h1></div></div>
                    <div class="content-wrapper"><div class="card" style="max-width: 800px; margin: 0 auto;">
                            <div class="card-header"><h3><i class="fas fa-hand-holding-usd"></i>Calculadora de Comissão de Venda</h3></div>
                            <div class="card-body">
                                <form id="comissao-form">
                                    <div class="form-group"><label class="form-label">Valor da Venda (R$)</label><input type="text" id="com-valor-venda" class="form-control currency-input" placeholder="Ex: 500.000,00"></div>
                                    <div class="form-group"><label class="form-label">Percentual da Comissão (%)</label><input type="number" step="0.1" id="com-percentual" class="form-control" value="6"></div>
                                    <div class="form-group"><label class="form-check" style="display:flex; align-items:center; gap:10px;"><input type="checkbox" id="com-dividir-check" class="form-check-input" style="width:auto; height:auto;"> Dividir com parceiro?</label></div>
                                    <div class="form-group" id="com-divisao-group" style="display: none;">
                                        <label class="form-label">Sua parte na divisão (%)</label>
                                        <input type="number" id="com-sua-parte" class="form-control" value="50">
                                    </div>
                                </form>
                                <div class="simulation-results-wrapper" id="comissao-resultado" style="display:none; padding: 20px;">
                                    <div class="simulation-results-header" style="font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px;"><i class="fas fa-file-invoice-dollar"></i>Resultado do Cálculo</div>
                                    <div class="simulation-result-card" style="padding:0; border: none; background: transparent;">
                                        <p><span><i class="fas fa-money-check-alt"></i> Comissão Bruta Total</span> <span class="total-value" id="com-res-total"></span></p>
                                        <div id="com-res-divisao-wrapper">
                                            <p><span><i class="fas fa-user-circle"></i> Sua Parte</span> <span id="com-res-sua-parte"></span></p>
                                            <p><span><i class="fas fa-users"></i> Parte do Parceiro</span> <span id="com-res-parceiro-parte"></span></p>
                                        </div>
                                    </div>
                                    <div class="modal-footer" style="background: transparent; padding-top: 20px; justify-content: center;">
                                        <button class="btn btn-success" id="launch-commission-btn"><i class="fas fa-coins"></i> Lançar no Financeiro</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="financeiro" data-role="admin-only">
                    <div class="page-header"><div class="page-title"><h1>Controle Financeiro</h1></div><div class="page-actions"><button class="btn btn-primary" id="novo-lancamento-btn"><i class="fas fa-plus"></i> Novo Lançamento</button></div></div>
                    <div class="content-wrapper">
                        <div class="form-row">
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4><i class="fas fa-arrow-up" style="color:var(--success-color)"></i> Entradas do Mês</h4><div class="dashboard-card-value" id="fin-entradas-mes"></div></div></div></div>
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4><i class="fas fa-arrow-down" style="color:var(--danger-color)"></i> Saídas do Mês</h4><div class="dashboard-card-value" id="fin-saidas-mes"></div></div></div></div>
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4><i class="fas fa-balance-scale"></i> Resultado do Mês</h4><div class="dashboard-card-value" id="fin-resultado-mes"></div></div></div></div>
                            <div class="form-col"><div class="card dashboard-card"><div class="card-body"><h4><i class="fas fa-wallet"></i> Saldo Total</h4><div class="dashboard-card-value" id="fin-saldo-total"></div></div></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-history"></i>Histórico de Lançamentos</h3></div>
                            <div class="card-body">
                                 <div class="table-filter-container" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                                    <input type="text" id="financeiro-filter-text" class="form-control" placeholder="Filtrar por descrição..." style="flex-grow: 2; min-width: 250px;">
                                    <select id="financeiro-filter-cliente" class="form-control" style="flex-grow: 1; min-width: 200px;"></select>
                                    <button id="financeiro-clear-filters" class="btn btn-secondary">Limpar</button>
                                </div>
                                <div class="table-responsive"><table class="table"><thead><tr id="financeiro-table-header"></tr></thead><tbody id="financeiro-table-body"></tbody></table></div>
                                <div class="pagination-container" id="financeiro-pagination"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="analises" data-role="admin-only">
                    <div class="page-header"><div class="page-title"><h1>Análises e Desempenho</h1></div></div>
                    <div class="content-wrapper">
                        <div class="form-row">
                            <div class="form-col"><div class="card"><div class="card-header"><h3>Ticket Médio de Venda</h3></div><div class="card-body"><h2 class="dashboard-card-value" id="metric-avg-ticket"></h2></div></div></div>
                            <div class="form-col"><div class="card"><div class="card-header"><h3>Taxa de Conversão (Venda)</h3></div><div class="card-body"><h2 class="dashboard-card-value" id="metric-conversion-rate"></h2></div></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-bullseye"></i>Metas Mensais</h3></div>
                            <div class="card-body" id="goals-container"></div>
                        </div>
                        <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
                            <div class="card"><div class="card-header"><h3>Comissão por Corretor</h3></div><div class="card-body" style="height: 300px;"><canvas id="brokerCommissionChart"></canvas></div></div>
                            <div class="card"><div class="card-header"><h3>Origem dos Clientes</h3></div><div class="card-body" style="height: 300px;"><canvas id="leadSourceChart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="relatorios" data-role="admin-only">
                    <div class="page-header"><div class="page-title"><h1>Relatórios</h1></div></div>
                    <div class="content-wrapper">
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-cogs"></i>Gerar Relatório</h3></div>
                            <div class="card-body">
                                <form id="report-form">
                                    <div class="form-row">
                                        <div class="form-col"><div class="form-group"><label class="form-label">Tipo de Relatório</label><select id="report-type" class="form-control" required><option value="">Selecione...</option><option value="vendas">Vendas</option><option value="locacao">Extrato de Locação</option><option value="imoveis">Imóveis</option><option value="clientes">Clientes</option><option value="financeiro">Financeiro</option><option value="comissoes">Comissões</option></select></div></div>
                                        <div class="form-col" id="report-imovel-select-container" style="display:none;"><div class="form-group"><label class="form-label">Imóvel</label><select id="report-imovel-select" class="form-control"></select></div></div>
                                        <div class="form-col"><div class="form-group"><label class="form-label">Data Início</label><input type="date" id="report-start-date" class="form-control"></div></div>
                                        <div class="form-col"><div class="form-group"><label class="form-label">Data Fim</label><input type="date" id="report-end-date" class="form-control"></div></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Gerar</button>
                                </form>
                            </div>
                        </div>
                        <div id="report-output" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 id="report-title"></h3>
                                    <button class="btn btn-success btn-sm" id="export-report-pdf"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                                </div>
                                <div class="card-body" id="report-printable-area">
                                    <div id="report-summary"></div>
                                    <div class="table-responsive" id="report-table-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
 
                <div class="tab-content" id="config" data-role="admin-only">
                     <div class="page-header"><div class="page-title"><h1>Configurações</h1></div></div>
                    <div class="content-wrapper">
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-building"></i>Configurações da Empresa</h3></div>
                            <div class="card-body">
                                <form id="config-form">
                                    <div class="form-row">
                                        <div class="form-col"><div class="form-group"><label class="form-label">Nome da Imobiliária</label><input type="text" class="form-control" name="companyName" placeholder="Ex: Imobiliária Nova Serrana"></div></div>
                                        <div class="form-col"><div class="form-group"><label class="form-label">CNPJ</label><input type="text" class="form-control" name="companyCnpj" placeholder="00.000.000/0001-00"></div></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Configurações</button>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-user-shield"></i>Segurança</h3></div>
                            <div class="card-body">
                                <form id="password-form">
                                    <div class="form-group">
                                        <label class="form-label">Alterar Senha de Administrador</label>
                                        <input type="password" class="form-control" name="newPassword" placeholder="Nova senha (mínimo 3 caracteres)" required minlength="3">
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-key"></i> Alterar Senha</button>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-bullseye"></i>Definição de Metas Mensais</h3></div>
                            <div class="card-body">
                                <form id="goals-form">
                                    <div class="form-row">
                                        <div class="form-col"><div class="form-group"><label class="form-label">Meta de Vendas (VGV em R$)</label><input type="text" class="form-control currency-input" name="salesGoal" placeholder="Ex: 1.500.000,00"></div></div>
                                        <div class="form-col"><div class="form-group"><label class="form-label">Meta de Contratos Fechados</label><input type="number" class="form-control" name="contractsGoal" placeholder="Ex: 10"></div></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Metas</button>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-file-alt"></i>Modelos de Contrato</h3></div>
                            <div class="card-body">
                                <form id="contract-template-form" novalidate>
                                    <input type="hidden" name="id">
                                    <div class="form-group">
                                        <label class="form-label">Modelos Salvos</label>
                                        <select id="select-contract-template" class="form-control">
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-col"><div<div class="form-col"><div class="form-group"><label class="form-label required">Nome do Modelo</label><input type="text" name="name" class="form-control" required placeholder="Ex: Contrato de Venda Padrão"></div></div>
                                        <div class="form-col"><div class="form-group"><label class="form-label required">Tipo de Modelo</label><select name="type" class="form-control" required></select></div></div>
                                    </div>
                                    <div class="form-group"><label class="form-label">Conteúdo do Modelo</label><textarea name="content" class="form-control" rows="10" placeholder="Cole seu contrato aqui e use as variáveis da lista abaixo..."></textarea></div>
                                    <p>Variáveis disponíveis:</p>
                                    <ul class="template-variable-list">
                                        <li>{{cliente.nome}}, {{cliente.cpf}}, {{cliente.rg}}, {{cliente.email}}, {{cliente.telefone}}, {{cliente.enderecoCompleto}}</li>
                                        <li>{{imovel.endereco}}, {{imovel.tipo}}, {{imovel.valor}}, {{imovel.proprietario}}, {{imovel.empreendimento}}, {{imovel.quadra}}, {{imovel.lote}}</li>
                                        <li>{{corretor.nome}}, {{corretor.creci}}, {{corretor.cpf}}</li>
                                        <li>{{contrato.numero}}, {{contrato.dataInicio}}, {{contrato.dataFinal}}, {{contrato.valorHonorarios}}</li>
                                        <li>{{proposta.valorSinal}}, {{proposta.valorParcelado}}, {{proposta.indiceCorrecao}}</li>
                                        <li>{{data.extenso}}, {{data.dia}}, {{data.mes}}, {{data.ano}}</li>
                                    </ul>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Modelo</button>
                                    <button type="button" class="btn btn-danger" id="delete-template-btn" style="display:none;"><i class="fas fa-trash"></i> Excluir Modelo</button>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-cogs"></i>Customização do Sistema</h3></div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-col">
                                        <h4>Categorias Financeiras</h4>
                                        <div id="finance-categories-list"></div>
                                        <div class="form-group" style="display: flex; gap: 10px; margin-top: 10px;">
                                            <input type="text" id="new-finance-category-input" class="form-control" placeholder="Nova Categoria">
                                            <button id="add-finance-category-btn" class="btn btn-success"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <h4>Estágios do Funil</h4>
                                        <div id="funnel-stages-list"></div>
                                         <div class="form-group" style="display: flex; gap: 10px; margin-top: 10px;">
                                            <input type="text" id="new-funnel-stage-input" class="form-control" placeholder="Novo Estágio">
                                            <button id="add-funnel-stage-btn" class="btn btn-success"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-database"></i>Backup e Importação</h3></div>
                            <div class="card-body">
                                <p>Faça o backup de todos os dados do sistema ou restaure a partir de um arquivo. É altamente recomendado fazer backups diários.</p>
                                <div class="form-group" style="margin-top: 20px;">
                                    <button class="btn btn-success" id="backup-btn"><i class="fas fa-download"></i> Fazer Backup</button>
                                    <label for="restore-input" class="btn btn-warning" style="margin-left: 10px; cursor: pointer;"><i class="fas fa-upload"></i> Restaurar Dados</label>
                                    <input type="file" id="restore-input" class="file-upload-input" accept=".json">
                                </div>
                                <hr style="margin: 20px 0;">
                                <p>Importe uma lista de clientes a partir de uma planilha Excel (.xlsx). Baixe o modelo formatado para garantir a importação correta.</p>
                                <div class="form-group" style="margin-top: 20px;">
                                    <button class="btn btn-info" id="download-template-btn"><i class="fas fa-file-excel"></i> Baixar Modelo</button>
                                    <label for="import-excel-input" class="btn btn-primary" style="margin-left: 10px; cursor: pointer;"><i class="fas fa-file-upload"></i> Importar Clientes</label>
                                    <input type="file" id="import-excel-input" class="file-upload-input" accept=".xlsx">
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-exclamation-triangle"></i>Zona de Perigo</h3></div>
                            <div class="card-body">
                                <p>Esta ação é irreversível e apagará todos os clientes, imóveis, contratos e outros dados do sistema.</p>
                                <button class="btn btn-danger" id="clear-data-btn"><i class="fas fa-biohazard"></i> Limpar Todos os Dados</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="public-property-view" style="display: none;"></div>

    <div class="modal" id="cliente-modal">
        <form id="cliente-form" class="modal-content" novalidate>
            <div class="modal-header"><h3 id="cliente-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="cliente-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" name="id">
                <fieldset>
                    <legend>Tipo de Cliente</legend>
                    <div class="form-group">
                        <label class="form-label">Tipo de Pessoa</label>
                        <select name="tipoPessoa" class="form-control" id="cliente-tipo-pessoa">
                            <option value="fisica">Pessoa Física</option>
                            <option value="juridica">Pessoa Jurídica</option>
                        </select>
                    </div>
                </fieldset>
                <fieldset id="dados-pessoa-fisica">
                    <legend>Dados Pessoais</legend>
                    <div class="form-row">
                        <div class="form-col" style="flex:2"><div class="form-group"><label class="form-label required">Nome Completo</label><input type="text" class="form-control" name="nome" required><div class="invalid-feedback">O nome é obrigatório.</div></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Data de Nascimento</label><input type="date" class="form-control" name="dataNascimento"></div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label required">CPF</label><input type="text" class="form-control" name="cpf" required placeholder="000.000.000-00"><div class="invalid-feedback">CPF inválido.</div></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">RG</label><input type="text" class="form-control" name="rg"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Órgão Expedidor</label><input type="text" class="form-control" name="orgaoExpedidor"></div></div>
                    </div>
                     <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Nome do Pai</label><input type="text" class="form-control" name="nomePai"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Nome da Mãe</label><input type="text" class="form-control" name="nomeMae"></div></div>
                    </div>
                </fieldset>
                <fieldset id="dados-pessoa-juridica" style="display:none;">
                    <legend>Dados da Empresa</legend>
                    <div class="form-row">
                        <div class="form-col" style="flex:2"><div class="form-group"><label class="form-label required">Razão Social</label><input type="text" class="form-control" name="razaoSocial" placeholder="Nome da Empresa LTDA"><div class="invalid-feedback">A Razão Social é obrigatória.</div></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label required">CNPJ</label><input type="text" class="form-control" name="cnpj" placeholder="00.000.000/0001-00"><div class="invalid-feedback">CNPJ inválido.</div></div></div>
                    </div>
                </fieldset>
                <fieldset><legend>Dados Gerais</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Estado Civil</label><select name="estadoCivil" class="form-control"><option value="">Selecione...</option><option>Solteiro(a)</option><option>Casado(a)</option><option>Divorciado(a)</option><option>Viúvo(a)</option><option>União Estável</option></select></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Profissão</label><input type="text" class="form-control" name="profissao"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Origem</label><select name="origem" class="form-control"><option value="">Selecione...</option><option value="Indicacao">Indicação</option><option value="Placa">Placa no Imóvel</option><option value="Redes Sociais">Redes Sociais</option><option value="Site">Site</option><option value="Outro">Outro</option></select></div></div>
                    </div>
                </fieldset>
                <fieldset><legend><i class="fas fa-search-location"></i> Perfil de Busca do Cliente</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Tipo de Imóvel de Interesse</label><select name="searchProfile_tipo" class="form-control"><option value="">Qualquer</option><option>Apartamento</option><option>Casa</option><option>Galpão</option><option>Kitnet</option><option>Quadra</option><option>Sala Comercial</option><option>Terreno</option></select></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Nº de Quartos (mínimo)</label><input type="number" name="searchProfile_quartos" class="form-control" value="0"></div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Faixa de Preço - Mínimo (R$)</label><input type="text" name="searchProfile_precoMin" class="form-control currency-input" placeholder="Ex: 100.000,00"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Faixa de Preço - Máximo (R$)</label><input type="text" name="searchProfile_precoMax" class="form-control currency-input" placeholder="Ex: 500.000,00"></div></div>
                    </div>
                </fieldset>
                <fieldset><legend>Endereço Principal</legend>
                    <div class="form-row">
                        <div class="form-col" style="flex: 0.5;"><div class="form-group"><label class="form-label">CEP</label><input type="text" class="form-control" name="cep" placeholder="00000-000"><i class="fas fa-spinner fa-spin spinner-icon" id="cep-spinner"></i></div></div>
                        <div class="form-col" style="flex: 2;"><div class="form-group"><label class="form-label">Rua</label><input type="text" class="form-control" name="rua"></div></div>
                        <div class="form-col" style="flex: 0.5;"><div class="form-group"><label class="form-label">Número</label><input type="text" class="form-control" name="numero"></div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Complemento</label><input type="text" class="form-control" name="complemento" placeholder="Ex: Apt 101, Casa 2"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Bairro</label><input type="text" class="form-control" name="bairro"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Cidade</label><input type="text" class="form-control" name="cidade"></div></div>
                        <div class="form-col" style="flex:0.5"><div class="form-group"><label class="form-label">Estado</label><input type="text" class="form-control" name="estado"></div></div>
                    </div>
                </fieldset>
                <fieldset><legend>Endereço Alternativo (Opcional)</legend>
                    <div class="form-group"><input type="text" class="form-control" name="endereco_alternativo" placeholder="Rua, Número, Bairro, Cidade..."></div>
                </fieldset>
                <fieldset><legend>Contato</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Telefone Principal</label><input type="text" class="form-control" name="telefone" placeholder="(00) 00000-0000"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label required">E-mail</label><input type="email" class="form-control" name="email" required><div class="invalid-feedback">Formato de e-mail inválido.</div></div></div>
                    </div>
                </fieldset>
                <fieldset><legend>Contatos Adicionais (Opcional)</legend>
                    <div class="form-row"><div class="form-col"><input type="text" class="form-control" name="contato_add_1_nome" placeholder="Nome (Contato 1)"></div><div class="form-col"><input type="text" class="form-control" name="contato_add_1_relacao" placeholder="Relação"></div><div class="form-col"><input type="text" class="form-control" name="contato_add_1_tel" placeholder="Telefone"></div></div>
                    <div class="form-row" style="margin-top:10px;"><div class="form-col"><input type="text" class="form-control" name="contato_add_2_nome" placeholder="Nome (Contato 2)"></div><div class="form-col"><input type="text" class="form-control" name="contato_add_2_relacao" placeholder="Relação"></div><div class="form-col"><input type="text" class="form-control" name="contato_add_2_tel" placeholder="Telefone"></div></div>
                    <div class="form-row" style="margin-top:10px;"><div class="form-col"><input type="text" class="form-control" name="contato_add_3_nome" placeholder="Nome (Contato 3)"></div><div class="form-col"><input type="text" class="form-control" name="contato_add_3_relacao" placeholder="Relação"></div><div class="form-col"><input type="text" class="form-control" name="contato_add_3_tel" placeholder="Telefone"></div></div>
                </fieldset>
                <fieldset><legend>Documentos e Status</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Doc. de Identidade</label><div class="file-attachment-group"><div id="cliente-docId-list"></div><label for="cliente-docId-input" class="btn btn-outline-primary btn-sm" style="width:100%"><i class="fas fa-upload"></i> Anexar / Alterar</label><input type="file" class="file-upload-input" id="cliente-docId-input"></div></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Comprovante de Renda</label><div class="file-attachment-group"><div id="cliente-docRenda-list"></div><label for="cliente-docRenda-input" class="btn btn-outline-primary btn-sm" style="width:100%"><i class="fas fa-upload"></i> Anexar / Alterar</label><input type="file" class="file-upload-input" id="cliente-docRenda-input"></div></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Comprov. de Endereço</label><div class="file-attachment-group"><div id="cliente-docEndereco-list"></div><label for="cliente-docEndereco-input" class="btn btn-outline-primary btn-sm" style="width:100%"><i class="fas fa-upload"></i> Anexar / Alterar</label><input type="file" class="file-upload-input" id="cliente-docEndereco-input"></div></div></div>
                    </div>
                    <div class="form-group"><label class="form-label">Status SPC</label><select class="form-control" name="spc"><option value="nao_verificado">Não Verificado</option><option value="limpo">Limpo</option><option value="restricao">Com Restrição</option></select><button type="button" class="btn btn-info btn-sm" id="consultar-spc-btn" style="width:100%; margin-top: 5px;"><i class="fas fa-search"></i> Consultar SPC (Simulação)</button></div>
                </fieldset>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary" id="save-cliente-btn"><i class="fas fa-save"></i> Salvar Cliente</button><button type="button" class="btn btn-secondary close-button" data-modal="cliente-modal">Cancelar</button></div>
        </form>
    </div>
    <div class="modal" id="dossie-cliente-modal">
        <div class="modal-content" style="width: 1100px;">
            <div class="modal-header"><h3 id="dossie-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="dossie-cliente-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="dossie-modal-body"></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary close-button" data-modal="dossie-cliente-modal">Fechar</button></div>
        </div>
    </div>
    <div class="modal" id="favorites-modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-star"></i> Imóveis Favoritos (Shortlist)</h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="favorites-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="favorites-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-success" id="generate-favorites-pdf"><i class="fas fa-file-pdf"></i> Gerar PDF para Cliente</button>
                <button type="button" class="btn btn-secondary close-button" data-modal="favorites-modal">Fechar</button>
            </div>
        </div>
    </div>
    <div class="modal" id="imovel-modal">
        <form id="imovel-form" class="modal-content" novalidate>
            <div class="modal-header"><h3 id="imovel-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="imovel-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" name="id">
                <fieldset><legend>Localização e Valores</legend>
                    <div class="form-group"><label class="form-label required">Endereço Completo</label><input type="text" class="form-control" name="endereco" required></div>
                    <div class="form-group"><label class="form-label">Nome do Proprietário</label><input type="text" class="form-control" name="proprietario" placeholder="Nome completo do dono do imóvel"></div>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label required">Valor (R$)</label><input type="text" class="form-control currency-input" name="valor" required></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label required">Tipo</label><select class="form-control" name="tipo" required><option value="">Selecione...</option><option>Apartamento</option><option>Casa</option><option>Galpão</option><option>Kitnet</option><option>Quadra</option><option>Sala Comercial</option><option>Terreno</option></select></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Status</label><select class="form-control" name="status"><option value="Disponível">Disponível</option><option value="Vendido">Vendido</option><option value="Alugado">Alugado</option></select></div></div>
                    </div>
                     <div class="form-group"><label class="form-label required">Corretor Responsável</label><select class="form-control" name="corretorResponsavelId" required></select><div class="invalid-feedback">É necessário vincular um corretor.</div></div>
                </fieldset>
                <fieldset><legend>Dados do Loteamento/Empreendimento (se aplicável)</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Empreendimento</label><input type="text" class="form-control" name="empreendimento"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Quadra</label><input type="text" class="form-control" name="quadra"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Lote</label><input type="text" class="form-control" name="lote"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Área (m²)</label><input type="number" step="0.01" class="form-control" name="area" value="0"></div></div>
                    </div>
                </fieldset>
                <fieldset><legend>Características</legend>
                    <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Quartos</label><input type="number" class="form-control" name="quartos" value="0"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Banheiros</label><input type="number" class="form-control" name="banheiros" value="0"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Suítes</label><input type="number" class="form-control" name="suites" value="0"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Vagas Garagem</label><input type="number" class="form-control" name="vagas" value="0"></div></div></div>
                    <div class="form-group"><label class="form-label">Descrição</label><textarea class="form-control" name="descricao" rows="3"></textarea></div>
                </fieldset>
                <fieldset><legend>Mídia</legend>
                    <div class="form-group"><label class="form-label">Fotos do Imóvel (mínimo 1)</label><label for="imovel-fotos-input" class="btn btn-outline-primary" style="width:100%"><i class="fas fa-camera"></i> Adicionar Fotos</label><input type="file" class="file-upload-input" id="imovel-fotos-input" multiple accept="image/*"><div id="imovel-fotos-preview" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div></div>
                </fieldset>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary" id="save-imovel-btn"><i class="fas fa-save"></i> Salvar Imóvel</button><button type="button" class="btn btn-secondary close-button" data-modal="imovel-modal">Cancelar</button></div>
        </form>
    </div>
    <div class="modal" id="imovel-details-modal">
        <div class="modal-content" style="width: 1100px;">
            <div class="modal-header"><h3 id="imovel-details-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="imovel-details-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="imovel-details-body"></div>
            <div class="modal-footer" id="imovel-details-footer"></div>
        </div>
    </div>
    <div class="modal" id="corretor-modal">
        <form id="corretor-form" class="modal-content" novalidate>
            <div class="modal-header"><h3 id="corretor-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="corretor-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" name="id">
                <fieldset>
                    <legend>Dados Principais</legend>
                    <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label required">Nome</label><input type="text" class="form-control" name="nome" required><div class="invalid-feedback">O nome é obrigatório.</div></div></div><div class="form-col"><div class="form-group"><label class="form-label required">CRECI</label><input type="text" class="form-control" name="creci" required><div class="invalid-feedback">O CRECI é obrigatório.</div></div></div></div>
                    <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">CPF</label><input type="text" class="form-control" name="cpf" placeholder="000.000.000-00"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Telefone (com DDD)</label><input type="text" class="form-control" name="telefone" placeholder="(00) 00000-0000"></div></div><div class="form-col"><div class="form-group"><label class="form-label required">E-mail</label><input type="email" class="form-control" name="email" required><div class="invalid-feedback">Formato de e-mail inválido.</div></div></div></div>
                </fieldset>
                <fieldset>
                    <legend>Documentos</legend>
                    <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Doc. de Identidade</label><div class="file-attachment-group"><div id="corretor-docId-list"></div><label for="corretor-docId-input" class="btn btn-outline-primary btn-sm" style="width:100%"><i class="fas fa-upload"></i> Anexar / Alterar</label><input type="file" class="file-upload-input" id="corretor-docId-input"></div></div></div><div class="form-col"><div class="form-group"><label class="form-label">Carteira do CRECI</label><div class="file-attachment-group"><div id="corretor-docCreci-list"></div><label for="corretor-docCreci-input" class="btn btn-outline-primary btn-sm" style="width:100%"><i class="fas fa-upload"></i> Anexar / Alterar</label><input type="file" class="file-upload-input" id="corretor-docCreci-input"></div></div></div><div class="form-col"><div class="form-group"><label class="form-label">Contrato de Honorários</label><div class="file-attachment-group"><div id="corretor-docContrato-list"></div><label for="corretor-docContrato-input" class="btn btn-outline-primary btn-sm" style="width:100%"><i class="fas fa-upload"></i> Anexar / Alterar</label><input type="file" class="file-upload-input" id="corretor-docContrato-input"></div></div></div></div>
                </fieldset>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary" id="save-corretor-btn"><i class="fas fa-save"></i> Salvar Corretor</button><button type="button" class="btn btn-secondary close-button" data-modal="corretor-modal">Cancelar</button></div>
        </form>
    </div>
    <div class="modal" id="contrato-modal">
        <form id="contrato-form" class="modal-content" novalidate>
            <div class="modal-header"><h3 id="contrato-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="contrato-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" name="id">
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label class="form-label required">Número</label><input type="text" class="form-control" name="numero" required></div></div>
                    <div class="form-col"><div class="form-group"><label class="form-label required">Tipo</label><select class="form-control" name="tipo" required id="contrato-tipo-select"></select></div></div>
                    <div class="form-col"><div class="form-group"><label class="form-label">Status</label><select class="form-control" name="status"><option>Ativo</option><option>Encerrado</option><option>Pendente</option></select></div></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label class="form-label required">Data Início</label><input type="date" class="form-control" name="dataInicio" required></div></div>
                    <div class="form-col"><div class="form-group"><label class="form-label required">Data Final</label><input type="date" class="form-control" name="dataFinal" required></div></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label class="form-label required">Cliente</label><select class="form-control" name="clienteId" required></select></div></div>
                    <div class="form-col"><div class="form-group"><label class="form-label required">Imóvel</label><select class="form-control" name="imovelId" required></select></div></div>
                    <div class="form-col"><div class="form-group"><label class="form-label">Corretor</label><select class="form-control" name="corretorId"></select></div></div>
                </div>
                <fieldset id="locacao-fields" style="display:none;"><legend>Dados da Locação</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label required">Valor do Aluguel (R$)</label><input type="text" class="form-control currency-input" name="valorAluguel"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label required">Taxa de Admin. (%)</label><input type="number" step="0.1" class="form-control" name="taxaAdm" placeholder="Ex: 8.0"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label required">Dia do Vencimento</label><input type="number" min="1" max="31" class="form-control" name="diaVencimento" placeholder="Ex: 10"></div></div>
                    </div>
                </fieldset>
                <fieldset id="corretagem-fields" style="display:none;"><legend>Dados de Corretagem/Honorários</legend>
                    <div class="form-group"><label class="form-label required">Valor dos Honorários (R$)</label><input type="text" class="form-control currency-input" name="valorHonorarios"></div>
                </fieldset>
                <fieldset id="proposta-fields" style="display:none;"><legend>Dados da Proposta de Compra</legend>
                    <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Valor do Sinal/Entrada (R$)</label><input type="text" class="form-control currency-input" name="proposta_valorSinal"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Data Pagamento Sinal</label><input type="date" class="form-control" name="proposta_dataPagamentoSinal"></div></div>
                    </div>
                     <div class="form-row">
                        <div class="form-col"><div class="form-group"><label class="form-label">Valor a ser Parcelado (R$)</label><input type="text" class="form-control currency-input" name="proposta_valorParcelado"></div></div>
                        <div class="form-col"><div class="form-group"><label class="form-label">Índice de Correção</label><input type="text" class="form-control" name="proposta_indiceCorrecao" placeholder="Ex: IPCA"></div></div>
                    </div>
                </fieldset>
                <hr/>
                <div class="form-group">
                    <label class="form-label">Usar Modelo de Contrato</label>
                    <select id="contrato-template-select" class="form-control"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="generate-contract-from-template-btn" disabled><i class="fas fa-eye"></i> Visualizar & Gerar</button>
                <button type="submit" class="btn btn-primary" id="save-contrato-btn"><i class="fas fa-save"></i> Salvar Contrato</button>
                <button type="button" class="btn btn-secondary close-button" data-modal="contrato-modal">Cancelar</button>
            </div>
        </form>
    </div>
    <div class="modal" id="financeiro-modal"> <form id="financeiro-form" class="modal-content" style="width: 700px;" novalidate> <div class="modal-header"><h3 id="financeiro-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="financeiro-modal"><i class="fas fa-times"></i></button></div> <div class="modal-body"><input type="hidden" name="id"><div class="form-group"><label class="form-label required">Descrição</label><input type="text" class="form-control" name="descricao" required></div><div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label required">Valor (R$)</label><input type="text" class="form-control currency-input" name="valor" required></div></div><div class="form-col"><div class="form-group"><label class="form-label required">Data</label><input type="date" class="form-control" name="data" required></div></div></div><div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label required">Tipo</label><select class="form-control" name="tipo" required><option value="entrada">Entrada</option><option value="saida">Saída</option></select></div></div><div class="form-col"><div class="form-group"><label class="form-label">Categoria</label><select class="form-control" name="categoria" id="financeiro-category-select"></select></div></div></div><div class="form-group"><label class="form-label">Cliente Associado (Opcional)</label><select class="form-control" name="clienteId" id="financeiro-cliente-select"></select></div></div> <div class="modal-footer"><button type="submit" class="btn btn-primary" id="save-financeiro-btn"><i class="fas fa-save"></i> Salvar Lançamento</button><button type="button" class="btn btn-secondary close-button" data-modal="financeiro-modal">Cancelar</button></div> </form> </div>
    <div class="modal" id="view-contrato-modal"><div class="modal-content" style="width: 90%; max-width: 8.5in;"><div class="modal-header"><h3>Visualizar e Gerar Contrato</h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="view-contrato-modal"><i class="fas fa-times"></i></button></div><div class="modal-body" id="contrato-viewer-body"></div><div class="modal-footer"><button class="btn btn-success" id="download-contrato-pdf-btn"><i class="fas fa-file-pdf"></i> Baixar PDF</button><button type="button" class="btn btn-secondary close-button" data-modal="view-contrato-modal">Fechar</button></div></div></div>
    <div class="modal" id="event-modal"> <form id="event-form" class="modal-content" style="width: 500px;"> <div class="modal-header"><h3 id="event-modal-title"></h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="event-modal"><i class="fas fa-times"></i></button></div> <div class="modal-body"><input type="hidden" id="event-id"><input type="hidden" id="event-date"><div class="form-group"><label class="form-label required">Título</label><input type="text" id="event-title" class="form-control" required></div><div class="form-group"><label class="form-label">Horário</label><input type="time" id="event-time" class="form-control"></div><div class="form-group"><label class="form-label">Descrição</label><textarea id="event-description" class="form-control" rows="3"></textarea></div><div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Vincular Cliente (Opcional)</label><select id="event-clienteId" class="form-control"></select></div></div><div class="form-col"><div class="form-group"><label class="form-label">Vincular Imóvel (Opcional)</label><select id="event-imovelId" class="form-control"></select></div></div></div></div> <div class="modal-footer"><button type="submit" class="btn btn-primary" id="save-event-btn"><i class="fas fa-save"></i> Salvar Evento</button><button type="button" class="btn btn-danger" id="delete-event-btn" style="display: none;">Excluir</button><button type="button" class="btn btn-secondary close-button" data-modal="event-modal">Cancelar</button></div> </form> </div>
    <div class="modal" id="ajuda-modal"> <div class="modal-content"> <div class="modal-header"><h3><i class="fas fa-life-ring"></i> Guia de Funções e Atalhos</h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="ajuda-modal"><i class="fas fa-times"></i></button></div> <div class="modal-body" style="font-size: 0.95rem;"> <div class="help-section"><h4><i class="fas fa-star"></i>Novidades Principais</h4><ul><li><strong>Automação de Locação:</strong> Gere lançamentos financeiros mensais de aluguéis, taxas e repasses com um único clique na tela Financeiro.</li><li><strong>Jornada Pós-Venda:</strong> Ao fechar um negócio, o sistema agora cria tarefas automáticas de acompanhamento para fidelizar seu cliente e gerar novos negócios.</li><li><strong>Matching Inteligente:</strong> O sistema agora sugere imóveis para clientes (e vice-versa) automaticamente!</li><li><strong>Modelos de Contrato:</strong> Crie templates de contrato em 'Configurações' para preencher novos documentos automaticamente.</li></ul></div> <hr style="margin: 20px 0; border-color: var(--border-color);"> <div class="help-section"><h4><i class="fas fa-check-circle"></i>Correções e Melhorias</h4><p>O Dashboard está mais inteligente, com alertas de aluguéis em atraso. A geração de relatórios agora inclui um extrato detalhado para proprietários.</p></div> </div> <div class="modal-footer"><button type="button" class="btn btn-secondary close-button" data-modal="ajuda-modal">Entendi!</button></div> </div> </div>
    <div class="modal" id="whats-new-modal"> <div class="modal-content" style="width: 600px;"> <div class="modal-header"><h3><i class="fas fa-rocket" style="color:var(--primary-color)"></i> Bem-vindo à Versão 19.5!</h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="whats-new-modal"><i class="fas fa-times"></i></button></div> <div class="modal-body" style="font-size: 1rem;"> <p>Seu sistema recebeu um grande upgrade!</p> <ul style="list-style: none; padding-left: 0; margin-top: 20px;"> <li style="margin-bottom: 15px;"><strong><i class="fas fa-calculator text-info"></i> MELHORADO: Simulador de Lotes!</strong> Adicionado campo de corretagem e formatação de moeda para facilitar o uso.</li> <li style="margin-bottom: 15px;"><strong><i class="fas fa-file-signature text-success"></i> NOVO: Modelos de Contrato!</strong> Agora o sistema inclui modelos prontos para Corretagem e Proposta de Compra.</li> <li style="margin-bottom: 15px;"><strong><i class="fas fa-link text-primary"></i> NOVO: Integração Total!</strong> Agende visitas vinculadas a imóveis e clientes e salve simulações diretamente no dossiê.</li><li style="margin-bottom: 15px;"><strong><i class="fas fa-cogs text-secondary"></i> NOVO: Customização!</strong> Personalize categorias financeiras e os estágios do seu funil nas Configurações.</li></ul> </div> <div class="modal-footer"><button type="button" class="btn btn-primary close-button" data-modal="whats-new-modal">Começar a Usar</button></div> </div> </div>
    <div class="modal" id="spc-result-modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header"><h3><i class="fas fa-search-dollar"></i> Resultado da Consulta SPC (Simulação)</h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="spc-result-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="spc-result-body"></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary close-button" data-modal="spc-result-modal">Fechar</button></div>
        </div>
    </div>
     <div class="modal" id="recibo-preview-modal">
        <div class="modal-content" style="width: 90%; max-width: 8.5in;">
            <div class="modal-header"><h3>Pré-visualização do Recibo</h3><button type="button" class="close-button btn btn-sm btn-danger" data-modal="recibo-preview-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="recibo-preview-body"></div>
            <div class="modal-footer">
                <button class="btn btn-success" id="download-recibo-pdf-btn"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                <button type="button" class="btn btn-secondary close-button" data-modal="recibo-preview-modal">Fechar</button>
            </div>
        </div>
    </div>
  <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- INÍCIO DA VERIFICAÇÃO DE SEGURANÇA ---
            const checkAuthentication = () => {
                const token = sessionStorage.getItem('sessionToken');
                // Se não houver token, o acesso é negado e o usuário volta ao login.
                if (!token || !token.startsWith('imob_auth_token_')) {
                    // Limpa qualquer dado residual para garantir segurança.
                    sessionStorage.clear(); 
                    alert('Acesso negado. Por favor, faça o login primeiro.');
                    window.location.href = 'login.html';
                } else {
                    // Se o token existir, torna a página visível para evitar o "flash" de conteúdo.
                    document.body.style.visibility = 'visible';
                }
            };
            
            // Executa a verificação imediatamente.
            checkAuthentication();
            // --- FIM DA VERIFICAÇÃO DE SEGURANÇA ---

            let db = {}; 
            let charts = {};
            let currentDate = new Date();
            let imovelFavoritos = [];
            const appContainer = document.querySelector('.app-container');
            const appVersion = "19.5";
            let currentUserRole = 'admin';

            const ITEMS_PER_PAGE = 10;
            let pageState = {
                clientes: { currentPage: 1, sortKey: 'nome', sortOrder: 'asc' },
                imoveis: { currentPage: 1, sortKey: 'endereco', sortOrder: 'asc' },
                corretores: { currentPage: 1, sortKey: 'nome', sortOrder: 'asc' },
                contratos: { currentPage: 1, sortKey: 'dataInicio', sortOrder: 'desc' },
                financeiro: { currentPage: 1, sortKey: 'data', sortOrder: 'desc' }
            };

            const loadDb = () => {
                const initialDb = {
                    config: { 
                        companyName: 'Imobiliária Nova Serrana', 
                        companyCnpj: '00.000.000/0001-00',
                        salesGoal: 1000000,
                        contractsGoal: 10,
                        passwordHash: null,
                        financeCategories: [ 'Comissão de Venda', 'Taxa de Administração', 'Repasse ao Proprietário', 'Recebimento de Aluguel', 'Marketing', 'Despesas Fixas', 'Outros' ],
                        funnelStages: { lead: 'Lead', contacted: 'Contato Feito', visiting: 'Visitando', proposal: 'Proposta', won: 'Ganho', lost: 'Perdido' },
                        contractTypes: {
                            'Proposta': 'Proposta de Compra',
                            'Corretagem': 'Serviço de Corretagem',
                            'Locacao': 'Locação',
                            'Venda': 'Venda',
                            'Outro': 'Outro'
                        }
                    },
                    clientes: [], imoveis: [], corretores: [], contratos: [], financeiro: [],
                    events: [], activities: [], notifications: 0, lastBackup: null,
                    contractTemplates: [],
                    simulations: []
                };

                const defaultTemplates = [
                    {
                        id: 'template_proposta_padrao',
                        name: 'Proposta de Compra Padrão (NOVO MODELO)',
                        type: 'Proposta',
                        content: `` // O conteúdo será injetado abaixo
                    },
                    {
                        id: 'template_corretagem_padrao',
                        name: 'Contrato de Corretagem Padrão',
                        type: 'Corretagem',
                        content: `<h3>CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE CORRETAGEM</h3>
<p>As partes pactuam com base nos artigos 722 a 729 do Novo Código Civil na forma abaixo transcrita, mediantes as seguintes cláusulas e condições.</p>
<hr>
<p><strong>I.CONTRATANTE/CLIENTE:</strong> {{cliente.nome}}, brasileiro, estado civil {{cliente.estadoCivil}}, profissão: {{cliente.profissao}}, CPF: {{cliente.cpf}}, RG Nº: {{cliente.rg}}, domiciliado na Rua {{cliente.rua}}, nº {{cliente.numero}}, bairro {{cliente.bairro}}, cidade {{cliente.cidade}}, estado: {{cliente.estado}}, CEP: {{cliente.cep}}. TELEFONES: {{cliente.telefone}}.</p>
<p><strong>II. CONTRATADA/CORRETORA:</strong> {{corretor.nome}}, CNPJ/CPF: {{corretor.cpf}}, com sede na Rua: Presidente Castelo Branco, nº 435, Complemento: Loja, B: Marisa, Cidade: Nova Serrana, Estado: Minas Gerais CEP: 35.521-316, Telefone: 37 9 9121 6045 ou 37 3226 3161.</p>
<hr>
<h4>CLÁUSULA PRIMEIRA: OBJETO DO CONTRATO</h4>
<p>O presente instrumento tem por finalidade a prestação de serviços pela CORRETORA ao CLIENTE, por intermédio de seu consultor imobiliário devidamente credenciado, de intermediação na compra e venda da unidade: Quadra {{imovel.quadra}}, Lote {{imovel.lote}} do Empreendimento {{imovel.empreendimento}}, situado na cidade de Nova Serrana-MG, da empresa {{imovel.proprietario}}.</p>
<h4>CLÁUSULA SEGUNDA – DA REMUNERAÇÃO</h4>
<p>O CLIENTE pagará para a CORRETORA pela prestação do serviço ora contratado, o valor total de {{contrato.valorHonorarios}}.</p>
<p><strong>Parágrafo Primeiro:</strong> O CLIENTE declara estar ciente de que a remuneração prevista no caput desta Cláusula é devida e exigível integralmente uma vez que tenha sido assinado o contrato de promessa de compra e venda de imóvel, ainda que, posteriormente, haja arrependimento das partes ou mesmo a sua rescisão, nos termos do artigo 725 do Código Civil.</p>
<h4>CLÁUSULA TERCEIRA - As partes elegem o foro da Comarca de Nova Serrana-MG, para dirimir qualquer dúvida relacionada a este instrumento, renunciando a qualquer outro, por mais privilegiado que seja.</h4>
<p>E por estarem, assim justas e contratadas, as partes assinam o presente contrato em 02(duas) vias de igual teor e forma.</p>
<br><br>
<p>Nova Serrana, {{data.extenso}}.</p>
<br><br>
<p><strong>CLIENTE:</strong> _________________________________</p>
<p><strong>CORRETORA (O):</strong> ___________________________</p>`
                    }
                ];

                // NOVO MODELO DE PROPOSTA DE COMPRA - INJETADO DIRETAMENTE
                defaultTemplates[0].content = `
<div style="font-family: Arial, sans-serif; font-size: 10pt; color: black;">
    <table style="width: 100%; border-collapse: collapse;">
        <tbody>
            <tr>
                <td style="width: 65%; vertical-align: top;">
                    <p style="font-weight: bold;">Promitente vendedor:</p>
                    <table style="width: 100%; font-size: 9pt;">
                        <tr>
                            <td style="width: 25px; padding: 5px 0;"><div style="width: 18px; height: 18px; border: 1px solid black;"></div></td>
                            <td>MARR EMPREENDIMENTOS E PARTICIPAÇÕES LTDA</td>
                        </tr>
                        <tr>
                            <td style="width: 25px; padding: 5px 0;"><div style="width: 18px; height: 18px; border: 1px solid black;"></div></td>
                            <td>MONTE VERDE INCORPORAÇÃO E EMP. SPE LTDA</td>
                        </tr>
                        <tr>
                            <td style="width: 25px; padding: 5px 0;"><div style="width: 18px; height: 18px; border: 1px solid black;"></div></td>
                            <td>RESIDENCIAL PARQUE DAS ÁGUAS ADM SPE LTDA</td>
                        </tr>
                    </table>
                </td>
                <td style="width: 35%; text-align: right; vertical-align: top;">
                    <h1 style="font-size: 18pt; margin: 0; font-weight: bold;">PROPOSTA DE COMPRA</h1>
                    <p style="margin-top: 10px;">Recebido em: ______/______/______</p>
                </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td colspan="2" style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">I - DAS PARTES</td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; width: 65%;">
                    <label style="font-size: 9pt;">Promissário(a) Comprador(a):</label>
                    <div style="font-weight: bold; min-height: 20px;">{{cliente.nome}}</div>
                </td>
                <td style="border: 1px solid black; padding: 4px; width: 35%;">
                    <label style="font-size: 9pt;">CPF/CNPJ:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{cliente.cpf}}</div>
                </td>
            </tr>
        </tbody>
    </table>
    
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td colspan="4" style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">II - DO IMÓVEL</td>
            </tr>
            <tr>
                <td colspan="4" style="border: 1px solid black; padding: 4px;">
                    <label style="font-size: 9pt;">EMPREENDIMENTO:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{imovel.empreendimento}}</div>
                </td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; width: 25%;">
                    <label style="font-size: 9pt;">QUADRA:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{imovel.quadra}}</div>
                </td>
                <td style="border: 1px solid black; padding: 4px; width: 25%;">
                    <label style="font-size: 9pt;">LOTE:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{imovel.lote}}</div>
                </td>
                <td style="border: 1px solid black; padding: 4px; width: 25%;">
                    <label style="font-size: 9pt;">SALA:</label>
                    <div style="font-weight: bold; min-height: 20px;">&nbsp;</div>
                </td>
                <td style="border: 1px solid black; padding: 4px; width: 25%;">
                    <label style="font-size: 9pt;">ÁREA (m2):</label>
                    <div style="font-weight: bold; min-height: 20px;">{{imovel.area}}</div>
                </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td colspan="2" style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">III - DO PREÇO</td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; width: 50%;">
                    <label style="font-size: 9pt;">VALOR TOTAL DO IMÓVEL (A+B):</label>
                    <div style="font-weight: bold; min-height: 20px;">{{imovel.valor}}</div>
                </td>
                <td style="border: 1px solid black; padding: 4px; width: 50%;">
                    <label style="font-size: 9pt;">VALOR TOTAL DO IMÓVEL À VISTA:</label>
                    <div style="font-weight: bold; min-height: 20px;">&nbsp;</div>
                </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td colspan="3" style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">IV - FORMA E DATAS DE PAGAMENTOS</td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; width: 65%;">
                    <label style="font-size: 9pt;">A) SINAL/ENTRADA - PRINCÍPIO DE PAGAMENTO:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{proposta.valorSinal}}</div>
                </td>
                <td colspan="2" style="border: 1px solid black; padding: 4px; width: 35%;">
                    <label style="font-size: 9pt;">DATA PAGAMENTO (SINAL/ENTRADA)</label>
                    <div style="font-weight: bold; min-height: 20px; text-align: center;">{{proposta.dataPagamentoSinal}}</div>
                </td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px;">
                    <label style="font-size: 9pt;">B) VALOR A SER PARCELADO:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{proposta.valorParcelado}}</div>
                </td>
                <td style="border: 1px solid black; padding: 4px; text-align: center;">
                    <label style="font-size: 9pt;">TIPO PARCELAMENTO:</label>
                </td>
                <td style="border: 1px solid black; padding: 4px;">
                    <div style="display: inline-block; vertical-align: middle; margin-right: 10px;">
                        <div style="width: 15px; height: 15px; border: 1px solid black; display: inline-block;"></div>
                        <span style="font-size: 9pt;">PARCELAS FIXAS</span>
                    </div>
                    <div style="display: inline-block; vertical-align: middle;">
                        <div style="width: 15px; height: 15px; border: 1px solid black; display: inline-block;"></div>
                        <span style="font-size: 9pt;">PARCELAS COM CORREÇÃO</span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 1px;">
        <thead>
            <tr style="font-size: 9pt; text-align: center; font-weight: bold;">
                <td style="border: 1px solid black; padding: 4px; width: 12%;">TIPO DE PARCELAS</td>
                <td style="border: 1px solid black; padding: 4px; width: 12%;">QUANTIDADE DE PARCELAS</td>
                <td style="border: 1px solid black; padding: 4px; width: 15%;">VALOR INICIAL DA PARCELAS</td>
                <td style="border: 1px solid black; padding: 4px; width: 18%;">SOMA TOTAL POR TIPO DE PARCELA</td>
                <td style="border: 1px solid black; padding: 4px;">
                    VENCIMENTO DA PRIMEIRA PARCELA<br>
                    <span style="font-weight: normal;">(AS DEMAIS PARCELAS SERÃO SUCESSIVAS NO MESMO DIA DOS MESES SUBSEQUENTES)</span>
                </td>
                <td style="border: 1px solid black; padding: 4px; width: 15%;">
                    Já é cliente?<br>
                    <div style="width: 15px; height: 15px; border: 1px solid black; display: inline-block;"></div> Sim
                    <div style="width: 15px; height: 15px; border: 1px solid black; display: inline-block;"></div> Não
                    <br>Código:_______
                </td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="border: 1px solid black; padding: 4px; height: 40px; text-align: center; font-weight: bold;">MENSAL</td>
                <td style="border: 1px solid black; padding: 4px;"></td>
                <td style="border: 1px solid black; padding: 4px;"></td>
                <td style="border: 1px solid black; padding: 4px;"></td>
                <td style="border: 1px solid black; padding: 4px; text-align: center; vertical-align: bottom;">____/____/____</td>
                <td style="border: 1px solid black; padding: 4px;"></td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; height: 40px; text-align: center; font-weight: bold;">ANUAL</td>
                <td style="border: 1px solid black; padding: 4px;"></td>
                <td style="border: 1px solid black; padding: 4px;"></td>
                <td style="border: 1px solid black; padding: 4px;"></td>
                <td style="border: 1px solid black; padding: 4px; text-align: center; vertical-align: bottom;">____/____/____</td>
                <td style="border: 1px solid black; padding: 4px;"></td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">V - DECLARAÇÕES DO(A) CONTRATANTE SOBRE A PRESENTE PROPOSTA DE COMPRA</td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; font-size: 8pt; text-align: justify;">
                    Declaro que estou ciente que o contrato de promessa de compra e venda somente será confeccionado após cumprida a análise de crédito e demais formalidades, inclusive documentais, e que a <strong>PROMITENTE</strong> tem a faculdade de recusar a presente proposta de forma imotiva. Declaro que estou ciente e comparecerei em local e horário indicado pela <strong>PROMITENTE</strong> para o fim de assinar o contrato e seus anexos. Declaro também que em caso de recusa dessa proposta, ou minha ausência para assinatura do contrato, o presente documento perderá eficácia jurídica, ficando o imóvel totalmente liberado para comercialização, e o sinal/entrada de pagamento será devolvido na integralidade caso já tenha sido efetivada.
                </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">VI - CORREÇÃO</td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px;">
                    <label style="font-size: 9pt;">SOMENTE PARA A OPÇÃO DE PARCELAMENTO COM CORREÇÃO DE VALORES, O ÍNDICE ADOTADO É:</label>
                    <div style="font-weight: bold; min-height: 20px;">{{proposta.indiceCorrecao}}</div>
                </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">VII - SERVIÇOS DE INTERMEDIAÇÃO IMOBILIÁRIA/CORRETAGEM</td>
            </tr>
            <tr>
                <td style="border: 1px solid black; padding: 4px; font-size: 9pt;">
                    Honorários de corretagem não estão inclusos no valor do contrato. <strong>IMOBILIÁRIA</strong> e <strong>CORRETOR</strong> serão de livre escolha do(a) <strong>PROMISSÁRIO(A) COMPRADOR(A)</strong>.
                </td>
            </tr>
        </tbody>
    </table>

    <p style="text-align: center; margin-top: 20px;">Nova Serrana-MG, {{data.dia}} de {{data.mes}} de {{data.ano}}.</p>

    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <tbody>
            <tr>
                <td style="width: 50%; padding-right: 10px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background-color: #e0e0e0;"><td colspan="2" style="border: 1px solid black; padding: 4px; text-align: center; font-weight: bold;">CONFERÊNCIAS:</td></tr>
                        <tr>
                            <td style="border: 1px solid black; padding: 4px; height: 40px; width: 50%;"><label style="font-size: 9pt;">Comercial:</label></td>
                            <td style="border: 1px solid black; padding: 4px; width: 50%;"><label style="font-size: 9pt;">Financeiro:</label></td>
                        </tr>
                    </table>
                </td>
                <td style="width: 50%; padding-left: 10px; vertical-align: top;">
                    <div style="border-bottom: 1px solid black; min-height: 40px; text-align: center; padding-top: 20px;"></div>
                    <p style="text-align: center; font-size: 9pt; margin-top: 5px;">Assinatura do(a) Promissário(a) Comprador(a)</p>
                </td>
            </tr>
            <tr>
                 <td colspan="2" style="padding-top: 10px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background-color: #e0e0e0;"><td style="border: 1px solid black; padding: 4px; text-align: center; font-weight: bold;">INTERMEDIADOR DE VENDA TERCEIRIZADO:</td></tr>
                        <tr><td style="border: 1px solid black; height: 40px; padding: 4px; font-weight: bold;">{{corretor.nome}}</td></tr>
                    </table>
                 </td>
            </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tbody>
            <tr style="background-color: #e0e0e0;">
                <td style="border: 1px solid black; padding: 4px; font-weight: bold; text-align: center;">
                    Esta PROPOSTA DE COMPRA está sujeito à conferência podendo ser recusada de forma imotivada, pela PROMITENTE.
                </td>
            </tr>
        </tbody>
    </table>
</div>
`;
                
                db = {};
                for (const key in initialDb) {
                    const storedValue = localStorage.getItem(`db_${key}`);
                    if (storedValue) {
                        try {
                           db[key] = JSON.parse(storedValue);
                        } catch(e) {
                           db[key] = initialDb[key];
                        }
                    } else {
                        db[key] = initialDb[key];
                    }
                }
                
                if (!db.config.financeCategories) db.config.financeCategories = initialDb.config.financeCategories;
                if (!db.config.funnelStages) db.config.funnelStages = initialDb.config.funnelStages;
                if (!db.config.contractTypes) db.config.contractTypes = initialDb.config.contractTypes;
                
                const hasDefaultProposta = db.contractTemplates.some(t => t.id === 'template_proposta_padrao');
                const hasDefaultCorretagem = db.contractTemplates.some(t => t.id === 'template_corretagem_padrao');

                if (!hasDefaultProposta) {
                    db.contractTemplates.push(defaultTemplates.find(t => t.id === 'template_proposta_padrao'));
                } else {
                    // Garante que o modelo existente seja atualizado com o novo conteúdo
                    const index = db.contractTemplates.findIndex(t => t.id === 'template_proposta_padrao');
                    db.contractTemplates[index] = defaultTemplates.find(t => t.id === 'template_proposta_padrao');
                }
                 if (!hasDefaultCorretagem) {
                    db.contractTemplates.push(defaultTemplates.find(t => t.id === 'template_corretagem_padrao'));
                }


                imovelFavoritos = JSON.parse(localStorage.getItem('imovelFavoritos')) || [];
            };
            
            const saveDb = () => {
                Object.keys(db).forEach(key => localStorage.setItem(`db_${key}`, JSON.stringify(db[key])));
                localStorage.setItem('imovelFavoritos', JSON.stringify(imovelFavoritos));
            };
            const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
            const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
            const showNotification = (message, type = 'success') => { const n = document.createElement('div'); const iconMap = {'success': 'fa-check-circle', 'error': 'fa-exclamation-triangle', 'info': 'fa-info-circle', 'warning':'fa-exclamation-circle'}; n.className = `notification ${type}`; n.innerHTML = `<i class="fas ${iconMap[type]}"></i> ${message}`; document.body.appendChild(n); setTimeout(() => n.remove(), 5000); };
            const openModal = (id) => { const modal = document.getElementById(id); modal.style.display = 'flex'; setTimeout(() => { const firstInput = modal.querySelector('input:not([type=hidden]):not([type=file]), select, textarea'); if (firstInput) firstInput.focus(); }, 100); };
            const closeModal = (id) => document.getElementById(id).style.display = 'none';
            const populateSelect = (selector, data, txtKey, valKey, defaultOptionText = "Selecione...") => { const s = document.querySelector(selector); if(!s) return; s.innerHTML = `<option value="">${defaultOptionText}</option>`; data.forEach(i => { const text = i[txtKey] || i['razaoSocial'] || '(Cliente sem nome)'; s.innerHTML += `<option value="${i[valKey]}">${text}</option>`; }); };
            const parseCurrency = (value) => { if(value === null || value === undefined) return 0; if (typeof value !== 'string') value = String(value); return parseFloat(value.replace(/[^\d,]/g, '').replace(',', '.')) || 0; }
            const formatCurrency = (value) => { const number = parseFloat(value) || 0; return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); };
            const formatInputAsCurrency = (input) => { let value = input.value.replace(/\D/g, ''); if (!value) { input.value = ''; return; } value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); input.value = value; };
            const logActivity = (icon, text) => { db.activities.unshift({ icon, text, time: new Date() }); if (db.activities.length > 50) db.activities.pop(); updateNotificationCount(true); };
            const renderEmptyState = (tbody, message, cta = '') => { const cols = tbody.closest('table').querySelectorAll('thead th').length; tbody.innerHTML = `<tr><td colspan="${cols}"><div class="empty-state"><i class="fas fa-folder-open"></i><p>${message}</p>${cta}</div></td></tr>`; };
            
            window.deleteItem = (key, id, renderFnName) => {
                if (currentUserRole !== 'admin') {
                    showNotification('Apenas administradores podem excluir itens.', 'error');
                    return;
                }
                const item = db[key].find(i => i.id === id);
                if (!item) {
                    showNotification('Erro: Item não encontrado para exclusão.', 'error');
                    return;
                }
                const itemType = key.slice(0, -1);
                const itemName = item.nome || item.razaoSocial || item.endereco || (item.numero ? `Contrato ${item.numero}`: '') || (item.descricao ? `Lançamento: ${item.descricao}`: '') || 'este item';
                
                if (confirm(`Tem certeza que deseja excluir o ${itemType} "${itemName}"? A ação não pode ser desfeita.`)) {
                    logActivity('fa-trash-alt', `${itemType.charAt(0).toUpperCase() + itemType.slice(1)} excluído: ${itemName}`);
                    db[key] = db[key].filter(i => i.id !== id);
                    saveDb();
                    window[renderFnName]();
                    renderDashboard();
                    renderAnalises();
                    if(key === 'contratos') renderContratos();
                    if(key === 'financeiro') renderFinanceiro();
                    showNotification(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} "${itemName}" excluído.`, 'info');
                }
            };
            
            const applyMask = (event, maskFunction) => { event.target.value = maskFunction(event.target.value); };
            const maskCPF = (value) => value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            const maskCNPJ = (value) => value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1/$2').replace(/(\d{4})(\d{1,2})$/, '$1-$2');
            const maskCEP = (value) => value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2');
            const maskPhone = (value) => { let v = value.replace(/\D/g, ''); if (v.length > 10) { v=v.replace(/^(\d\d)(\d{5})(\d{4}).*/,"($1) $2-$3"); } else { v=v.replace(/^(\d\d)(\d{4})(\d{4}).*/,"($1) $2-$3"); } return v; }
            const setButtonLoading = (btn, isLoading, originalText = btn.innerHTML) => { if(isLoading) { btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processando...`; } else { btn.disabled = false; btn.innerHTML = originalText; } };

            const handleNavigation = (tabId) => {
                document.querySelectorAll('.menu-item').forEach(l => l.classList.remove('active'));
                document.querySelector(`.menu-item[data-tab="${tabId}"]`)?.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                const activeTab = document.getElementById(tabId);
                if (activeTab) activeTab.classList.add('active');
                
                switch (tabId) {
                    case 'dashboard': renderDashboard(document.getElementById('dashboard-period-select').value); break;
                    case 'funil': renderKanbanBoard(); break;
                    case 'analises': renderAnalises(); break;
                    case 'agenda': renderCalendar(); break;
                    case 'financeiro': renderFinanceiro(); break;
                    case 'config': renderConfigCustomizations(); renderContractTemplates(); break;
                }
                if (window.innerWidth < 768 && !appContainer.classList.contains('sidebar-collapsed')) { appContainer.classList.add('sidebar-collapsed'); }
            };
            
            document.querySelectorAll('.menu-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); const tabId = item.dataset.tab; if (tabId === 'ajuda') { openModal('ajuda-modal'); return; } if (!tabId) return; handleNavigation(tabId); }));
            document.querySelectorAll('.close-button').forEach(b => b.addEventListener('click', function() { closeModal(this.dataset.modal); }));
            const themeToggle = document.getElementById('theme-toggle'); if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
            themeToggle.addEventListener('click', () => { document.body.classList.toggle('dark-mode'); const iD = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', iD ? 'dark' : 'light'); themeToggle.innerHTML = iD ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; Object.values(charts).forEach(chart => chart.destroy()); if (document.getElementById('dashboard').classList.contains('active')) renderDashboard(); if (document.getElementById('analises').classList.contains('active')) renderAnalises(); });
            const toggleSidebar = () => { appContainer.classList.toggle('sidebar-collapsed'); localStorage.setItem('sidebarCollapsed', appContainer.classList.contains('sidebar-collapsed')); };
            document.getElementById('sidebar-toggle-main').addEventListener('click', toggleSidebar);
            document.getElementById('sidebar-toggle-top').addEventListener('click', toggleSidebar);
            if (localStorage.getItem('sidebarCollapsed') === 'true') { appContainer.classList.add('sidebar-collapsed'); }
            
            const notificationBell = document.getElementById('notification-bell');
            const updateNotificationCount = (isNew = false) => { if (isNew) { db.notifications++; } const countEl = document.getElementById('notification-count'); countEl.textContent = db.notifications; countEl.style.display = db.notifications > 0 ? 'flex' : 'none'; saveDb(); };
            const renderNotifications = () => { const list = document.getElementById('notification-list'); list.innerHTML = ''; if (db.activities.length === 0) { list.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--secondary-color);">Nenhuma notificação</div>'; return; } db.activities.slice(0, 10).forEach(act => { list.innerHTML += `<a href="#"><i class="fas ${act.icon}" style="color: var(--accent-color);"></i><div><p>${act.text}</p><small>${new Date(act.time).toLocaleString('pt-BR')}</small></div></a>`; }); };
            notificationBell.addEventListener('click', (e) => { e.stopPropagation(); const dropdown = document.getElementById('notification-dropdown'); const isVisible = dropdown.style.display === 'flex'; dropdown.style.display = isVisible ? 'none' : 'flex'; if (!isVisible) { db.notifications = 0; updateNotificationCount(false); } renderNotifications(); });
            document.getElementById('clear-notifications-btn').addEventListener('click', () => { if (confirm('Limpar todas as notificações de atividades?')) { db.activities = []; saveDb(); renderNotifications(); showNotification('Notificações limpas.', 'info'); }});
            document.addEventListener('click', (e) => { const dropdown = document.getElementById('notification-dropdown'); if (!notificationBell.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none'; });
            const updateFavoritesCount = () => { const countEl = document.getElementById('favorites-count'); countEl.textContent = imovelFavoritos.length; countEl.style.display = imovelFavoritos.length > 0 ? 'flex' : 'none'; };
            
            const createOrUpdateChart = (id, type, data, options) => { const ctx = document.getElementById(id); if(!ctx) return; const context = ctx.getContext('2d'); if (charts[id]) charts[id].destroy(); charts[id] = new Chart(context, { type, data, options }); };
            const getChartOptions = () => { const isDark = document.body.classList.contains('dark-mode'); return { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDark ? '#d1d5db' : '#374151' } } }, scales: { x: { ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { color: isDark ? '#374151' : '#e5e7eb' } }, y: { ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { color: isDark ? '#374151' : '#e5e7eb' } } } }; };
            
            const renderDashboard = (period = 'this_month') => {
                let filteredContracts = db.contratos;
                let filteredRentals = db.contratos.filter(c => c.tipo === 'Locacao' && c.status === 'Ativo');

                if (period !== 'all_time') {
                    const now = new Date();
                    let startDate = new Date();

                    if (period === 'this_month') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    } else if (period === 'last_30_days') {
                        startDate.setDate(now.getDate() - 30);
                    } else if (period === 'this_year') {
                        startDate = new Date(now.getFullYear(), 0, 1);
                    }

                    startDate.setHours(0, 0, 0, 0);

                    filteredContracts = db.contratos.filter(c => {
                        if (!c.dataInicio) return false;
                        const contractDate = new Date(c.dataInicio + 'T00:00:00');
                        return contractDate >= startDate;
                    });
                }

                const totalVendas = filteredContracts.filter(c => c.tipo === 'Venda').reduce((sum, c) => {
                    const imovel = db.imoveis.find(i => i.id === c.imovelId);
                    return sum + (imovel ? parseCurrency(imovel.valor) : 0);
                }, 0);
                document.getElementById('db-total-vendas').textContent = formatCurrency(totalVendas);

                const totalAlugueis = filteredRentals.reduce((sum, c) => sum + parseCurrency(c.valorAluguel), 0);
                document.getElementById('db-total-alugueis').textContent = formatCurrency(totalAlugueis);

                document.getElementById('db-total-clientes').textContent = db.clientes.length;
                document.getElementById('db-total-contratos').textContent = db.contratos.filter(c => c.status === 'Ativo').length;
                
                const feedEl = document.getElementById('activity-feed');
                let activityHTML = '';
                if (db.activities.length === 0) {
                    activityHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>Nenhuma atividade recente.</p></div>';
                } else {
                    db.activities.slice(0, 10).forEach(act => {
                        activityHTML += `<div style="display:flex; align-items:flex-start; gap:10px; margin-bottom:15px;"><i class="fas ${act.icon}" style="margin-top:4px;"></i><div><p>${act.text}</p><p style="font-size:0.8rem;color:var(--secondary-color)">${new Date(act.time).toLocaleString('pt-BR')}</p></div></div>`;
                    });
                }
                feedEl.innerHTML = activityHTML;
                renderSalesChart(filteredContracts);
                renderPropertyTypeChart();
                renderActionableItems();
            };

            const renderSalesChart = (contractsToDisplay) => { 
                const salesByMonth = contractsToDisplay.filter(c => c.tipo === 'Venda' && c.dataInicio).reduce((acc, c) => { 
                    const month = new Date(c.dataInicio+'T00:00:00').toLocaleString('pt-BR', { month: 'short', year: '2-digit' }); 
                    acc[month] = (acc[month] || 0) + 1; return acc; 
                }, {}); 
                createOrUpdateChart('salesChart', 'bar', { labels: Object.keys(salesByMonth), datasets: [{ label: '# de Vendas', data: Object.values(salesByMonth), backgroundColor: 'rgba(79, 70, 229, 0.7)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] }, getChartOptions()); 
            };
            
            const renderPropertyTypeChart = () => { const types = db.imoveis.reduce((acc, i) => { acc[i.tipo] = (acc[i.tipo] || 0) + 1; return acc; }, {}); createOrUpdateChart('propertyTypeChart', 'pie', { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: ['#4f46e5', '#16a34a', '#f59e0b', '#dc2626', '#6d28d9', '#db2777', '#0ea5e9'] }] }, {...getChartOptions(), scales: {}}); };

            const renderActionableItems = () => {
                const container = document.getElementById('actionable-items-container');
                if (!container) return;
                let itemsFound = 0; let html = '';
                const now = new Date(); now.setHours(0, 0, 0, 0);
                const nowWithTime = new Date();
                
                db.clientes.forEach(cl => {
                    if (cl.dataNascimento) {
                        const birthDate = new Date(cl.dataNascimento + 'T00:00:00');
                        if (birthDate.getMonth() === now.getMonth() && birthDate.getDate() === now.getDate()) {
                            const age = now.getFullYear() - birthDate.getFullYear();
                            html += `<div class="action-item birthday" onclick="openDossie('${cl.id}')"><i class="fas fa-birthday-cake"></i> Hoje é aniversário de <b>${cl.nome}</b> (${age} anos)!</div>`;
                            itemsFound++;
                        } else {
                            for(let i=1; i<=7; i++) {
                                const nextDay = new Date(now); nextDay.setDate(now.getDate() + i);
                                if(nextDay.getMonth() === birthDate.getMonth() && nextDay.getDate() === birthDate.getDate()) {
                                   html += `<div class="action-item birthday-soon" onclick="openDossie('${cl.id}')"><i class="fas fa-gift"></i> Aniversário de <b>${cl.nome}</b> em ${i} dia(s).</div>`;
                                   itemsFound++;
                                }
                            }
                        }
                    }
                });
                
                db.clientes.forEach(cl => {
                    if (!cl.docId || !cl.docRenda || !cl.docEndereco) {
                        html += `<div class="action-item info" onclick="openDossie('${cl.id}')"><i class="fas fa-file-excel"></i> <b>${cl.nome || cl.razaoSocial}</b> está com documentação pendente.</div>`;
                        itemsFound++;
                    }
                    if (cl.funnelStage === 'won' && cl.commissionPaid === false) {
                        html += `<div class="action-item warning" onclick="openDossie('${cl.id}')"><i class="fas fa-hand-holding-usd"></i> <b>Pendente:</b> Receber comissão da venda para o cliente <b>${cl.nome || cl.razaoSocial}</b>.</div>`;
                        itemsFound++;
                    }
                });

                db.contratos.forEach(c => {
                    if (c.dataFinal && c.status === 'Ativo') {
                        const dataFim = new Date(c.dataFinal + 'T00:00:00');
                        const timeDiff = dataFim.getTime() - now.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        if (daysDiff >= 0 && daysDiff <= 7) {
                            const cliente = db.clientes.find(cli => cli.id === c.clienteId) || { nome: '(Excluído)', razaoSocial: '(Excluído)' };
                            let message = `O contrato de <b>${cliente.nome || cliente.razaoSocial}</b> (Nº ${c.numero}) `;
                            if (daysDiff === 0) { message += `vence <b>hoje</b>.`; }
                            else if (daysDiff === 1) { message += `vence <b>amanhã</b>.`; }
                            else { message += `vence em <b>${daysDiff} dias</b>.`; }
                            
                            html += `<div class="action-item warning" onclick="editContrato('${c.id}')"><i class="fas fa-file-signature"></i> ${message}</div>`;
                            itemsFound++;
                        }
                    }
                });
                
                 db.events.forEach(event => {
                    if (event.date && event.time) {
                        const eventDateTime = new Date(`${event.date}T${event.time}`);
                        const diffMinutes = (eventDateTime - nowWithTime) / (1000 * 60);

                        if (diffMinutes > 0 && diffMinutes <= 30) {
                            html += `<div class="action-item agenda" onclick="openEventModal('${event.id}')"><i class="fas fa-clock"></i> <b>Agenda:</b> Seu compromisso "${event.title}" começa em breve (${Math.round(diffMinutes)} min).</div>`;
                            itemsFound++;
                        }
                    }
                });

                db.clientes.forEach(cliente => {
                    (cliente.postSaleTasks || []).forEach(task => {
                        const taskDate = new Date(task.dueDate);
                        if (!task.completed && taskDate <= now) {
                            html += `<div class="action-item postsale" onclick="openDossie('${cliente.id}')"><i class="fas fa-sync-alt"></i> <b>Pós-Venda:</b> ${task.description} para <b>${cliente.nome || cliente.razaoSocial}</b>.</div>`;
                            itemsFound++;
                        }
                    });
                });

                if(db.lastBackup) {
                    const lastBackupDate = new Date(db.lastBackup);
                    const oneDay = 24 * 60 * 60 * 1000;
                    if((now - lastBackupDate) > oneDay) {
                        html += `<div class="action-item backup" onclick="handleNavigation('config')"><i class="fas fa-database"></i> Seu último backup foi há mais de 24h. Faça um novo backup.</div>`;
                        itemsFound++;
                    }
                } else {
                     html += `<div class="action-item backup" onclick="handleNavigation('config')"><i class="fas fa-database"></i> Você nunca fez um backup. Proteja seus dados!</div>`;
                     itemsFound++;
                }

                if (itemsFound === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 20px;"><i class="fas fa-check-circle" style="color:var(--success-color);"></i><p>Nenhuma ação imediata necessária. Bom trabalho!</p></div>';
                } else {
                    container.innerHTML = html;
                }
            };
            
            const renderAnalises = () => {
                const sales = db.contratos.filter(c => c.tipo === 'Venda');
                const totalRevenue = sales.reduce((sum, c) => sum + (parseCurrency(db.imoveis.find(i => i.id === c.imovelId)?.valor)), 0);
                document.getElementById('metric-avg-ticket').textContent = formatCurrency(sales.length > 0 ? totalRevenue / sales.length : 0);
                
                const vendidas = db.imoveis.filter(i => i.status === 'Vendido').length;
                const totalImoveisParaVenda = db.imoveis.filter(i => i.status === 'Vendido' || i.status === 'Disponível').length;
                const conversionRate = totalImoveisParaVenda > 0 ? (vendidas / totalImoveisParaVenda) * 100 : 0;
                document.getElementById('metric-conversion-rate').textContent = `${conversionRate.toFixed(1)}%`;

                renderBrokerCommissionChart();
                renderLeadSourceChart();
                renderGoalsProgress();
            };
            const renderBrokerCommissionChart = () => {
                const commissionData = db.corretores.map(broker => {
                    const totalCommission = db.contratos
                        .filter(c => c.corretorId === broker.id && c.tipo === 'Venda')
                        .reduce((sum, c) => {
                            const imovel = db.imoveis.find(i => i.id === c.imovelId);
                            const comValue = imovel ? parseCurrency(imovel.valor) * 0.06 : 0; 
                            return sum + comValue;
                        }, 0);
                    return { name: broker.nome, commission: totalCommission };
                });
                createOrUpdateChart('brokerCommissionChart', 'bar', { labels: commissionData.map(d => d.name), datasets: [{ label: 'Comissão Gerada (R$)', data: commissionData.map(d => d.commission), backgroundColor: 'rgba(22, 163, 74, 0.7)' }] }, getChartOptions());
            };
            const renderLeadSourceChart = () => {
                const sources = db.clientes.reduce((acc, cliente) => { const source = cliente.origem || 'Não Informado'; acc[source] = (acc[source] || 0) + 1; return acc; }, {});
                createOrUpdateChart('leadSourceChart', 'doughnut', { labels: Object.keys(sources), datasets: [{ data: Object.values(sources), backgroundColor: ['#4f46e5', '#16a34a', '#f59e0b', '#dc2626', '#6d28d9'] }] }, {...getChartOptions(), scales: {}});
            };
            const renderGoalsProgress = () => {
                const container = document.getElementById('goals-container');
                if(!container) return;
                const thisMonthSales = db.contratos.filter(c => {
                    if (c.tipo !== 'Venda' || !c.dataInicio) return false;
                    const contractDate = new Date(c.dataInicio + 'T00:00:00');
                    const now = new Date();
                    return contractDate.getMonth() === now.getMonth() && contractDate.getFullYear() === now.getFullYear();
                });
                const currentSalesValue = thisMonthSales.reduce((sum, c) => { const imovel = db.imoveis.find(i => i.id === c.imovelId); return sum + (imovel ? parseCurrency(imovel.valor) : 0); }, 0);
                const currentContractsCount = thisMonthSales.length;
                const salesGoal = db.config.salesGoal || 0;
                const contractsGoal = db.config.contractsGoal || 0;
                const salesPercent = salesGoal > 0 ? Math.min((currentSalesValue / salesGoal) * 100, 100) : 0;
                const contractsPercent = contractsGoal > 0 ? Math.min((currentContractsCount / contractsGoal) * 100, 100) : 0;
                container.innerHTML = `<div class="form-group"><label>Progresso de Vendas (VGV) - ${formatCurrency(currentSalesValue)} / ${formatCurrency(salesGoal)}</label><div style="background: var(--border-color); border-radius: 5px; overflow:hidden;"><div style="width:${salesPercent}%; background:var(--success-color); color:white; text-align:center; padding: 4px 0; font-size: 0.8rem;">${salesPercent.toFixed(1)}%</div></div></div><div class="form-group"><label>Progresso de Contratos - ${currentContractsCount} / ${contractsGoal}</label><div style="background: var(--border-color); border-radius: 5px; overflow:hidden;"><div style="width:${contractsPercent}%; background:var(--primary-color); color:white; text-align:center; padding: 4px 0; font-size: 0.8rem;">${contractsPercent.toFixed(1)}%</div></div></div>`;
            };

            const globalSearchBar = document.getElementById('main-search-bar');
            const globalSearchResults = document.getElementById('global-search-results');
            globalSearchBar.addEventListener('input', () => {
                const query = globalSearchBar.value.toLowerCase();
                document.getElementById('clear-search-btn').style.display = query ? 'block' : 'none';
                if (query.length < 2) { globalSearchResults.style.display = 'none'; return; }
                let html = '';
                const clientes = db.clientes.filter(c => (c.nome || '').toLowerCase().includes(query) || (c.razaoSocial || '').toLowerCase().includes(query) || (c.cpf || '').includes(query) || (c.cnpj || '').includes(query)).slice(0, 5);
                if (clientes.length > 0) { html += '<div class="search-result-category">Clientes</div>'; clientes.forEach(c => { html += `<a href="#" class="search-result-item" data-type="cliente" data-id="${c.id}"><i class="fas fa-user"></i> ${c.nome || c.razaoSocial}</a>`; }); }
                const imoveis = db.imoveis.filter(i => i.endereco.toLowerCase().includes(query)).slice(0, 5);
                if (imoveis.length > 0) { html += '<div class="search-result-category">Imóveis</div>'; imoveis.forEach(i => { html += `<a href="#" class="search-result-item" data-type="imovel" data-id="${i.id}"><i class="fas fa-home"></i> ${i.endereco}</a>`; }); }
                const corretores = db.corretores.filter(c => c.nome.toLowerCase().includes(query)).slice(0, 5);
                if (corretores.length > 0) { html += '<div class="search-result-category">Corretores</div>'; corretores.forEach(c => { html += `<a href="#" class="search-result-item" data-type="corretor" data-id="${c.id}"><i class="fas fa-user-tie"></i> ${c.nome}</a>`; }); }
                if (html) { globalSearchResults.innerHTML = html; globalSearchResults.style.display = 'block'; } else { globalSearchResults.style.display = 'none'; }
            });
            globalSearchResults.addEventListener('click', e => {
                e.preventDefault();
                const target = e.target.closest('.search-result-item');
                if (!target) return;
                const { type, id } = target.dataset;
                switch(type) {
                    case 'cliente': openDossie(id); break;
                    case 'imovel': viewImovelDetails(id); break;
                    case 'corretor': editCorretor(id); break;
                }
                globalSearchBar.value = ''; globalSearchResults.style.display = 'none'; document.getElementById('clear-search-btn').style.display = 'none';
            });
            document.getElementById('clear-search-btn').addEventListener('click', () => { globalSearchBar.value = ''; globalSearchResults.style.display = 'none'; document.getElementById('clear-search-btn').style.display = 'none'; });

            window.downloadFile = (base64, filename) => { if (!base64 || !filename) { showNotification('Arquivo não encontrado.', 'error'); return; } const a = document.createElement('a'); a.href = base64; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const getAttachmentAsObject = async (inputId) => { const input = document.getElementById(inputId); if (input.files.length > 0) { const file = input.files[0]; const content = await toBase64(file); return { filename: file.name, content }; } return null; };
            const setupAttachmentHandler = (docType, formIdPrefix) => {
                const input = document.getElementById(`${formIdPrefix}-${docType}-input`);
                input.addEventListener('change', async () => {
                    if (input.files.length > 0) {
                        const file = input.files[0];
                        const content = await toBase64(file);
                        const fileObject = { filename: file.name, content };
                        renderAttachmentInForm(docType, formIdPrefix, fileObject);
                    }
                });
            };
            const renderAttachmentInForm = (docType, formIdPrefix, fileObject) => {
                const listContainer = document.getElementById(`${formIdPrefix}-${docType}-list`);
                if (fileObject && fileObject.filename) {
                    listContainer.innerHTML = `<div class="file-list-form"><span class="file-info" title="${fileObject.filename}"><i class="fas fa-file-alt"></i> ${fileObject.filename}</span><span class="file-actions"><button type="button" class="download-btn" title="Baixar anexo"><i class="fas fa-download"></i></button><button type="button" class="remove-btn" title="Remover anexo"><i class="fas fa-times-circle"></i></button></span></div>`;
                    listContainer.querySelector('.download-btn').onclick = () => downloadFile(fileObject.content, fileObject.filename);
                    listContainer.querySelector('.remove-btn').onclick = () => {
                        document.getElementById(`${formIdPrefix}-${docType}-input`).value = '';
                        listContainer.innerHTML = '';
                        showNotification('Anexo removido. Salve o formulário para confirmar a remoção.', 'info');
                    };
                } else {
                    listContainer.innerHTML = '';
                }
            };
            
            const validateCPF = (cpf) => {
                cpf = cpf.replace(/[^\d]+/g,'');
                if(cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
                let add = 0;
                for (let i=0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
                let rev = 11 - (add % 11);
                if (rev === 10 || rev === 11) rev = 0;
                if (rev !== parseInt(cpf.charAt(9))) return false;
                add = 0;
                for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
                rev = 11 - (add % 11);
                if (rev === 10 || rev === 11) rev = 0;
                if (rev !== parseInt(cpf.charAt(10))) return false;
                return true;
            };
            const validateCNPJ = (cnpj) => {
                cnpj = cnpj.replace(/[^\d]+/g,'');
                if(cnpj.length != 14 || /^(\d)\1+$/.test(cnpj)) return false;
                let tamanho = cnpj.length - 2
                let numeros = cnpj.substring(0,tamanho);
                let digitos = cnpj.substring(tamanho);
                let soma = 0;
                let pos = tamanho - 7;
                for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
                }
                let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
                if (resultado != digitos.charAt(0)) return false;
                tamanho = tamanho + 1;
                numeros = cnpj.substring(0,tamanho);
                soma = 0;
                pos = tamanho - 7;
                for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
                }
                resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
                if (resultado != digitos.charAt(1)) return false;
                return true;
            }

            const validateField = (field) => {
                let isValid = true;
                const isFieldVisible = field.offsetParent !== null;
                if (field.hasAttribute('required') && isFieldVisible) {
                    if(field.type === 'number') {
                        isValid = field.value !== null && field.value !== '';
                    } else {
                        isValid = field.value.trim() !== '';
                    }
                }
                if (isValid && isFieldVisible && field.type === 'email' && field.value.trim() !== '') isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value);
                if (isValid && isFieldVisible && field.name === 'cpf' && field.value.trim() !== '') isValid = validateCPF(field.value);
                if (isValid && isFieldVisible && field.name === 'cnpj' && field.value.trim() !== '') isValid = validateCNPJ(field.value);
                
                field.classList.toggle('is-invalid', !isValid);
                return isValid;
            };

            const validateForm = (form) => {
                let isFormValid = true;
                form.querySelectorAll('[required], [type="email"], [name="cpf"], [name="cnpj"]').forEach(field => {
                    const isFieldVisible = field.offsetParent !== null;
                    if (isFieldVisible && !validateField(field)) {
                        isFormValid = false;
                    }
                });
                return isFormValid;
            };

            const setupFormValidation = (formId) => {
                const form = document.getElementById(formId);
                if (!form) return;
                
                const checkField = (e) => validateField(e.target);

                form.querySelectorAll('[required], [type="email"], [name="cpf"], [name="cnpj"]').forEach(field => {
                    field.addEventListener('input', checkField);
                    field.addEventListener('blur', checkField);
                });
            };

            const handleFormSubmit = async (form, dbKey, renderFn) => {
                if (!validateForm(form)) {
                    showNotification('Por favor, corrija os erros no formulário.', 'error');
                    return;
                }
                const id = form.querySelector('[name="id"]').value;
                const formData = {};
                new FormData(form).forEach((value, key) => formData[key] = value);

                const attachmentFields = {
                    'clientes': ['docId', 'docRenda', 'docEndereco'],
                    'corretores': ['docId', 'docCreci', 'docContrato'],
                };
                
                const formIdPrefix = dbKey === 'corretores' ? 'corretor' : dbKey.slice(0, -1);

                const docTypes = attachmentFields[dbKey] || [];
                let item;

                if (id) {
                    item = db[dbKey].find(i => i.id === id);
                    if (!item) { showNotification('Erro: Item não encontrado para atualização.', 'error'); return; }

                    for (const doc of docTypes) {
                        const fileInput = document.getElementById(`${formIdPrefix}-${doc}-input`);
                        if (fileInput && fileInput.files.length > 0) {
                            formData[doc] = await getAttachmentAsObject(fileInput.id);
                        } else {
                            const listContainer = document.getElementById(`${formIdPrefix}-${doc}-list`);
                            if (listContainer && listContainer.innerHTML === '') {
                                formData[doc] = null;
                            } else if (item) {
                                formData[doc] = item[doc];
                            }
                        }
                    }
                    if (dbKey === 'imoveis') {
                        formData.fotos = imovelFotos.length > 0 ? imovelFotos : item.fotos;
                        formData.valor = parseCurrency(formData.valor);
                    }
                    if (dbKey === 'clientes') {
                        formData.searchProfile_precoMin = parseCurrency(formData.searchProfile_precoMin);
                        formData.searchProfile_precoMax = parseCurrency(formData.searchProfile_precoMax);
                        formData.nome = formData.tipoPessoa === 'juridica' ? formData.razaoSocial : formData.nome;
                    }
                    if (dbKey === 'financeiro') {
                        formData.valor = parseCurrency(formData.valor);
                    }
                    if (dbKey === 'contratos') {
                        formData.valorAluguel = parseCurrency(formData.valorAluguel);
                        formData.valorHonorarios = parseCurrency(formData.valorHonorarios);
                        formData.proposta_valorSinal = parseCurrency(formData.proposta_valorSinal);
                        formData.proposta_valorParcelado = parseCurrency(formData.proposta_valorParcelado);
                    }
                    const index = db[dbKey].findIndex(i => i.id === id);
                    db[dbKey][index] = { ...item, ...formData };
                    logActivity('fa-edit', `${formIdPrefix} atualizado: ${formData.nome || formData.razaoSocial || formData.endereco || formData.numero || formData.descricao}`);
                    showNotification(`${formIdPrefix.charAt(0).toUpperCase() + formIdPrefix.slice(1)} atualizado com sucesso!`, 'success');
                } else {
                    formData.id = generateId();
                    for (const doc of docTypes) {
                        const fileObject = await getAttachmentAsObject(`${formIdPrefix}-${doc}-input`);
                        if (fileObject) formData[doc] = fileObject;
                    }
                    if (dbKey === 'imoveis') {
                        formData.fotos = imovelFotos;
                        formData.valor = parseCurrency(formData.valor);
                    }
                    if (dbKey === 'clientes') {
                        formData.funnelStage = 'lead';
                        formData.funnelStageLastUpdated = new Date().toISOString();
                        formData.notes = [];
                        formData.propertyOfInterestId = null;
                        formData.commissionPaid = null;
                        formData.postSaleTasks = [];
                        formData.searchProfile_precoMin = parseCurrency(formData.searchProfile_precoMin);
                        formData.searchProfile_precoMax = parseCurrency(formData.searchProfile_precoMax);
                        formData.nome = formData.tipoPessoa === 'juridica' ? formData.razaoSocial : formData.nome;
                    }
                    if (dbKey === 'financeiro') {
                        formData.valor = parseCurrency(formData.valor);
                    }
                    if (dbKey === 'contratos') {
                         formData.valorAluguel = parseCurrency(formData.valorAluguel);
                        formData.valorHonorarios = parseCurrency(formData.valorHonorarios);
                        formData.proposta_valorSinal = parseCurrency(formData.proposta_valorSinal);
                        formData.proposta_valorParcelado = parseCurrency(formData.proposta_valorParcelado);
                    }
                    db[dbKey].push(formData);
                    logActivity('fa-plus', `Novo ${formIdPrefix}: ${formData.nome || formData.razaoSocial || formData.endereco || formData.numero || formData.descricao}`);
                    showNotification(`${formIdPrefix.charAt(0).toUpperCase() + formIdPrefix.slice(1)} criado com sucesso!`, 'success');
                }
                
                saveDb();
                renderFn();
                renderDashboard();
                renderAnalises();
                if (dbKey === 'clientes') renderKanbanBoard();
                if (dbKey === 'contratos') renderContratos();
                if (dbKey === 'financeiro') renderFinanceiro();
                closeModal(`${formIdPrefix}-modal`);
            };

            const clienteForm = document.getElementById('cliente-form'); 
            document.getElementById('novo-cliente-btn').addEventListener('click', () => { 
                clienteForm.reset(); 
                clienteForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                document.querySelector('#cliente-form [name="id"]').value = ''; 
                document.getElementById('cliente-modal-title').innerHTML = '<i class="fas fa-user-plus"></i> Novo Cliente';
                ['docId', 'docRenda', 'docEndereco'].forEach(doc => renderAttachmentInForm(doc, 'cliente', null));
                document.querySelector('[name="spc"]').value = 'nao_verificado';
                togglePessoaFields('fisica');
                openModal('cliente-modal'); 
            }); 
            document.querySelector('#cliente-form [name="cep"]').addEventListener('blur', async e => {
                const cepInput = e.target; const cep = cepInput.value.replace(/\D/g, ''); if (cep.length !== 8) return;
                const spinner = document.getElementById('cep-spinner'); spinner.style.display = 'block';
                try {
                    const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    if (!r.ok) throw new Error('Falha na resposta da API');
                    const d = await r.json();
                    if (!d.erro) {
                        document.querySelector('#cliente-form [name="rua"]').value = d.logradouro || '';
                        document.querySelector('#cliente-form [name="bairro"]').value = d.bairro || '';
                        document.querySelector('#cliente-form [name="cidade"]').value = d.localidade || '';
                        document.querySelector('#cliente-form [name="estado"]').value = d.uf || '';
                        document.querySelector('#cliente-form [name="numero"]').focus();
                    } else { showNotification('CEP não encontrado.', 'warning'); }
                } catch { showNotification('Erro ao buscar CEP.', 'error'); } finally { spinner.style.display = 'none'; }
            });
            document.getElementById('consultar-spc-btn').addEventListener('click', e => { 
                const btn = e.currentTarget; const originalText = btn.innerHTML; setButtonLoading(btn, true); 
                const nome = document.querySelector('#cliente-form [name="nome"]').value;
                const cpf = document.querySelector('#cliente-form [name="cpf"]').value;

                setTimeout(() => { 
                    const isRestrito = Math.random() < 0.15;
                    const statusValue = isRestrito ? 'restricao' : 'limpo';
                    document.querySelector('#cliente-form [name="spc"]').value = statusValue;
                    
                    const resultBody = document.getElementById('spc-result-body');
                    let resultHTML = `<p><strong>Nome:</strong> ${nome || 'Não informado'}</p><p><strong>CPF:</strong> ${cpf || 'Não informado'}</p>`;
                    if (isRestrito) {
                        resultHTML += `<h4 style="color:var(--danger-color); margin-top:15px;">Situação: COM RESTRIÇÃO</h4><p>Foram encontradas as seguintes pendências (simulação):</p><ul><li>Dívida em Loja de Varejo - R$ 850,30</li><li>Cheque sem Fundo - R$ 1.200,00</li></ul>`;
                    } else {
                        resultHTML += `<h4 style="color:var(--success-color); margin-top:15px;">Situação: NOME LIMPO</h4><p>Nenhuma pendência financeira encontrada para o CPF consultado.</p>`;
                    }
                    resultBody.innerHTML = resultHTML;
                    openModal('spc-result-modal');
                    
                    showNotification('Consulta SPC simulada com sucesso!', 'info'); 
                    setButtonLoading(btn, false, originalText); 
                }, 1500); 
            }); 
            clienteForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(clienteForm, 'clientes', renderClientes); }); 
            document.getElementById('cliente-tipo-pessoa').addEventListener('change', e => togglePessoaFields(e.target.value));

            const togglePessoaFields = (tipo) => {
                const pfFields = document.getElementById('dados-pessoa-fisica');
                const pjFields = document.getElementById('dados-pessoa-juridica');
                const nomeField = pfFields.querySelector('[name="nome"]');
                const cpfField = pfFields.querySelector('[name="cpf"]');
                const razaoSocialField = pjFields.querySelector('[name="razaoSocial"]');
                const cnpjField = pjFields.querySelector('[name="cnpj"]');

                if (tipo === 'juridica') {
                    pfFields.style.display = 'none';
                    pjFields.style.display = 'block';
                    nomeField.required = false;
                    cpfField.required = false;
                    razaoSocialField.required = true;
                    cnpjField.required = true;
                } else { // 'fisica'
                    pfFields.style.display = 'block';
                    pjFields.style.display = 'none';
                    nomeField.required = true;
                    cpfField.required = true;
                    razaoSocialField.required = false;
                    cnpjField.required = false;
                }
            };
            
            window.editCliente = id => { 
                const c = db.clientes.find(c => c.id === id); if (!c) return; 
                clienteForm.reset(); 
                clienteForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                document.getElementById('cliente-modal-title').innerHTML = `<i class="fas fa-user-edit"></i> Editar Cliente`;
                
                const tipoPessoa = c.tipoPessoa || 'fisica';
                document.getElementById('cliente-tipo-pessoa').value = tipoPessoa;
                togglePessoaFields(tipoPessoa);

                Object.keys(c).forEach(key => { 
                    const el = document.querySelector(`#cliente-form [name="${key}"]`); 
                    if (el) {
                        if (el.classList.contains('currency-input')) {
                            el.value = c[key] ? formatCurrency(c[key]).replace('R$', '').trim() : '';
                        } else {
                            el.value = c[key] || '';
                        }
                    }
                }); 
                document.querySelector('#cliente-form [name="cpf"]').value = c.cpf ? maskCPF(c.cpf) : '';
                document.querySelector('#cliente-form [name="cnpj"]').value = c.cnpj ? maskCNPJ(c.cnpj) : '';
                document.querySelector('#cliente-form [name="telefone"]').value = c.telefone ? maskPhone(c.telefone) : '';
                document.querySelector('#cliente-form [name="cep"]').value = c.cep ? maskCEP(c.cep) : '';
                ['docId', 'docRenda', 'docEndereco'].forEach(doc => renderAttachmentInForm(doc, 'cliente', c[doc])); 
                openModal('cliente-modal'); 
            }; 

            window.openDossie = (clienteId) => {
                const cliente = db.clientes.find(c => c.id === clienteId);
                if(!cliente) return;
                document.getElementById('dossie-modal-title').innerHTML = `<i class="fas fa-user-secret"></i> Dossiê de ${cliente.nome || cliente.razaoSocial}`;
                const body = document.getElementById('dossie-modal-body');
                
                let imoveisCompativeisHtml = '<p>Nenhum imóvel compatível encontrado. Preencha o Perfil de Busca do cliente.</p>';
                const imoveisCompativeis = findMatchingProperties(cliente);
                if(imoveisCompativeis.length > 0) {
                    imoveisCompativeisHtml = '<div class="matching-list">';
                    imoveisCompativeis.forEach(imovel => {
                        imoveisCompativeisHtml += `<div class="matching-item" onclick="viewImovelDetails('${imovel.id}')"><strong>${imovel.endereco}</strong><span>${formatCurrency(imovel.valor)} - ${imovel.quartos}Q</span></div>`;
                    });
                    imoveisCompativeisHtml += '</div>';
                }

                const contratosCliente = db.contratos.filter(c => c.clienteId === clienteId);
                let contratosHtml = '<p>Nenhum contrato encontrado.</p>';
                if(contratosCliente.length > 0) {
                    contratosHtml = `<div class="table-responsive"><table class="table compact-view"><thead><tr><th>Nº</th><th>Tipo</th><th>Imóvel</th><th>Status</th></tr></thead><tbody>`;
                    contratosCliente.forEach(c => { const imovel = db.imoveis.find(i => i.id === c.imovelId) || { endereco: 'N/A' }; contratosHtml += `<tr><td>${c.numero}</td><td>${db.config.contractTypes[c.tipo] || c.tipo}</td><td>${imovel.endereco}</td><td>${c.status}</td></tr>`; });
                    contratosHtml += '</tbody></table></div>';
                }
                let notasHtml = '';
                (cliente.notes || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(note => { notasHtml += `<div class="note-item"><div class="note-item-meta">${new Date(note.date).toLocaleString('pt-BR')}</div><div>${note.text.replace(/\n/g, '<br>')}</div></div>`; });

                const imoveisSelectOptions = db.imoveis.filter(i => i.status === 'Disponível').map(i => `<option value="${i.id}" ${cliente.propertyOfInterestId === i.id ? 'selected' : ''}>${i.endereco} - ${formatCurrency(i.valor)}</option>`).join('');
                
                let commissionButtonHTML = '';
                if(cliente.funnelStage === 'won' && cliente.commissionPaid === false) {
                    commissionButtonHTML = `<button class="btn btn-success" id="mark-commission-paid-btn">Marcar Comissão como Paga</button>`;
                }

                let postSaleHtml = '';
                if(cliente.funnelStage === 'won') {
                    postSaleHtml = `<div class="dossie-section">
                        <h4><i class="fas fa-sync-alt"></i> Jornada Pós-Venda</h4>`;
                    if((cliente.postSaleTasks || []).length > 0) {
                        cliente.postSaleTasks.forEach(task => {
                            postSaleHtml += `
                                <div class="post-sale-task ${task.completed ? 'completed' : ''}">
                                    <div class="post-sale-task-info">
                                        <i class="fas ${task.completed ? 'fa-check-circle' : 'fa-clock'}" style="color: ${task.completed ? 'var(--success-color)' : 'var(--secondary-color)'}"></i>
                                        <span>${task.description} (Venc.: ${new Date(task.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')})</span>
                                    </div>
                                    <button class="btn btn-success btn-sm" onclick="completePostSaleTask('${cliente.id}', '${task.id}')">Concluir</button>
                                </div>`;
                        });
                    } else {
                        postSaleHtml += '<p>Nenhuma tarefa de pós-venda para este cliente.</p>';
                    }
                    postSaleHtml += '</div>';
                }

                const simulacoesCliente = (db.simulations || []).filter(s => s.clienteId === clienteId);
                let simulacoesHtml = '<p>Nenhuma simulação salva.</p>';
                if(simulacoesCliente.length > 0) {
                    simulacoesHtml = '<div class="matching-list">';
                    simulacoesCliente.forEach(s => {
                        simulacoesHtml += `<div class="note-item">
                            <div class="note-item-meta">${new Date(s.date).toLocaleString('pt-BR')} - <strong>${s.type}</strong></div>
                            <p>Valor do Imóvel: <strong>R$ ${s.valorImovel}</strong> | Entrada: <strong>R$ ${s.valorEntrada}</strong></p>
                            <p>Tabela PRICE: <strong>${s.results.priceParcela}</strong> | Tabela SAC: <strong>${s.results.sacPrimeira}</strong></p>
                        </div>`;
                    });
                    simulacoesHtml += '</div>';
                }
                
                body.innerHTML = `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <div class="dossie-section">
                            <h4><i class="fas fa-id-card"></i> Dados Cadastrais <button class="btn btn-sm btn-info" style="float: right;" onclick="editCliente('${cliente.id}')">Editar</button></h4>
                            <p><strong>${cliente.tipoPessoa === 'juridica' ? 'CNPJ' : 'CPF'}:</strong> ${cliente.cnpj || cliente.cpf || 'N/A'}</p>
                            <p><strong>Telefone:</strong> ${cliente.telefone || 'N/A'}</p><p><strong>E-mail:</strong> ${cliente.email || 'N/A'}</p>
                        </div>
                        <div class="dossie-section">
                             <h4><i class="fas fa-comments"></i> Histórico de Comunicação</h4>
                             <div id="communication-history"></div>
                        </div>
                         <div class="dossie-section">
                            <h4><i class="fas fa-magic"></i> Imóveis Compatíveis</h4>
                            ${imoveisCompativeisHtml}
                        </div>
                        <div class="dossie-section">
                            <h4><i class="fas fa-file-signature"></i> Histórico de Contratos</h4>
                            ${contratosHtml}
                        </div>
                        <div class="dossie-section">
                            <h4><i class="fas fa-calculator"></i> Simulações Salvas</h4>
                            ${simulacoesHtml}
                        </div>
                        ${postSaleHtml}
                    </div>
                    <div>
                        <div class="dossie-section">
                            <h4><i class="fas fa-home"></i> Interesse Principal</h4>
                            <div class="form-group">
                                <label class="form-label">Vincular imóvel a esta oportunidade:</label>
                                <div style="display:flex; gap: 5px;">
                                    <select class="form-control" id="dossie-imovel-interesse" style="flex-grow:1;"><option value="">Nenhum</option>${imoveisSelectOptions}</select>
                                    <button class="btn btn-sm btn-danger" id="desvincular-imovel-dossie" title="Desvincular Imóvel"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="dossie-section">
                             <h4><i class="fas fa-cogs"></i> Ações</h4>
                             ${commissionButtonHTML || '<p>Nenhuma ação disponível.</p>'}
                        </div>
                        <div class="dossie-section">
                            <h4><i class="fas fa-sticky-note"></i> Anotações e Interações</h4>
                            <form id="add-note-form"><input type="hidden" name="clienteId" value="${clienteId}"><div class="form-group"><textarea name="noteText" class="form-control" rows="3" placeholder="Adicione uma nova anotação sobre a interação..." required></textarea></div><button type="submit" class="btn btn-primary btn-sm">Adicionar Anotação</button></form>
                            <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">${notasHtml || '<p>Nenhuma anotação registrada.</p>'}</div>
                        </div>
                    </div>
                </div>`;
                
                const commHistoryContainer = body.querySelector('#communication-history');
                const comms = (cliente.communications || []).sort((a, b) => new Date(b.date) - new Date(a.date));
                if (comms.length > 0) {
                    commHistoryContainer.innerHTML = comms.map(comm => `
                        <div class="note-item">
                            <div class="note-item-meta">
                                <strong>${new Date(comm.date).toLocaleString('pt-BR')}</strong> - Tipo: <strong>${comm.type}</strong>
                            </div>
                            <div>${comm.summary.replace(/\n/g, '<br>')}</div>
                        </div>`).join('');
                } else {
                    commHistoryContainer.innerHTML = '<p>Nenhum registro de comunicação.</p>';
                }
                
                body.querySelector('#add-note-form').addEventListener('submit', e => { e.preventDefault(); const text = e.target.querySelector('[name=noteText]').value; const clienteToUpdate = db.clientes.find(c => c.id === clienteId); if(clienteToUpdate) { if(!clienteToUpdate.notes) clienteToUpdate.notes = []; clienteToUpdate.notes.push({ date: new Date(), text }); saveDb(); showNotification('Anotação adicionada com sucesso!', 'success'); openDossie(clienteId); } });
                
                const imovelSelect = body.querySelector('#dossie-imovel-interesse');
                imovelSelect.onchange = () => { cliente.propertyOfInterestId = imovelSelect.value || null; saveDb(); renderKanbanBoard(); showNotification('Imóvel de interesse atualizado!', 'info'); };
                body.querySelector('#desvincular-imovel-dossie').onclick = () => { imovelSelect.value = ''; cliente.propertyOfInterestId = null; saveDb(); renderKanbanBoard(); showNotification('Imóvel desvinculado.', 'info'); }
                const commissionBtn = body.querySelector('#mark-commission-paid-btn');
                if(commissionBtn) {
                    commissionBtn.onclick = () => { cliente.commissionPaid = true; saveDb(); showNotification('Comissão marcada como paga!', 'success'); renderDashboard(); openDossie(clienteId); }
                }

                openModal('dossie-cliente-modal');
            };

            ['cpf', 'cnpj', 'cep', 'telefone', 'contato_add_1_tel', 'contato_add_2_tel', 'contato_add_3_tel'].forEach(field => {
                const el = document.querySelector(`#cliente-form [name="${field}"]`);
                if(el) el.addEventListener('input', (e) => { 
                    if(field === 'cpf') applyMask(e, maskCPF); 
                    else if(field === 'cnpj') applyMask(e, maskCNPJ);
                    else if(field === 'cep') applyMask(e, maskCEP); 
                    else applyMask(e, maskPhone); 
                });
            });
            ['docId', 'docRenda', 'docEndereco'].forEach(doc => setupAttachmentHandler(doc, 'cliente'));
            
            const imovelForm = document.getElementById('imovel-form'); let imovelFotos = []; let imoveisViewMode = 'netflix'; 
            document.getElementById('novo-imovel-btn').addEventListener('click', () => { imovelForm.reset(); document.querySelector('#imovel-form [name="id"]').value = ''; document.getElementById('imovel-modal-title').innerHTML = '<i class="fas fa-home"></i> Novo Imóvel'; document.getElementById('imovel-fotos-preview').innerHTML = ''; imovelFotos = []; document.querySelector('#imovel-form [name="status"]').value = 'Disponível'; populateSelect('#imovel-form [name="corretorResponsavelId"]', db.corretores, 'nome', 'id'); openModal('imovel-modal'); }); 
            document.getElementById('imovel-fotos-input').addEventListener('change', async e => { const preview = document.getElementById('imovel-fotos-preview'); preview.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...'; let newFotosHTML = ''; imovelFotos = []; try { const newFotos = await Promise.all(Array.from(e.target.files).map(toBase64)); imovelFotos = imovelFotos.concat(newFotos); imovelFotos.forEach(src => newFotosHTML += `<img src="${src}" style="width:100px; height:100px; object-fit:cover; border-radius:var(--border-radius-sm);">`); preview.innerHTML = newFotosHTML; } catch (error) { showNotification('Erro ao carregar imagem.', 'error'); preview.innerHTML = ''; } }); 
            imovelForm.addEventListener('submit', e => { e.preventDefault(); if (imovelFotos.length === 0 && !document.querySelector('#imovel-form [name="id"]').value) { showNotification('É necessário no mínimo 1 foto do imóvel.', 'error'); return; } handleFormSubmit(imovelForm, 'imoveis', renderImoveis); imovelFotos = []; }); 
            window.toggleFavorite = (imovelId, event) => { event.stopPropagation(); const index = imovelFavoritos.indexOf(imovelId); if (index > -1) { imovelFavoritos.splice(index, 1); showNotification('Imóvel removido dos favoritos.', 'info'); } else { imovelFavoritos.push(imovelId); showNotification('Imóvel adicionado aos favoritos!', 'success'); } saveDb(); if (document.getElementById('imoveis').classList.contains('active')) renderImoveis(); if (document.getElementById('imovel-details-modal').style.display === 'flex') viewImovelDetails(imovelId); updateFavoritesCount(); };
            window.shareImovel = (imovelId, event) => { event.stopPropagation(); const url = `${window.location.href.split('?')[0]}?view=property&id=${imovelId}`; navigator.clipboard.writeText(url).then(() => { showNotification('Link de compartilhamento copiado!', 'info'); }); };
            window.editImovel = id => { closeModal('imovel-details-modal'); const i = db.imoveis.find(i => i.id === id); if (!i) return; imovelForm.reset(); document.getElementById('imovel-modal-title').innerHTML = `<i class="fas fa-edit"></i> Editar Imóvel`; populateSelect('#imovel-form [name="corretorResponsavelId"]', db.corretores, 'nome', 'id'); setTimeout(() => { Object.keys(i).forEach(key => { if(key !== 'fotos') {const el = document.querySelector(`#imovel-form [name="${key}"]`); if (el) { el.classList.contains('currency-input') ? el.value = i[key] ? formatCurrency(i[key]).replace('R$', '').trim() : '' : el.value = i[key]; } } }); }, 100); imovelFotos = i.fotos || []; const preview = document.getElementById('imovel-fotos-preview'); let previewHtml = ''; imovelFotos.forEach(src => previewHtml += `<img src="${src}" style="width:100px; height:100px; object-fit:cover; border-radius:var(--border-radius-sm);">`); preview.innerHTML = previewHtml; openModal('imovel-modal'); }; 
            window.renderImoveis = () => { 
                const headers = [ {key: 'checkbox', label: `<input type="checkbox" id="imoveis-select-all">`}, {key: 'endereco', label: 'Endereço'}, {key: 'proprietario', label: 'Proprietário'}, {key: 'tipo', label: 'Tipo'}, {key: 'valor', label: 'Valor'}, {key: 'status', label: 'Status'}, {key: 'actions', label: 'Ações'} ];
                setupTableSorting('imoveis', headers);
                const filterText = document.getElementById('imoveis-filter-text').value.toLowerCase();
                const filterTipo = document.getElementById('imoveis-filter-tipo').value;
                const filterStatus = document.getElementById('imoveis-filter-status').value;
                const filterQuartos = document.getElementById('imoveis-filter-quartos').value;
                
                let filteredData = db.imoveis.filter(i => {
                     const textMatch = (i.endereco.toLowerCase().includes(filterText) || (i.proprietario || '').toLowerCase().includes(filterText)); 
                     const tipoMatch = !filterTipo || i.tipo === filterTipo; 
                     const statusMatch = !filterStatus || i.status === filterStatus; 
                     const quartosMatch = !filterQuartos || parseInt(i.quartos) >= parseInt(filterQuartos);
                     return textMatch && tipoMatch && statusMatch && quartosMatch;
                });
                
                if (imoveisViewMode === 'table') {
                    renderPaginatedTable('imoveis', filteredData);
                     const selectAll = document.getElementById('imoveis-select-all');
                    if (selectAll) {
                        selectAll.addEventListener('change', (e) => {
                            document.querySelectorAll('#imoveis-table .row-selector').forEach(chk => chk.checked = e.target.checked);
                            updateContextualBar('imoveis');
                        });
                    }
                    document.querySelectorAll('#imoveis-table .row-selector').forEach(chk => {
                        chk.addEventListener('change', () => updateContextualBar('imoveis'));
                    });

                } else {
                    const shelfContainer = document.getElementById('imoveis-netflix-view');
                    let shelfHTML = '';
                    const propertiesByType = filteredData.reduce((acc, property) => { const type = property.tipo || 'Sem Categoria'; if (!acc[type]) acc[type] = []; acc[type].push(property); return acc; }, {});
                    
                    if(Object.keys(propertiesByType).length === 0) {
                        shelfContainer.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>Nenhum imóvel encontrado.</p><button class="btn btn-primary" onclick="document.getElementById(\'novo-imovel-btn\').click()"><i class="fas fa-plus"></i> Adicionar Imóvel</button></div>';
                        return;
                    }
                    
                    for (const type in propertiesByType) {
                        shelfHTML += `<div class="property-shelf"><h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 10px; padding-left: 5px;">${type}s</h3><div style="display: flex; overflow-x: auto; gap: 20px; padding: 10px 5px 20px 5px;">`;
                        propertiesByType[type].forEach(i => { shelfHTML += `<div class="property-card" style="flex: 0 0 300px;"><div class="property-card-img-wrapper"><img src="${i.fotos?.[0] || 'https://via.placeholder.com/300x180.png?text=Sem+Foto'}" class="property-card-img"></div><div class="property-card-body"><div class="property-card-price">${formatCurrency(i.valor)}</div><h4 class="property-card-title">${i.endereco}</h4><p style="font-size:0.9rem;color:var(--secondary-color);margin-bottom:12px;">Prop: ${i.proprietario || 'N/A'}</p><div class="property-card-details"><span><i class="fas fa-bed"></i> ${i.quartos}</span><span><i class="fas fa-bath"></i> ${i.banheiros}</span><span><i class="fas fa-car"></i> ${i.vagas}</span></div></div><div class="property-card-actions"><i class="fas fa-star favorite-star ${imovelFavoritos.includes(i.id) ? 'favorited' : ''}" onclick="toggleFavorite('${i.id}', event)" title="Adicionar aos Favoritos"></i><button class="btn btn-primary btn-sm" onclick="viewImovelDetails('${i.id}')">Ver Detalhes</button><button class="btn btn-info btn-sm" onclick="editImovel('${i.id}')">Editar</button></div></div>`; });
                        shelfHTML += `</div></div>`;
                    }
                    shelfContainer.innerHTML = shelfHTML;
                }
            };
            document.getElementById('imoveis-view-toggle').addEventListener('click', e => { const btn = e.currentTarget; const compactToggle = document.getElementById('imoveis-compact-view-toggle'); if (imoveisViewMode === 'netflix') { imoveisViewMode = 'table'; document.getElementById('imoveis-table-view-container').style.display = 'block'; document.getElementById('imoveis-netflix-view').style.display = 'none'; compactToggle.style.display = 'inline-flex'; btn.innerHTML = '<i class="fas fa-film"></i> Carrossel'; } else { imoveisViewMode = 'netflix'; document.getElementById('imoveis-table-view-container').style.display = 'none'; document.getElementById('imoveis-netflix-view').style.display = 'block'; compactToggle.style.display = 'none'; btn.innerHTML = '<i class="fas fa-list"></i> Tabela'; } renderImoveis(); }); 
            
            window.viewImovelDetails = (id) => {
                const imovel = db.imoveis.find(i => i.id === id);
                if (!imovel) return;
                document.getElementById('imovel-details-title').textContent = imovel.endereco;
                const body = document.getElementById('imovel-details-body');
                const footer = document.getElementById('imovel-details-footer');
                
                let galleryHtml = '';
                (imovel.fotos || []).forEach((foto, index) => {
                    galleryHtml += `<img src="${foto}" class="${index === 0 ? 'active' : ''}" onclick="changeDetailImage(this, '${foto}')">`;
                });

                let clientesCompativeisHtml = '<p>Nenhum cliente compatível encontrado.</p>';
                const clientesCompativeis = findMatchingClients(imovel);
                if(clientesCompativeis.length > 0) {
                    clientesCompativeisHtml = '<div class="matching-list">';
                    clientesCompativeis.forEach(cliente => {
                        clientesCompativeisHtml += `<div class="matching-item" onclick="openDossie('${cliente.id}')"><strong>${cliente.nome || cliente.razaoSocial}</strong><span>${cliente.telefone || cliente.email}</span></div>`;
                    });
                    clientesCompativeisHtml += '</div>';
                }

                let visitsHtml = '';
                const visits = db.events.filter(e => e.imovelId === id).sort((a,b) => new Date(b.date) - new Date(a.date));
                if (visits.length > 0) {
                    visits.forEach(visit => {
                        const cliente = db.clientes.find(c => c.id === visit.clienteId);
                        visitsHtml += `
                            <div class="note-item">
                                <div class="note-item-meta">
                                    <strong>${new Date(visit.date + 'T00:00:00').toLocaleDateString('pt-BR')} ${visit.time ? `às ${visit.time}`: ''}</strong>
                                    - ${cliente ? `Cliente: ${cliente.nome || cliente.razaoSocial}` : 'Sem cliente vinculado'}
                                </div>
                                <div>${visit.title}: ${visit.description || 'Sem detalhes.'}</div>
                            </div>`;
                    });
                } else {
                    visitsHtml = '<p>Nenhuma visita registrada para este imóvel.</p>';
                }

                body.innerHTML = `
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">
                        <div>
                             <img src="${imovel.fotos?.[0] || 'https://via.placeholder.com/800x400.png?text=Sem+Foto'}" id="imovel-detail-main-img" style="width:100%; height: 400px; object-fit: cover; border-radius: var(--border-radius-sm); margin-bottom: 15px; background-color: var(--bg-color);">
                            <div class="detail-modal-gallery">${galleryHtml}</div>
                        </div>
                        <div>
                             <h3 style="color:var(--primary-color); font-size: 2rem; margin: 0 0 15px 0;">${formatCurrency(imovel.valor)}</h3>
                            <p><strong>Tipo:</strong> ${imovel.tipo} | <strong>Status:</strong> ${imovel.status}</p>
                            <div class="property-card-details" style="border:none; padding: 0; margin-top:15px; font-size:1rem; flex-direction: column; align-items: flex-start; gap: 8px;">
                                <span><i class="fas fa-bed"></i> ${imovel.quartos} Quartos</span>
                                <span><i class="fas fa-bath"></i> ${imovel.banheiros} Banheiros</span>
                                <span><i class="fas fa-ruler-combined"></i> ${imovel.suites} Suítes</span>
                                <span><i class="fas fa-car"></i> ${imovel.vagas} Vagas</span>
                            </div>
                            <hr style="margin: 20px 0;">
                            <h4 style="margin-top:20px; margin-bottom: 10px;"><i class="fas fa-magic"></i> Clientes Compatíveis</h4>
                            ${clientesCompativeisHtml}
                        </div>
                    </div>
                    <hr style="margin: 20px 0;">
                    <div class="dossie-section">
                        <h4><i class="fas fa-calendar-check"></i> Histórico de Visitas</h4>
                        <div id="imovel-visits-history" style="max-height: 250px; overflow-y: auto;">${visitsHtml}</div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Descrição</h4>
                        <p>${imovel.descricao || 'Nenhuma descrição informada.'}</p>
                    </div>
                `;
                const isFavorited = imovelFavoritos.includes(id);
                footer.innerHTML = `
                <button class="btn ${isFavorited ? 'btn-warning' : 'btn-outline-primary'}" id="detail-favorite-btn"><i class="fas fa-star"></i> ${isFavorited ? 'Favoritado' : 'Favoritar'}</button>
                    <button class="btn btn-success" id="detail-share-btn"><i class="fas fa-share-alt"></i> Compartilhar</button>
                    <button class="btn btn-secondary close-button" data-modal="imovel-details-modal">Fechar</button>
                `;
                footer.querySelector('#detail-favorite-btn').onclick = (e) => toggleFavorite(id, e);
                footer.querySelector('#detail-share-btn').onclick = (e) => shareImovel(id, e);
                footer.querySelector('.close-button').onclick = () => closeModal('imovel-details-modal');

                openModal('imovel-details-modal');
            };

            window.changeDetailImage = (thumb, src) => {
                document.getElementById('imovel-detail-main-img').src = src;
                document.querySelectorAll('.detail-modal-gallery img').forEach(img => img.classList.remove('active'));
                thumb.classList.add('active');
            };

            const renderPublicPropertyPage = (id) => {
                const imovel = db.imoveis.find(i => i.id === id);
                if(!imovel) { document.body.innerHTML = '<h1>Imóvel não encontrado</h1>'; return; }
                const corretor = db.corretores.find(c => c.id === imovel.corretorResponsavelId);
                const whatsappNumber = corretor?.telefone?.replace(/\D/g, '') || '';

                document.getElementById('app-view').style.display = 'none';
                const container = document.getElementById('public-property-view');
                let photosHtml = (imovel.fotos || []).map(src => `<img src="${src}" alt="Foto do imóvel">`).join('');
                container.innerHTML = `<div class="public-page-container"><h1>${imovel.endereco}</h1><p style="color: var(--secondary-color); font-size: 1.1rem; margin-top: 5px;">${imovel.tipo} - ${imovel.status}</p><h2 style="font-size: 2.5rem; color: var(--primary-color); margin: 20px 0;">${formatCurrency(imovel.valor)}</h2><div class="photos">${photosHtml}</div><h3>Descrição</h3><p>${imovel.descricao || 'Nenhuma descrição fornecida.'}</p><hr style="margin: 20px 0; border-color: var(--border-color);"><h3>Características</h3><div style="display:flex; flex-wrap:wrap; gap: 20px; font-size:1.1rem;"><span><i class="fas fa-bed"></i> ${imovel.quartos} Quartos</span><span><i class="fas fa-bath"></i> ${imovel.banheiros}</span><span><i class="fas fa-car"></i> ${imovel.vagas} Vagas</span></div><hr style="margin: 20px 0; border-color: var(--border-color);"><a href="https://wa.me/55${whatsappNumber}?text=Olá! Tenho interesse no imóvel localizado em ${encodeURIComponent(imovel.endereco)}" target="_blank" class="btn btn-success btn-lg" style="width: 100%; margin-top: 20px; font-size: 1.2rem;"><i class="fab fa-whatsapp"></i> Falar com o Corretor</a></div>`;
                container.style.display = 'block';
            };

            const createPostSaleJourney = (clienteId) => {
                const cliente = db.clientes.find(c => c.id === clienteId);
                if (!cliente) return;

                const today = new Date();
                const tasks = [
                    { days: 30,  description: "Ligar para saber da adaptação no novo imóvel" },
                    { days: 180, description: "Solicitar avaliação online (Google, etc.)" },
                    { days: 365, description: "Enviar 'Feliz Aniversário de Casa Nova'" },
                    { days: 730, description: "Contactar para atualização de mercado" }
                ];

                cliente.postSaleTasks = tasks.map(task => {
                    const dueDate = new Date(today);
                    dueDate.setDate(today.getDate() + task.days);
                    return {
                        id: generateId(),
                        description: task.description,
                        dueDate: dueDate.toISOString().split('T')[0],
                        completed: false
                    };
                });
                logActivity('fa-sync-alt', `Jornada Pós-Venda iniciada para ${cliente.nome || cliente.razaoSocial}.`);
            };

            window.completePostSaleTask = (clienteId, taskId) => {
                const cliente = db.clientes.find(c => c.id === clienteId);
                if (!cliente || !cliente.postSaleTasks) return;
                const taskIndex = cliente.postSaleTasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    cliente.postSaleTasks[taskIndex].completed = true;
                    logActivity('fa-check-circle', `Tarefa Pós-Venda concluída para ${cliente.nome || cliente.razaoSocial}: "${cliente.postSaleTasks[taskIndex].description}"`);
                    saveDb();
                    renderDashboard();
                    openDossie(clienteId);
                    showNotification('Tarefa de Pós-Venda concluída!', 'success');
                }
            };

            const renderKanbanBoard = () => {
                const board = document.getElementById('kanban-board');
                if(!board) return;
                board.innerHTML = '';
                Object.keys(db.config.funnelStages).forEach(stageKey => {
                    const stageName = db.config.funnelStages[stageKey];
                    const clientsInStage = db.clientes.filter(c => (c.funnelStage || 'lead') === stageKey);
                    let cardsHtml = '';
                    let stageTotalValue = 0;
                    
                    clientsInStage.forEach(cliente => {
                        const imovel = cliente.propertyOfInterestId ? db.imoveis.find(i => i.id === cliente.propertyOfInterestId) : null;
                        const dealValue = imovel ? parseCurrency(imovel.valor) : 0;
                        stageTotalValue += dealValue;

                        let cardClass = "kanban-card";
                        if (cliente.funnelStageLastUpdated) {
                            const lastUpdate = new Date(cliente.funnelStageLastUpdated);
                            const daysDiff = (new Date() - lastUpdate) / (1000 * 3600 * 24);
                            if (daysDiff > 15) { 
                                cardClass += " stagnated-card";
                            }
                        }

                        cardsHtml += `
                            <div class="${cardClass}" data-id="${cliente.id}" onclick="openDossie('${cliente.id}')">
                                <strong>${cliente.nome || cliente.razaoSocial}</strong>
                                <small>${cliente.email}</small>
                                ${imovel ? `<div class="kanban-card-deal"><i class="fas fa-home"></i> ${formatCurrency(dealValue)}</div>` : ''}
                            </div>`;
                    });

                    const column = document.createElement('div');
                    column.className = 'kanban-column';
                    column.dataset.stage = stageKey;
                    column.innerHTML = `
                        <div class="kanban-column-header">
                            <span class="kanban-stage-title">${stageName}</span>
                            <span class="kanban-stage-count">${clientsInStage.length}</span>
                            <div class="kanban-stage-total">${formatCurrency(stageTotalValue)}</div>
                        </div>
                        <div class="kanban-cards" data-stage="${stageKey}">${cardsHtml || '<div class="empty-state" style="padding:20px 10px; font-size:0.9rem;"><i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px;"></i><p>Arraste uma oportunidade para cá.</p></div>'}</div>`;
                    
                    board.appendChild(column);

                    new Sortable(column.querySelector('.kanban-cards'), {
                        group: 'kanban',
                        animation: 150,
                        onEnd: (evt) => {
                            const clienteId = evt.item.dataset.id;
                            const newStage = evt.to.dataset.stage;
                            const cliente = db.clientes.find(c => c.id === clienteId);
                            if (cliente && newStage) {
                                const oldStage = cliente.funnelStage || 'lead';
                                cliente.funnelStage = newStage;
                                cliente.funnelStageLastUpdated = new Date().toISOString(); 
                                logActivity('fa-random', `Cliente ${cliente.nome || cliente.razaoSocial} movido para "${db.config.funnelStages[newStage]}" no funil.`);
                                
                                if (newStage === 'won' && oldStage !== 'won') {
                                    if(confirm(`A comissão da venda para "${cliente.nome || cliente.razaoSocial}" foi recebida?`)) {
                                        cliente.commissionPaid = true;
                                    } else {
                                        cliente.commissionPaid = false;
                                        showNotification(`Pendência de comissão criada para ${cliente.nome || cliente.razaoSocial}.`, 'info');
                                    }
                                    createPostSaleJourney(cliente.id);
                                }

                                saveDb();
                                renderKanbanBoard(); 
                                renderDashboard();
                                showNotification(`Oportunidade movida para ${db.config.funnelStages[newStage]}`, 'info');
                            }
                        }
                    });
                });
            };

            const corretorForm = document.getElementById('corretor-form');
            document.getElementById('novo-corretor-btn').addEventListener('click', () => { 
                corretorForm.reset(); 
                corretorForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                document.querySelector('#corretor-form [name="id"]').value = ''; 
                document.getElementById('corretor-modal-title').innerHTML = '<i class="fas fa-user-tie"></i> Novo Corretor';
                ['docId', 'docCreci', 'docContrato'].forEach(doc => renderAttachmentInForm(doc, 'corretor', null));
                openModal('corretor-modal'); 
            });
            corretorForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(corretorForm, 'corretores', renderCorretores); });
            
            window.editCorretor = id => { 
                const c = db.corretores.find(c => c.id === id); if (!c) return; 
                corretorForm.reset(); 
                corretorForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                document.getElementById('corretor-modal-title').innerHTML = `<i class="fas fa-edit"></i> Editar Corretor`; 
                Object.keys(c).forEach(key => { 
                    const el = document.querySelector(`#corretor-form [name="${key}"]`); 
                    if (el && typeof c[key] === 'string') { el.value = c[key]; }
                }); 
                document.querySelector('#corretor-form [name="cpf"]').value = c.cpf ? maskCPF(c.cpf) : '';
                document.querySelector('#corretor-form [name="telefone"]').value = c.telefone ? maskPhone(c.telefone) : '';
                ['docId', 'docCreci', 'docContrato'].forEach(doc => renderAttachmentInForm(doc, 'corretor', c[doc])); 
                openModal('corretor-modal'); 
            }; 
            
            ['docId', 'docCreci', 'docContrato'].forEach(doc => setupAttachmentHandler(doc, 'corretor'));
            document.querySelector('#corretor-form [name="cpf"]').addEventListener('input', (e) => applyMask(e, maskCPF));
            document.querySelector('#corretor-form [name="telefone"]').addEventListener('input', (e) => applyMask(e, maskPhone));
            
            const populateContractTypeSelect = () => {
                const select = document.getElementById('contrato-tipo-select');
                select.innerHTML = '<option value="">Selecione...</option>';
                for (const key in db.config.contractTypes) {
                    select.innerHTML += `<option value="${key}">${db.config.contractTypes[key]}</option>`;
                }
            };
            
            document.getElementById('novo-contrato-btn').addEventListener('click', () => { 
                const form = document.getElementById('contrato-form');
                form.reset(); 
                form.querySelector('[name="id"]').value = ''; 
                document.getElementById('contrato-modal-title').textContent = 'Novo Contrato'; 
                populateSelect('#contrato-form [name="clienteId"]', db.clientes, 'nome', 'id'); 
                populateSelect('#contrato-form [name="imovelId"]', db.imoveis, 'endereco', 'id'); 
                populateSelect('#contrato-form [name="corretorId"]', db.corretores, 'nome', 'id'); 
                populateContractTypeSelect();
                populateSelect('#contrato-template-select', [], 'name', 'id', 'Selecione um tipo de contrato primeiro...');
                document.getElementById('generate-contract-from-template-btn').disabled = true;
                ['locacao-fields', 'corretagem-fields', 'proposta-fields'].forEach(id => document.getElementById(id).style.display = 'none');
                openModal('contrato-modal'); 
            }); 
            document.getElementById('contrato-form').addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(document.getElementById('contrato-form'), 'contratos', renderContratos); });
            window.editContrato = id => { 
                const c = db.contratos.find(c => c.id === id); if(!c) return; 
                const form = document.getElementById('contrato-form'); 
                form.reset(); 
                document.getElementById('contrato-modal-title').textContent = 'Editar Contrato'; 
                populateSelect('#contrato-form [name="clienteId"]', db.clientes, 'nome', 'id'); 
                populateSelect('#contrato-form [name="imovelId"]', db.imoveis, 'endereco', 'id'); 
                populateSelect('#contrato-form [name="corretorId"]', db.corretores, 'nome', 'id'); 
                populateContractTypeSelect();
                
                Object.keys(c).forEach(key => { 
                    const el = form.querySelector(`[name="${key}"]`); 
                    if(el) {
                        if(el.classList.contains('currency-input')){
                            el.value = c[key] ? formatCurrency(c[key]).replace('R$', '').trim() : '';
                        } else {
                            el.value = c[key]; 
                        }
                    }
                }); 
                
                const tipoSelect = form.querySelector('[name="tipo"]');
                const event = new Event('change', { bubbles: true });
                tipoSelect.dispatchEvent(event);
                
                openModal('contrato-modal'); 
            }; 
            
            const numeroParaExtenso = (numero) => {
                const unidades = ["", "um", "dois", "três", "quatro", "cinco", "seis", "sete", "oito", "nove"];
                const especiais = ["dez", "onze", "doze", "treze", "quatorze", "quinze", "dezesseis", "dezessete", "dezoito", "dezenove"];
                const dezenas = ["", "", "vinte", "trinta", "quarenta", "cinquenta", "sessenta", "setenta", "oitenta", "noventa"];
                const centenas = ["", "cento", "duzentos", "trezentos", "quatrocentos", "quinhentos", "seiscentos", "setecentos", "oitocentos", "novecentos"];

                const getExtenso = (numStr) => {
                    if (numStr === "0") return "";
                    if (numStr === "100") return "cem";
                    let partes = [];
                    let num = parseInt(numStr.padStart(3, '0'), 10);
                    let c = Math.floor(num / 100);
                    let d = Math.floor((num % 100) / 10);
                    let u = num % 10;

                    if (c > 0) partes.push(centenas[c]);
                    if (d === 1) {
                        partes.push(especiais[u]);
                    } else {
                        if (d > 1) partes.push(dezenas[d]);
                        if (u > 0) partes.push(unidades[u]);
                    }
                    return partes.join(" e ");
                };

                let [reaisStr, centavosStr] = String(Number(numero).toFixed(2)).split('.');
                if (!reaisStr || !centavosStr) return "valor inválido";

                let partesReais = [];
                if (reaisStr !== "0") {
                    let pedacos = [];
                    let temp = reaisStr;
                    while(temp.length > 3) {
                        pedacos.unshift(temp.slice(-3));
                        temp = temp.slice(0, -3);
                    }
                    pedacos.unshift(temp);
                    
                    const milhares = ["", "mil", "milhão", "bilhão", "trilhão"];
                    const milharesPlural = ["", "mil", "milhões", "bilhões", "trilhões"];

                    for (let i = 0; i < pedacos.length; i++) {
                        let parteNum = parseInt(pedacos[i], 10);
                        if (parteNum > 0) {
                            let parteExtenso = getExtenso(pedacos[i]);
                            let pos = pedacos.length - 1 - i;
                            if (pos > 0) {
                                parteExtenso += " " + (parteNum > 1 ? milharesPlural[pos] : milhares[pos]);
                            }
                            partesReais.push(parteExtenso);
                        }
                    }
                }
                
                let resFinal = "";
                if (partesReais.length > 0) {
                    resFinal = partesReais.join(", ");
                    let reais = parseInt(reaisStr, 10);
                    resFinal += (reais > 1 ? " reais" : " real");
                }

                let centavos = parseInt(centavosStr, 10);
                if (centavos > 0) {
                    if (resFinal) resFinal += " e ";
                    resFinal += getExtenso(centavosStr);
                    resFinal += (centavos > 1 ? " centavos" : " centavo");
                }
                
                return resFinal || "zero reais";
            };

            const getMissingInfoPlaceholder = () => `<span class="missing-info-highlight">[INFORMAÇÃO PENDENTE]</span>`;
            
            const generateContractHTML = (contrato, template) => { 
                const cliente = db.clientes.find(cli => cli.id === contrato.clienteId); 
                const imovel = db.imoveis.find(imv => imv.id === contrato.imovelId); 
                const corretor = db.corretores.find(cor => cor.id === contrato.corretorId); 
                
                if (!contrato || !cliente || !imovel) { showNotification('Dados incompletos para gerar contrato. Cliente ou imóvel pode ter sido excluído.', 'error'); return null; }
                
                let content = template.content;
                const now = new Date();
                const dataExtenso = now.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                
                const replacements = {
                    '{{cliente.nome}}': cliente.nome || getMissingInfoPlaceholder(),
                    '{{cliente.cpf}}': cliente.cpf ? maskCPF(cliente.cpf) : getMissingInfoPlaceholder(),
                    '{{cliente.rg}}': cliente.rg || getMissingInfoPlaceholder(),
                    '{{cliente.email}}': cliente.email || getMissingInfoPlaceholder(),
                    '{{cliente.telefone}}': cliente.telefone ? maskPhone(cliente.telefone) : getMissingInfoPlaceholder(),
                    '{{cliente.estadoCivil}}': cliente.estadoCivil || getMissingInfoPlaceholder(),
                    '{{cliente.profissao}}': cliente.profissao || getMissingInfoPlaceholder(),
                    '{{cliente.enderecoCompleto}}': `${cliente.rua || ''}, ${cliente.numero || ''}, ${cliente.complemento || ''} - ${cliente.bairro || ''}, ${cliente.cidade || ''}/${cliente.estado || ''}`.replace(/, ,/g, ','),
                    
                    '{{imovel.endereco}}': imovel.endereco || getMissingInfoPlaceholder(),
                    '{{imovel.tipo}}': imovel.tipo || getMissingInfoPlaceholder(),
                    '{{imovel.valor}}': formatCurrency(imovel.valor),
                    '{{imovel.proprietario}}': imovel.proprietario || getMissingInfoPlaceholder(),
                    '{{imovel.empreendimento}}': imovel.empreendimento || getMissingInfoPlaceholder(),
                    '{{imovel.quadra}}': imovel.quadra || getMissingInfoPlaceholder(),
                    '{{imovel.lote}}': imovel.lote || getMissingInfoPlaceholder(),
                    '{{imovel.area}}': imovel.area || getMissingInfoPlaceholder(),

                    '{{corretor.nome}}': corretor?.nome || getMissingInfoPlaceholder(),
                    '{{corretor.creci}}': corretor?.creci || getMissingInfoPlaceholder(),
                    '{{corretor.cpf}}': corretor?.cpf ? maskCPF(corretor.cpf) : getMissingInfoPlaceholder(),

                    '{{contrato.numero}}': contrato.numero || getMissingInfoPlaceholder(),
                    '{{contrato.dataInicio}}': contrato.dataInicio ? new Date(contrato.dataInicio + 'T00:00:00').toLocaleDateString('pt-BR') : getMissingInfoPlaceholder(),
                    '{{contrato.dataFinal}}': contrato.dataFinal ? new Date(contrato.dataFinal + 'T00:00:00').toLocaleDateString('pt-BR') : getMissingInfoPlaceholder(),
                    '{{contrato.valorHonorarios}}': contrato.valorHonorarios ? formatCurrency(parseCurrency(contrato.valorHonorarios)) : getMissingInfoPlaceholder(),

                    '{{proposta.valorSinal}}': contrato.proposta_valorSinal ? formatCurrency(parseCurrency(contrato.proposta_valorSinal)) : getMissingInfoPlaceholder(),
                    '{{proposta.valorParcelado}}': contrato.proposta_valorParcelado ? formatCurrency(parseCurrency(contrato.proposta_valorParcelado)) : getMissingInfoPlaceholder(),
                    '{{proposta.dataPagamentoSinal}}': contrato.proposta_dataPagamentoSinal ? new Date(contrato.proposta_dataPagamentoSinal + 'T00:00:00').toLocaleDateString('pt-BR') : getMissingInfoPlaceholder(),
                    '{{proposta.indiceCorrecao}}': contrato.proposta_indiceCorrecao || getMissingInfoPlaceholder(),
                    
                    '{{data.extenso}}': dataExtenso,
                    '{{data.dia}}': now.getDate(),
                    '{{data.mes}}': now.toLocaleString('pt-BR', {month: 'long'}),
                    '{{data.ano}}': now.getFullYear(),
                };

                for(const placeholder in replacements) {
                    content = content.replace(new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), replacements[placeholder]);
                }
                
                return content;
            };

            document.getElementById('generate-contract-from-template-btn').addEventListener('click', () => {
                const form = document.getElementById('contrato-form');
                const templateId = form.querySelector('#contrato-template-select').value;
                const template = db.contractTemplates.find(t => t.id === templateId);

                if (!template) {
                    showNotification('Por favor, selecione um modelo de contrato.', 'error');
                    return;
                }
                
                const tempContrato = {};
                new FormData(form).forEach((value, key) => tempContrato[key] = value);

                const htmlContent = generateContractHTML(tempContrato, template);
                if (!htmlContent) return;

                document.getElementById('contrato-viewer-body').innerHTML = `<div id="contract-to-print" class="contract-template-container">${htmlContent}</div>`; 
                document.getElementById('download-contrato-pdf-btn').onclick = () => generatePdf('contract-to-print', `Contrato_${tempContrato.numero}.pdf`, 'PDF do contrato gerado!'); 
                openModal('view-contrato-modal');
            });

            const generatePdf = (elementId, filename, notificationMessage) => { const content = document.getElementById(elementId); html2canvas(content, { scale: 2 }).then(canvas => { const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'pt', 'a4'); const imgData = canvas.toDataURL('image/png'); const { width, height } = doc.internal.pageSize; const imgProps = doc.getImageProperties(imgData); const pdfWidth = width; const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; let position = 0; doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight); position = pdfHeight - height; while (position > 0) { doc.addPage(); doc.addImage(imgData, 'PNG', 0, -position + height, pdfWidth, pdfHeight); position -= height; } doc.save(filename); if (notificationMessage) showNotification(notificationMessage, 'success'); }); }; 

            const renderCalendar = () => { const container = document.getElementById('calendar-container'); if (!container) return; const y = currentDate.getFullYear(), m = currentDate.getMonth(); document.getElementById('current-month-year').textContent = new Date(y, m).toLocaleString('pt-BR', { month: 'long', year: 'numeric' }); renderGridView(y, m); renderListView(); }; 
            const renderGridView = (y, m) => { const g = document.getElementById('calendar-grid-view'); let gridHtml = '<div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div><div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div><div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div><div class="calendar-day-header">Sáb</div>'; const firstDay = new Date(y, m, 1).getDay(); const lastDate = new Date(y, m + 1, 0).getDate(); for (let i = 0; i < firstDay; i++) gridHtml += '<div></div>'; for (let day = 1; day <= lastDate; day++) { const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; let dayHtml = `<div class="calendar-day" data-date="${dStr}"><span class="day-number">${day}</span>`; const today = new Date(); if (day === today.getDate() && m === today.getMonth() && y === today.getFullYear()) dayHtml = dayHtml.replace('calendar-day', 'calendar-day today'); db.events.filter(e => e.date === dStr).forEach(ev => { dayHtml += `<div class="calendar-event" data-id="${ev.id}">${ev.title}</div>`; }); dayHtml += '</div>'; gridHtml += dayHtml; } g.innerHTML = gridHtml; }; 
            const renderListView = () => { const listBody = document.querySelector('#calendar-list-view tbody'); let listHtml = ''; const monthEvents = db.events.filter(e => new Date(e.date).getMonth() === currentDate.getMonth() && new Date(e.date).getFullYear() === currentDate.getFullYear()).sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time)); if (monthEvents.length === 0) { const cols = listBody.closest('table').querySelectorAll('thead th').length; listBody.innerHTML = `<tr><td colspan="${cols}"><div class="empty-state" style="padding: 20px;"><p>Nenhum evento para este mês.</p></div></td></tr>`; } else { monthEvents.forEach(ev => { listHtml += `<tr data-id="${ev.id}"><td>${new Date(ev.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td><td>${ev.time || 'Dia todo'}</td><td>${ev.title}</td></tr>`; }); listBody.innerHTML = listHtml; } }; 
            
            const setupCalendarEventListeners = () => {
                document.getElementById('calendar-container').addEventListener('click', (e) => {
                    const dayTarget = e.target.closest('.calendar-day');
                    const eventTarget = e.target.closest('.calendar-event');
                    const eventRowTarget = e.target.closest('#calendar-list-view tbody tr');

                    if (eventTarget) {
                        e.stopPropagation();
                        openEventModal(eventTarget.dataset.id);
                    } else if (eventRowTarget) {
                        openEventModal(eventRowTarget.dataset.id);
                    } else if (dayTarget) {
                        openEventModal(null, dayTarget.dataset.date);
                    }
                });
            };
            
            document.getElementById('prev-month-btn').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }; 
            document.getElementById('next-month-btn').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }; 
            document.getElementById('grid-view-btn').onclick = () => { document.getElementById('calendar-grid-view').style.display = 'grid'; document.getElementById('calendar-list-view').style.display = 'none'; }; 
            document.getElementById('list-view-btn').onclick = () => { document.getElementById('calendar-grid-view').style.display = 'none'; document.getElementById('calendar-list-view').style.display = 'block'; }; 
            
            const openEventModal = (id, date = null) => { 
                const form = document.getElementById('event-form'); 
                form.reset(); 
                const delBtn = document.getElementById('delete-event-btn'); 
                delBtn.style.display = 'none'; 
                
                populateSelect('#event-clienteId', db.clientes, 'nome', 'id', 'Nenhum cliente...');
                populateSelect('#event-imovelId', db.imoveis, 'endereco', 'id', 'Nenhum imóvel...');

                if (id) { 
                    const ev = db.events.find(e => e.id === id); 
                    document.getElementById('event-modal-title').textContent = 'Editar Evento'; 
                    ['id', 'date', 'time', 'title', 'description', 'clienteId', 'imovelId'].forEach(f => { 
                        const el = document.getElementById(`event-${f}`); 
                        if (el) el.value = ev[f] || ''; 
                    }); 
                    delBtn.style.display = 'inline-flex'; 
                    delBtn.onclick = () => { if (confirm('Excluir este evento?')) { db.events = db.events.filter(e => e.id !== id); logActivity('fa-calendar-times', `Evento removido: ${ev.title}`); saveDb(); renderCalendar(); closeModal('event-modal'); showNotification('Evento excluído.', 'info'); } }; 
                } else { 
                    document.getElementById('event-modal-title').textContent = 'Novo Evento'; 
                    document.getElementById('event-id').value = ''; 
                    document.getElementById('event-date').value = date; 
                } 
                openModal('event-modal'); 
            };
            
            document.getElementById('event-form').addEventListener('submit', e => { 
                e.preventDefault(); 
                const id = document.getElementById('event-id').value; 
                const evData = { 
                    id: id || generateId(), 
                    date: document.getElementById('event-date').value, 
                    time: document.getElementById('event-time').value, 
                    title: document.getElementById('event-title').value, 
                    description: document.getElementById('event-description').value, 
                    clienteId: document.getElementById('event-clienteId').value,
                    imovelId: document.getElementById('event-imovelId').value,
                    notified10min: false, 
                    notified30min: false 
                }; 
                if (id) { 
                    const index = db.events.findIndex(e => e.id === id); 
                    if(index > -1) db.events[index] = {...db.events[index], ...evData}; 
                    showNotification('Evento atualizado com sucesso!'); 
                } else { 
                    db.events.push(evData); 
                    logActivity('fa-calendar-check', `Novo evento: ${evData.title}`); 
                    showNotification('Evento criado com sucesso!'); 
                } 
                saveDb(); 
                renderCalendar(); 
                closeModal('event-modal'); 
            });
            
            const checkUpcomingEvents = () => {
                const now = new Date();
                db.events.forEach((event, index) => {
                    if (event.date && event.time) {
                        const eventDateTime = new Date(`${event.date}T${event.time}`);
                        const diffMinutes = (eventDateTime - now) / (1000 * 60);

                        if (diffMinutes > 10 && diffMinutes <= 30 && !event.notified30min) {
                            showNotification(`Lembrete: Seu compromisso "${event.title}" é em 30 minutos.`, 'info');
                            db.events[index].notified30min = true;
                            saveDb();
                            if (document.getElementById('dashboard').classList.contains('active')) { renderActionableItems(); }
                        } 
                        else if (diffMinutes > 0 && diffMinutes <= 10 && !event.notified10min) {
                            showNotification(`Atenção: Seu compromisso "${event.title}" começa em 10 minutos.`, 'warning');
                            db.events[index].notified10min = true;
                            saveDb();
                            if (document.getElementById('dashboard').classList.contains('active')) { renderActionableItems(); }
                        }
                    }
                });
            };

            const setupTabNav = (navSelector, contentSelector) => { document.querySelectorAll(navSelector).forEach(btn => { btn.addEventListener('click', (e) => { e.preventDefault(); const parentNav = btn.closest('.simulation-nav'); parentNav.querySelectorAll('.btn').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline-primary'); }); btn.classList.add('btn-primary'); btn.classList.remove('btn-outline-primary'); const targetId = btn.dataset.target; document.querySelectorAll(contentSelector).forEach(content => { content.classList.remove('active'); }); document.querySelector(targetId).classList.add('active'); }); }); };
            setupTabNav('.simulation-nav .btn', '.simulation-content');
            document.getElementById('financiamento-form').addEventListener('submit', (e) => { e.preventDefault(); const i = { valorImovel: parseCurrency(document.getElementById('fin-valor-imovel').value), valorEntrada: parseCurrency(document.getElementById('fin-valor-entrada').value), taxaAnual: parseFloat(document.getElementById('fin-taxa-juros').value), prazoAnos: parseInt(document.getElementById('fin-prazo-anos').value, 10), taxaCorrecao: parseFloat(document.getElementById('fin-taxa-correcao').value) }; if (!(i.valorImovel > 0 && i.valorEntrada >= 0 && i.taxaAnual > 0 && i.prazoAnos > 0 && i.valorImovel > i.valorEntrada)) { showNotification('Por favor, preencha todos os campos com valores válidos.', 'error'); return; } const valorFinanciado = i.valorImovel - i.valorEntrada; const taxaMensal = (i.taxaAnual / 100) / 12; const numParcelas = i.prazoAnos * 12; const parcelaPrice = valorFinanciado * (taxaMensal * Math.pow(1 + taxaMensal, numParcelas)) / (Math.pow(1 + taxaMensal, numParcelas) - 1); const totalPagoPrice = parcelaPrice * numParcelas; document.getElementById('price-res-parcela').textContent = formatCurrency(parcelaPrice); document.getElementById('price-res-total-pago').textContent = formatCurrency(totalPagoPrice + i.valorEntrada); document.getElementById('price-res-total-juros').textContent = formatCurrency(totalPagoPrice - valorFinanciado); const amortizacao = valorFinanciado / numParcelas; const primeiraParcelaSAC = amortizacao + (valorFinanciado * taxaMensal); const ultimaParcelaSAC = amortizacao + (amortizacao * taxaMensal); const totalJurosSAC = ((valorFinanciado * taxaMensal) + (amortizacao * taxaMensal)) / 2 * numParcelas; document.getElementById('sac-res-primeira-parcela').textContent = formatCurrency(primeiraParcelaSAC); document.getElementById('sac-res-ultima-parcela').textContent = formatCurrency(ultimaParcelaSAC); document.getElementById('sac-res-total-pago').textContent = formatCurrency(valorFinanciado + totalJurosSAC + i.valorEntrada); document.getElementById('sac-res-total-juros').textContent = formatCurrency(totalJurosSAC); const parcelaAno1 = primeiraParcelaSAC; const saldoDevedorAno2 = valorFinanciado - (amortizacao * 12); const saldoCorrigidoAno2 = saldoDevedorAno2 * (1 + (i.taxaCorrecao/100)); const parcelaAno2 = (saldoCorrigidoAno2 / (numParcelas - 12)) + (saldoCorrigidoAno2 * taxaMensal); const totalEstimadoGradiente = (valorFinanciado + totalJurosSAC) * (1 + (i.taxaCorrecao/100) * (i.prazoAnos/2.5)); document.getElementById('grad-res-parcela-ano1').textContent = `~ ${formatCurrency(parcelaAno1)}`; document.getElementById('grad-res-parcela-ano2').textContent = `~ ${formatCurrency(parcelaAno2)}`; document.getElementById('grad-res-total-pago').textContent = `~ ${formatCurrency(totalEstimadoGradiente + i.valorEntrada)}`; document.getElementById('financiamento-resultados-wrapper').style.display = 'block'; populateSelect('#fin-sim-cliente-select', db.clientes, 'nome', 'id', 'Selecione um cliente...'); showNotification('Simulação de financiamento concluída.', 'success'); });
            
            document.getElementById('lote-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const valorLote = parseCurrency(document.getElementById('lote-valor').value); 
                const valorEntrada = parseCurrency(document.getElementById('lote-entrada').value); 
                const valorCorretagem = parseCurrency(document.getElementById('lote-corretagem').value);
                const numParcelas = parseInt(document.getElementById('lote-parcelas').value, 10); 

                if (!(valorLote > 0 && valorEntrada >= 0 && numParcelas > 0 && valorLote > (valorEntrada + valorCorretagem) )) { 
                    showNotification('Valores inválidos. O valor do lote deve ser maior que a soma da entrada e corretagem.', 'error'); 
                    return; 
                } 
                const valorAParcelar = valorLote - valorEntrada - valorCorretagem; 
                const valorParcela = valorAParcelar / numParcelas; 
                const dataInicio = new Date(); dataInicio.setMonth(dataInicio.getMonth() + 1); 
                const dataFim = new Date(dataInicio); dataFim.setMonth(dataFim.getMonth() + numParcelas - 1); 
                document.getElementById('lote-res-saldo').textContent = formatCurrency(valorAParcelar); 
                document.getElementById('lote-res-parcela').textContent = formatCurrency(valorParcela); 
                document.getElementById('lote-res-data-inicio').textContent = dataInicio.toLocaleDateString('pt-BR'); 
                document.getElementById('lote-res-data-fim').textContent = dataFim.toLocaleDateString('pt-BR'); 
                document.getElementById('lote-resultados-wrapper').style.display = 'block'; 
                showNotification('Simulação de parcelamento concluída.', 'success');
            });
            
            const comissaoForm = document.getElementById('comissao-form');
            comissaoForm.addEventListener('input', () => { const valorVenda = parseCurrency(document.getElementById('com-valor-venda').value); const percentual = parseFloat(document.getElementById('com-percentual').value); const dividir = document.getElementById('com-dividir-check').checked; const suaPartePerc = parseFloat(document.getElementById('com-sua-parte').value); const resultadoDiv = document.getElementById('comissao-resultado'); const divisaoWrapper = document.getElementById('com-res-divisao-wrapper'); document.getElementById('com-divisao-group').style.display = dividir ? 'block' : 'none'; if (valorVenda > 0 && percentual > 0) { const comissaoTotal = valorVenda * (percentual / 100); document.getElementById('com-res-total').textContent = formatCurrency(comissaoTotal); if (dividir && suaPartePerc >= 0 && suaPartePerc <= 100) { const suaParteValor = comissaoTotal * (suaPartePerc / 100); const parceiroParteValor = comissaoTotal - suaParteValor; document.getElementById('com-res-sua-parte').textContent = formatCurrency(suaParteValor); document.getElementById('com-res-parceiro-parte').textContent = formatCurrency(parceiroParteValor); divisaoWrapper.style.display = 'block'; } else { divisaoWrapper.style.display = 'none'; } resultadoDiv.style.display = 'block'; } else { resultadoDiv.style.display = 'none'; } });

            document.getElementById('report-type').addEventListener('change', e => {
                const imovelSelect = document.getElementById('report-imovel-select-container');
                if(e.target.value === 'locacao') {
                    populateSelect('#report-imovel-select', db.imoveis.filter(i => i.status === 'Alugado'), 'endereco', 'id', 'Selecione um imóvel...');
                    imovelSelect.style.display = 'block';
                } else {
                    imovelSelect.style.display = 'none';
                }
            });

            document.getElementById('report-form').addEventListener('submit', e => { 
                e.preventDefault(); 
                const type = document.getElementById('report-type').value; 
                if(!type) return; 
                const output = document.getElementById('report-output'); 
                const title = document.getElementById('report-title'); 
                const container = document.getElementById('report-table-container'); 
                const summaryContainer = document.getElementById('report-summary'); 
                let headers, data, reportName, summaryHtml = ''; 
                
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;

                switch(type) { 
                    case 'vendas': 
                        reportName = 'Relatório de Vendas'; 
                        headers = ['Data', 'Cliente', 'Imóvel', 'Valor', 'Corretor']; 
                        data = db.contratos.filter(c => c.tipo === 'Venda').map(c => { const cl = db.clientes.find(cli => cli.id === c.clienteId) || {}; const im = db.imoveis.find(imv => imv.id === c.imovelId) || {}; const cr = db.corretores.find(cor => cor.id === c.corretorId) || {}; return [ new Date(c.dataInicio+'T00:00:00').toLocaleDateString('pt-BR'), cl.nome || cl.razaoSocial || 'Excluído', im.endereco || 'Excluído', formatCurrency(parseCurrency(im.valor)), cr.nome || 'N/A' ]; }); 
                        break;
                    case 'locacao':
                        const imovelId = document.getElementById('report-imovel-select').value;
                        if(!imovelId) { showNotification('Por favor, selecione um imóvel para gerar o extrato.', 'error'); return; }
                        const imovel = db.imoveis.find(i => i.id === imovelId) || {};
                        const proprietario = imovel.proprietario || 'N/A';
                        reportName = `Extrato de Locação - ${imovel.endereco}`;
                        headers = ['Data Lanç.', 'Descrição', 'Entrada', 'Saída', 'Saldo'];
                        let saldo = 0;
                        let filteredLancamentos = db.financeiro.filter(f => {
                            let match = f.imovelId === imovelId;
                            if (startDate) match = match && f.data >= startDate;
                            if (endDate) match = match && f.data <= endDate;
                            return match;
                        });
                        data = filteredLancamentos.map(f => {
                            const entrada = f.tipo === 'entrada' ? parseCurrency(f.valor) : 0;
                            const saida = f.tipo === 'saida' ? parseCurrency(f.valor) : 0;
                            saldo += entrada - saida;
                            return [ new Date(f.data+'T00:00:00').toLocaleDateString('pt-BR'), f.descricao, formatCurrency(entrada), formatCurrency(saida), formatCurrency(saldo)];
                        });
                        summaryHtml = `<p><strong>Proprietário:</strong> ${proprietario}</p><h4 style="margin-top:10px;">Saldo do Período: ${formatCurrency(saldo)}</h4>`;
                        break; 
                    case 'imoveis': 
                        reportName = 'Relatório de Imóveis'; 
                        headers = ['Endereço', 'Proprietário', 'Tipo', 'Status', 'Valor']; 
                        data = db.imoveis.map(im => [ im.endereco, im.proprietario || 'N/A', im.tipo, im.status, formatCurrency(parseCurrency(im.valor)) ]); 
                        break; 
                    case 'clientes': 
                        reportName = 'Relatório de Clientes'; 
                        headers = ['Nome / Razão Social', 'CPF/CNPJ', 'Telefone', 'Email']; 
                        data = db.clientes.map(cl => [ cl.nome || cl.razaoSocial, cl.cpf || cl.cnpj, cl.telefone, cl.email ]); 
                        break; 
                    case 'financeiro': 
                        reportName = 'Relatório Financeiro'; 
                        headers = ['Data', 'Descrição', 'Tipo', 'Categoria', 'Valor']; 
                        data = db.financeiro.map(f => [ new Date(f.data+'T00:00:00').toLocaleDateString('pt-BR'), f.descricao, f.tipo, f.categoria, formatCurrency(f.valor) ]); 
                        break; 
                    case 'comissoes': 
                        reportName = 'Relatório de Comissões'; 
                        headers = ['Data', 'Descrição', 'Valor', 'Beneficiário']; 
                        data = db.financeiro.filter(f => f.categoria === 'Comissão de Venda').map(f => [ new Date(f.data+'T00:00:00').toLocaleDateString('pt-BR'), f.descricao, formatCurrency(f.valor), '' ]); 
                        break; 
                } 
                title.textContent = reportName; 
                container.innerHTML = `<table class="table" id="report-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(row => `<tr>${row.map(cell => `<td>${cell || ''}</td>`).join('')}</tr>`).join('')}</tbody></table>`; 
                summaryContainer.innerHTML = summaryHtml; 
                output.style.display = 'block'; 
                showNotification('Relatório gerado com sucesso.', 'success'); 
            });
            document.getElementById('export-report-pdf').addEventListener('click', () => { generatePdf('report-printable-area', `Relatorio_${document.getElementById('report-type').value}.pdf`, 'PDF do relatório exportado!'); });

            const loadConfigForms = () => {
                const configForm = document.getElementById('config-form');
                const goalsForm = document.getElementById('goals-form');
                if(!configForm || !goalsForm) return;
                configForm.querySelector('[name="companyName"]').value = db.config.companyName || '';
                configForm.querySelector('[name="companyCnpj"]').value = db.config.companyCnpj || '';
                goalsForm.querySelector('[name="salesGoal"]').value = db.config.salesGoal > 0 ? formatCurrency(db.config.salesGoal).replace('R$', '').trim() : '';
                goalsForm.querySelector('[name="contractsGoal"]').value = db.config.contractsGoal || '';
            };

            const renderFinanceiro = () => {
                 populateSelect('#financeiro-filter-cliente', db.clientes, 'nome', 'id', 'Filtrar por Cliente...');
                const headers = [ {key: 'data', label: 'Data'}, {key: 'descricao', label: 'Descrição'}, {key: 'clienteId', label: 'Cliente'}, {key: 'valor', label: 'Valor'}, {key: 'actions', label: 'Ações'} ];

                const filterText = document.getElementById('financeiro-filter-text').value.toLowerCase();
                const filterCliente = document.getElementById('financeiro-filter-cliente').value;

                let filteredData = db.financeiro.filter(f => {
                    const textMatch = f.descricao.toLowerCase().includes(filterText);
                    const clienteMatch = !filterCliente || f.clienteId === filterCliente;
                    return textMatch && clienteMatch;
                });

                const financeiroData = filteredData.map(f => {
                    return {...f, valorDisplay: f.tipo === 'entrada' ? formatCurrency(f.valor) : `-${formatCurrency(f.valor)}`};
                });
                setupTableSorting('financeiro', headers);
                renderPaginatedTable('financeiro', financeiroData);

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const monthEntries = db.financeiro.filter(f => {
                    const fDate = new Date(f.data + 'T00:00:00');
                    return fDate.getMonth() === currentMonth && fDate.getFullYear() === currentYear;
                });

                const totalEntradas = monthEntries.filter(f => f.tipo === 'entrada').reduce((sum, f) => sum + f.valor, 0);
                const totalSaidas = monthEntries.filter(f => f.tipo === 'saida').reduce((sum, f) => sum + f.valor, 0);
                const resultadoMes = totalEntradas - totalSaidas;
                const saldoTotal = db.financeiro.reduce((sum, f) => sum + (f.tipo === 'entrada' ? f.valor : -f.valor), 0);

                document.getElementById('fin-entradas-mes').textContent = formatCurrency(totalEntradas);
                document.getElementById('fin-saidas-mes').textContent = formatCurrency(totalSaidas);
                const resultadoEl = document.getElementById('fin-resultado-mes');
                resultadoEl.textContent = formatCurrency(resultadoMes);
                resultadoEl.style.color = resultadoMes >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                document.getElementById('fin-saldo-total').textContent = formatCurrency(saldoTotal);
            };

            const financeiroForm = document.getElementById('financeiro-form');
            document.getElementById('novo-lancamento-btn').addEventListener('click', () => {
                financeiroForm.reset();
                document.querySelector('#financeiro-form [name="id"]').value = '';
                document.getElementById('financeiro-modal-title').textContent = 'Novo Lançamento Financeiro';
                document.querySelector('#financeiro-form [name="data"]').valueAsDate = new Date();
                populateSelect('#financeiro-cliente-select', db.clientes, 'nome', 'id', 'Selecione um cliente...');
                const categorySelect = document.getElementById('financeiro-category-select');
                categorySelect.innerHTML = db.config.financeCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                openModal('financeiro-modal');
            });
            financeiroForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(financeiroForm, 'financeiro', renderFinanceiro); });
            
            window.editFinanceiro = (id) => {
                const item = db.financeiro.find(f => f.id === id);
                if (!item) return;
                document.getElementById('financeiro-modal-title').textContent = 'Editar Lançamento';
                populateSelect('#financeiro-cliente-select', db.clientes, 'nome', 'id', 'Selecione um cliente...');
                const categorySelect = document.getElementById('financeiro-category-select');
                categorySelect.innerHTML = db.config.financeCategories.map(cat => `<option value="${cat}" ${item.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
                
                setTimeout(() => {
                    Object.keys(item).forEach(key => {
                        const el = financeiroForm.querySelector(`[name="${key}"]`);
                        if (el) {
                            if (key === 'valor') el.value = item[key] ? formatCurrency(item.valor).replace('R$', '').trim() : '';
                            else el.value = item[key];
                        }
                    });
                }, 100);
                openModal('financeiro-modal');
            };

            window.generateRecibo = (id) => {
                const item = db.financeiro.find(f => f.id === id);
                if (!item) return;
                const modalBody = document.getElementById('recibo-preview-body');
                modalBody.innerHTML = `<div id="recibo-to-print">${generateReciboHTML(item)}</div>`;

                document.getElementById('download-recibo-pdf-btn').onclick = () => {
                     generatePdf('recibo-to-print', `Recibo_${item.descricao.replace(/\s/g, '_')}.pdf`, 'Recibo gerado com sucesso!');
                     closeModal('recibo-preview-modal');
                };
                openModal('recibo-preview-modal');
            };

            const generateReciboHTML = (item) => {
                const pagador = db.clientes.find(c => c.id === item.clienteId);
                const nomePagador = pagador ? (pagador.nome || pagador.razaoSocial) : '.........................................................................';
                const valorExtenso = numeroParaExtenso(item.valor);
                const hoje = new Date();
                const cidade = 'Nova Serrana';

                return `<div class="contract-template-container" style="font-family: Arial, sans-serif; font-size: 12pt;">
                    <h2 style="text-align:center; margin-bottom: 30px; text-transform: uppercase;">Recibo</h2>
                    <p style="text-align:right; margin-bottom: 30px; font-weight: bold; font-size: 14pt;">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    <p style="line-height: 1.8;">
                        Recebi(emos) de <strong>${nomePagador}</strong>, a quantia de R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} 
                        ( ${valorExtenso} ), 
                        correspondente a <strong>${item.descricao}</strong>, e para clareza firmo(amos) o presente na cidade de ${cidade} no dia ${hoje.toLocaleDateString('pt-BR')}.
                    </p>
                    <div style="width: 70%; text-align: center; margin: 80px auto 0;">
                        <div style="border-top: 1px solid black; padding-top: 5px;">
                             <strong>${db.config.companyName || 'NOME DA EMPRESA'}</strong><br>
                            <span style="font-size: 10pt;">${db.config.companyCnpj || '00.000.000/0001-00'}</span>
                        </div>
                    </div>
                     <div style="width: 70%; text-align: center; margin: 50px auto 0;">
                        <div style="border-top: 1px solid black; padding-top: 5px;">
                            <strong>Assinatura</strong><br>
                            <span style="font-size: 10pt;">${nomePagador}</span>
                        </div>
                    </div>
                </div>`;
            };
            
            const sortData = (data, key, order) => {
                return [...data].sort((a, b) => {
                    let valA = a[key] ?? '';
                    let valB = b[key] ?? '';
                    
                    if (key === 'clienteId') { valA = (db.clientes.find(c => c.id === valA) || {}).nome || ''; valB = (db.clientes.find(c => c.id === valB) || {}).nome || ''; }
                    if (key === 'imovelId') { valA = (db.imoveis.find(i => i.id === valA) || {}).endereco || ''; valB = (db.imoveis.find(i => i.id === valB) || {}).endereco || ''; }

                    if (key === 'valor') {
                        valA = parseCurrency(a.valor);
                        valB = parseCurrency(b.valor);
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    if (valA < valB) return order === 'asc' ? -1 : 1;
                    if (valA > valB) return order === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            const renderPaginatedTable = (module, data) => {
                const state = pageState[module];
                const sortedData = sortData(data, state.sortKey, state.sortOrder);
                
                const tbody = document.getElementById(`${module}-table-body`);
                const paginationContainer = document.getElementById(`${module}-pagination`);
                if (!tbody || !paginationContainer) return;
                
                const totalItems = sortedData.length;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                state.currentPage = Math.min(state.currentPage, totalPages) || 1;
                
                const start = (state.currentPage - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const paginatedData = sortedData.slice(start, end);

                let html = '';
                if (paginatedData.length === 0) {
                    const cols = document.getElementById(`${module}-table-header`).children.length;
                    tbody.innerHTML = `<tr><td colspan="${cols}"><div class="empty-state"><p>Nenhum item encontrado.</p></div></td></tr>`;
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                paginatedData.forEach(item => {
                    switch(module) {
                        case 'clientes':
                            const nomeDisplay = item.tipoPessoa === 'juridica' ? item.razaoSocial : item.nome;
                            const docDisplay = item.tipoPessoa === 'juridica' ? (item.cnpj ? maskCNPJ(item.cnpj) : '') : (item.cpf ? maskCPF(item.cpf) : '');
                            html += `<tr><td><input type="checkbox" class="row-selector" data-id="${item.id}"></td><td>${nomeDisplay}</td><td>${docDisplay}</td><td>${item.telefone ? maskPhone(item.telefone) : ''}</td><td>${item.email}</td><td><div style="display:flex; gap:5px;"><button class="btn btn-primary btn-sm" onclick="openDossie('${item.id}')" title="Ver Dossiê"><i class="fas fa-eye"></i></button><button class="btn btn-info btn-sm" onclick="editCliente('${item.id}')" title="Editar"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm delete-btn" onclick="deleteItem('clientes', '${item.id}', 'renderClientes')" title="Excluir"><i class="fas fa-trash"></i></button></div></td></tr>`;
                            break;
                        case 'imoveis':
                             html += `<tr><td><input type="checkbox" class="row-selector" data-id="${item.id}"></td><td>${item.endereco}</td><td>${item.proprietario || 'N/A'}</td><td>${item.tipo}</td><td>${formatCurrency(item.valor)}</td><td>${item.status}</td><td><div style="display:flex;gap:5px;"><button class="btn btn-primary btn-sm" onclick="viewImovelDetails('${item.id}')" title="Ver Detalhes"><i class="fas fa-search"></i></button><button class="btn btn-info btn-sm" onclick="editImovel('${item.id}')" title="Editar"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm delete-btn" onclick="deleteItem('imoveis', '${item.id}', 'renderImoveis')" title="Excluir"><i class="fas fa-trash"></i></button></div></td></tr>`;
                            break;
                        case 'corretores':
                            html += `<tr><td>${item.nome}</td><td>${item.creci}</td><td>${item.telefone ? maskPhone(item.telefone) : ''}</td><td>${item.email}</td><td><div style="display:flex; gap:5px;"><button class="btn btn-info btn-sm" onclick="editCorretor('${item.id}')" title="Editar"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm delete-btn" onclick="deleteItem('corretores', '${item.id}', 'renderCorretores')" title="Excluir"><i class="fas fa-trash"></i></button></div></td></tr>`;
                            break;
                        case 'contratos':
                            const cl = db.clientes.find(cli => cli.id === item.clienteId) || { nome: '(Excluído)', razaoSocial: '(Excluído)' }; 
                            const im = db.imoveis.find(imv => imv.id === item.imovelId) || { endereco: '(Excluído)' }; 
                            const dt = item.dataInicio ? new Date(item.dataInicio + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'; 
                            html += `<tr><td>${item.numero}</td><td>${db.config.contractTypes[item.tipo] || item.tipo}</td><td>${cl.nome || cl.razaoSocial}</td><td>${im.endereco}</td><td>${dt}</td><td>${item.status}</td><td><div style="display:flex;gap:5px;"><button class="btn btn-info btn-sm" onclick="editContrato('${item.id}')" title="Editar"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm delete-btn" onclick="deleteItem('contratos', '${item.id}', 'renderContratos')" title="Excluir"><i class="fas fa-trash"></i></button></div></td></tr>`; 
                            break;
                        case 'financeiro':
                            const clienteFinanceiro = db.clientes.find(c => c.id === item.clienteId);
                            const nomeCliente = clienteFinanceiro ? (clienteFinanceiro.nome || clienteFinanceiro.razaoSocial) : 'N/A';
                            html += `<tr><td>${new Date(item.data+'T00:00:00').toLocaleDateString('pt-BR')}</td><td>${item.descricao}</td><td>${nomeCliente}</td><td class="${item.tipo === 'entrada' ? 'price-entry' : 'price-exit'}">${item.valorDisplay}</td><td><div style="display:flex; gap:5px;"><button class="btn btn-info btn-sm" onclick="editFinanceiro('${item.id}')" title="Editar"><i class="fas fa-edit"></i></button>${item.tipo === 'entrada' ? `<button class="btn btn-success btn-sm" onclick="generateRecibo('${item.id}')" title="Gerar Recibo"><i class="fas fa-receipt"></i></button>` : ''}<button class="btn btn-danger btn-sm delete-btn" onclick="deleteItem('financeiro', '${item.id}', 'renderFinanceiro')" title="Excluir"><i class="fas fa-trash"></i></button></div></td></tr>`; 
                            break;
                    }
                });
                tbody.innerHTML = html;

                paginationContainer.innerHTML = `
                    <div class="pagination-info">Exibindo ${start + 1}-${Math.min(end, totalItems)} de ${totalItems}</div>
                    <div class="pagination-controls">
                        <button class="btn btn-secondary btn-sm" ${state.currentPage === 1 ? 'disabled' : ''} onclick="changePage('${module}', ${state.currentPage - 1})">Anterior</button>
                        <button class="btn btn-secondary btn-sm" ${state.currentPage >= totalPages ? 'disabled' : ''} onclick="changePage('${module}', ${state.currentPage + 1})">Próximo</button>
                    </div>
                `;
                 if (module === 'clientes' || module === 'imoveis') {
                    updateContextualBar(module);
                }
            };

            window.changePage = (module, newPage) => {
                pageState[module].currentPage = newPage;
                const renderFn = window[`render${module.charAt(0).toUpperCase() + module.slice(1)}`];
                if (renderFn) renderFn();
            };

            const setupTableSorting = (module, headers) => {
                const headerRow = document.getElementById(`${module}-table-header`);
                if (!headerRow) return;
                let headerHTML = '';
                headers.forEach(h => {
                    if (h.key === 'actions') {
                        headerHTML += `<th>${h.label}</th>`;
                    } else if (h.key === 'checkbox') {
                         headerHTML += `<th style="width:20px;">${h.label}</th>`;
                    } else {
                        const sortIcon = (pageState[module].sortKey === h.key) 
                            ? `<span class="sort-indicator">${pageState[module].sortOrder === 'asc' ? '▲' : '▼'}</span>` 
                            : '';
                        headerHTML += `<th data-sort="${h.key}">${h.label} ${sortIcon}</th>`;
                    }
                });
                headerRow.innerHTML = headerHTML;
                
                headerRow.querySelectorAll('th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        const newSortKey = th.dataset.sort;
                        if (pageState[module].sortKey === newSortKey) {
                            pageState[module].sortOrder = pageState[module].sortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            pageState[module].sortKey = newSortKey;
                            pageState[module].sortOrder = 'asc';
                        }
                        pageState[module].currentPage = 1;
                        const renderFn = window[`render${module.charAt(0).toUpperCase() + module.slice(1)}`];
                        if (renderFn) renderFn();
                    });
                });
            };

            window.renderClientes = () => {
                const headers = [ {key: 'checkbox', label: `<input type="checkbox" id="clientes-select-all">`}, {key: 'nome', label: 'Nome / Razão Social'}, {key: 'cpf', label: 'CPF / CNPJ'}, {key: 'telefone', label: 'Telefone'}, {key: 'email', label: 'E-mail'}, {key: 'actions', label: 'Ações'} ];
                setupTableSorting('clientes', headers);
                const filterText = document.getElementById('clientes-filter-text').value.toLowerCase();
                const filterSpc = document.getElementById('clientes-filter-spc').value;
                const filteredData = db.clientes.filter(c => ((c.nome || '').toLowerCase().includes(filterText) || (c.razaoSocial || '').toLowerCase().includes(filterText) || (c.cpf || '').includes(filterText) || (c.cnpj || '').includes(filterText) || (c.email || '').toLowerCase().includes(filterText)) && (!filterSpc || c.spc === filterSpc));
                renderPaginatedTable('clientes', filteredData);
                
                const selectAll = document.getElementById('clientes-select-all');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        document.querySelectorAll('#clientes-table .row-selector').forEach(chk => chk.checked = e.target.checked);
                        updateContextualBar('clientes');
                    });
                }
                document.querySelectorAll('#clientes-table .row-selector').forEach(chk => {
                    chk.addEventListener('change', () => updateContextualBar('clientes'));
                });
            };

            window.renderCorretores = () => {
                const headers = [ {key: 'nome', label: 'Nome'}, {key: 'creci', label: 'CRECI'}, {key: 'telefone', label: 'Telefone'}, {key: 'email', label: 'E-mail'}, {key: 'actions', label: 'Ações'} ];
                setupTableSorting('corretores', headers);
                const filterText = document.getElementById('corretores-filter').value.toLowerCase();
                const filteredData = db.corretores.filter(c => c.nome.toLowerCase().includes(filterText) || c.creci.includes(filterText));
                renderPaginatedTable('corretores', filteredData);
            }

            window.renderContratos = () => {
                const headers = [ {key: 'numero', label: 'Número'}, {key: 'tipo', label: 'Tipo'}, {key: 'clienteId', label: 'Cliente'}, {key: 'imovelId', label: 'Imóvel'}, {key: 'dataInicio', label: 'Data Início'}, {key: 'status', label: 'Status'}, {key: 'actions', label: 'Ações'} ];
                setupTableSorting('contratos', headers);
                const filterText = document.getElementById('contratos-filter').value.toLowerCase();
                const filteredData = db.contratos.filter(c => {
                    const cl = db.clientes.find(cli => cli.id === c.clienteId) || {}; 
                    const im = db.imoveis.find(imv => imv.id === c.imovelId) || {};
                    return c.numero.toLowerCase().includes(filterText) || (cl.nome || '').toLowerCase().includes(filterText) || (cl.razaoSocial || '').toLowerCase().includes(filterText) || (im.endereco || '').toLowerCase().includes(filterText); 
                });
                renderPaginatedTable('contratos', filteredData);
            }

            const getSelectedIds = (module) => {
                const selected = [];
                document.querySelectorAll(`#${module}-table .row-selector:checked`).forEach(chk => {
                    selected.push(chk.dataset.id);
                });
                return selected;
            };

            const updateContextualBar = (module) => {
                const bar = document.getElementById(`${module}-contextual-bar`);
                const countSpan = document.getElementById(`${module}-selection-count`);
                const selectedIds = getSelectedIds(module);

                if (selectedIds.length > 0) {
                    countSpan.textContent = `${selectedIds.length} item(ns) selecionado(s)`;
                    bar.style.display = 'flex';
                } else {
                    bar.style.display = 'none';
                }
            };

            const setupBulkActions = () => {
                // Imóveis - Bulk Status Change
                const imoveisBulkBtn = document.getElementById('imoveis-bulk-action-btn');
                if (imoveisBulkBtn) {
                    imoveisBulkBtn.addEventListener('click', () => {
                        const selectedIds = getSelectedIds('imoveis');
                        const newStatus = document.getElementById('imoveis-bulk-status-select').value;
                        if (!newStatus) {
                            showNotification('Por favor, selecione um status para aplicar.', 'warning');
                            return;
                        }
                        if (selectedIds.length === 0) {
                             showNotification('Nenhum imóvel selecionado.', 'warning');
                            return;
                        }

                        let changedCount = 0;
                        selectedIds.forEach(id => {
                            const imovel = db.imoveis.find(i => i.id === id);
                            if (imovel) {
                                imovel.status = newStatus;
                                changedCount++;
                            }
                        });
                        saveDb();
                        showNotification(`${changedCount} imóvel(is) tiveram o status alterado para "${newStatus}".`, 'success');
                        renderImoveis();
                    });
                }
                // Imóveis - Export Selected
                const imoveisExportBtn = document.getElementById('imoveis-export-selected-btn');
                 if(imoveisExportBtn) {
                     imoveisExportBtn.addEventListener('click', () => {
                         const selectedIds = getSelectedIds('imoveis');
                         if (selectedIds.length === 0) {
                            showNotification('Nenhum imóvel selecionado para exportar.', 'warning');
                            return;
                         }
                         const dataToExport = db.imoveis.filter(i => selectedIds.includes(i.id)).map(i => ({
                             Endereco: i.endereco, Tipo: i.tipo, Status: i.status, Valor: formatCurrency(i.valor), Proprietario: i.proprietario, Quartos: i.quartos, Banheiros: i.banheiros
                         }));
                         const ws = XLSX.utils.json_to_sheet(dataToExport);
                         const wb = XLSX.utils.book_new();
                         XLSX.utils.book_append_sheet(wb, ws, "Imoveis Selecionados");
                         XLSX.writeFile(wb, `imoveis_selecionados_${new Date().toISOString().slice(0,10)}.xlsx`);
                     });
                 }
                
                // Clientes - Export Selected
                const clientesExportBtn = document.getElementById('clientes-export-selected-btn');
                 if(clientesExportBtn) {
                     clientesExportBtn.addEventListener('click', () => {
                         const selectedIds = getSelectedIds('clientes');
                         if (selectedIds.length === 0) {
                            showNotification('Nenhum cliente selecionado para exportar.', 'warning');
                            return;
                         }
                         const dataToExport = db.clientes.filter(c => selectedIds.includes(c.id)).map(c => ({
                             Nome: c.nome || c.razaoSocial, Documento: c.cpf || c.cnpj, Email: c.email, Telefone: c.telefone
                         }));
                         const ws = XLSX.utils.json_to_sheet(dataToExport);
                         const wb = XLSX.utils.book_new();
                         XLSX.utils.book_append_sheet(wb, ws, "Clientes Selecionados");
                         XLSX.writeFile(wb, `clientes_selecionados_${new Date().toISOString().slice(0,10)}.xlsx`);
                     });
                 }
            };
            
            const applyPermissions = (role) => {
                const isAdmin = role === 'admin';
                document.querySelectorAll('[data-role="admin-only"]').forEach(el => {
                    el.style.display = isAdmin ? '' : 'none';
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                     if (!isAdmin) btn.style.display = 'none';
                });
                 if (!isAdmin) {
                    document.getElementById('clear-data-btn').disabled = true;
                 }
            }

            const simpleHash = str => {
                if(!str) return '';
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash |= 0; 
                }
                return hash.toString();
            };

            const checkAuth = () => {
                if (!db.config.passwordHash) {
                    let newPassword = prompt("Bem-vindo! Por favor, defina a senha do administrador (mínimo 3 caracteres):");
                    while (!newPassword || newPassword.length < 3) {
                        newPassword = prompt("A senha precisa ter no mínimo 3 caracteres. Por favor, defina a senha do administrador:");
                    }
                    db.config.passwordHash = simpleHash(newPassword);
                    saveDb();
                    showNotification('Senha de administrador definida com sucesso!', 'success');
                }

                const role = prompt("Digite seu nível de acesso ('admin' ou 'corretor'):", "admin") || 'corretor';
                if (role.toLowerCase() === 'admin') {
                    const passwordAttempt = prompt("Por favor, insira a senha de administrador:");
                    if (simpleHash(passwordAttempt) === db.config.passwordHash) {
                        currentUserRole = 'admin';
                        showNotification('Acesso de Administrador concedido.', 'success');
                    } else {
                        showNotification('Senha incorreta. Acessando como corretor.', 'error');
                        currentUserRole = 'corretor';
                    }
                } else {
                    currentUserRole = 'corretor';
                    showNotification('Acessando como corretor.', 'info');
                }
                applyPermissions(currentUserRole);
            };

            document.getElementById('password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPassword = document.querySelector('#password-form [name="newPassword"]').value;
                if(newPassword.length < 3) {
                    showNotification('A nova senha deve ter no mínimo 3 caracteres.', 'error');
                    return;
                }
                db.config.passwordHash = simpleHash(newPassword);
                saveDb();
                showNotification('Senha de administrador alterada com sucesso!', 'success');
                document.querySelector('#password-form [name="newPassword"]').value = '';
            });

            const contractTemplateForm = document.getElementById('contract-template-form');
            const renderContractTemplates = () => {
                const defaultText = db.contractTemplates.length > 0 ? '-- Selecione um modelo para editar --' : '-- Crie seu primeiro modelo abaixo --';
                populateSelect('#select-contract-template', db.contractTemplates, 'name', 'id', defaultText);
                
                const typeSelect = contractTemplateForm.querySelector('[name="type"]');
                typeSelect.innerHTML = '<option value="">Selecione um tipo...</option>';
                for(const key in db.config.contractTypes) {
                    typeSelect.innerHTML += `<option value="${key}">${db.config.contractTypes[key]}</option>`;
                }
            };

            const renderConfigCustomizations = () => {
                const finCatList = document.getElementById('finance-categories-list');
                finCatList.innerHTML = '';
                db.config.financeCategories.forEach((cat, index) => {
                    finCatList.innerHTML += `<div class="file-list-form"><span class="file-info">${cat}</span><span class="file-actions"><button type="button" class="remove-btn" onclick="removeFinanceCategory(${index})"><i class="fas fa-times-circle"></i></button></span></div>`;
                });

                const funnelList = document.getElementById('funnel-stages-list');
                funnelList.innerHTML = '';
                Object.keys(db.config.funnelStages).forEach(key => {
                    funnelList.innerHTML += `<div class="file-list-form"><span class="file-info">${db.config.funnelStages[key]}</span></div>`;
                });
            };

            window.removeFinanceCategory = (index) => {
                if (confirm(`Tem certeza que deseja remover a categoria "${db.config.financeCategories[index]}"?`)) {
                    db.config.financeCategories.splice(index, 1);
                    saveDb();
                    renderConfigCustomizations();
                }
            };
            
            document.getElementById('add-finance-category-btn').addEventListener('click', () => {
                const input = document.getElementById('new-finance-category-input');
                const newCategory = input.value.trim();
                if(newCategory && !db.config.financeCategories.includes(newCategory)) {
                    db.config.financeCategories.push(newCategory);
                    saveDb();
                    renderConfigCustomizations();
                    input.value = '';
                } else if (!newCategory) {
                    showNotification('O nome da categoria não pode ser vazio.', 'error');
                } else {
                    showNotification('Esta categoria já existe.', 'warning');
                }
            });

            document.getElementById('select-contract-template').addEventListener('change', e => {
                const id = e.target.value;
                const deleteBtn = document.getElementById('delete-template-btn');
                contractTemplateForm.reset(); 
                renderContractTemplates(); 
                document.getElementById('select-contract-template').value = id;

                if (id) {
                    const template = db.contractTemplates.find(t => t.id === id);
                    contractTemplateForm.querySelector('[name="id"]').value = template.id;
                    contractTemplateForm.querySelector('[name="name"]').value = template.name;
                    contractTemplateForm.querySelector('[name="type"]').value = template.type; 
                    contractTemplateForm.querySelector('[name="content"]').value = template.content;
                    deleteBtn.style.display = 'inline-block';
                } else {
                    contractTemplateForm.querySelector('[name="id"]').value = '';
                    deleteBtn.style.display = 'none';
                }
            });

            contractTemplateForm.addEventListener('submit', e => {
                e.preventDefault();
                const id = contractTemplateForm.querySelector('[name="id"]').value;
                const name = contractTemplateForm.querySelector('[name="name"]').value;
                const type = contractTemplateForm.querySelector('[name="type"]').value; 
                const content = contractTemplateForm.querySelector('[name="content"]').value;
                if (!name || !type) { showNotification('O Nome e o Tipo do modelo são obrigatórios.', 'error'); return; }

                if (id) {
                    const index = db.contractTemplates.findIndex(t => t.id === id);
                    if (index > -1) {
                       db.contractTemplates[index] = { ...db.contractTemplates[index], name, type, content };
                       showNotification('Modelo de contrato atualizado!', 'success');
                    }
                } else {
                    db.contractTemplates.push({ id: generateId(), name, type, content });
                    showNotification('Modelo de contrato salvo!', 'success');
                }
                saveDb();
                contractTemplateForm.reset();
                renderContractTemplates();
                document.getElementById('delete-template-btn').style.display = 'none';
            });
             document.getElementById('delete-template-btn').addEventListener('click', () => {
                const id = contractTemplateForm.querySelector('[name="id"]').value;
                if (id && confirm('Tem certeza que deseja excluir este modelo de contrato?')) {
                    db.contractTemplates = db.contractTemplates.filter(t => t.id !== id);
                    saveDb();
                    renderContractTemplates();
                    contractTemplateForm.reset();
                    document.getElementById('delete-template-btn').style.display = 'none';
                    showNotification('Modelo excluído.', 'info');
                }
            });

            document.getElementById('download-template-btn').addEventListener('click', () => {
                const headers = [
                    "nome", "razaoSocial", "cpf", "cnpj", "dataNascimento", "email", "telefone", "estadoCivil", 
                    "profissao", "rua", "numero", "complemento", "bairro", "cidade", 
                    "estado", "cep", "endereco_alternativo",
                    "contato_add_1_nome", "contato_add_1_relacao", "contato_add_1_tel",
                    "contato_add_2_nome", "contato_add_2_relacao", "contato_add_2_tel",
                    "contato_add_3_nome", "contato_add_3_relacao", "contato_add_3_tel"
                ];
                const ws = XLSX.utils.aoa_to_sheet([headers]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Clientes");
                XLSX.writeFile(wb, "modelo_importacao_clientes.xlsx");
                showNotification('Modelo Excel (.xlsx) baixado com sucesso!', 'success');
            });

            document.getElementById('import-excel-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        
                        let importedCount = 0;
                        let skippedCount = 0;
                        if (json.length > 0 && confirm(`Foram encontrados ${json.length} clientes na planilha. Deseja importá-los?`)) {
                            json.forEach(row => {
                                if ((row.nome || row.razaoSocial) && (row.email || row.cpf || row.cnpj)) {
                                    const newClient = { id: generateId(), funnelStage: 'lead', notes: [], commissionPaid: null, postSaleTasks: [] };
                                    Object.keys(row).forEach(key => {
                                        newClient[key] = row[key];
                                    });
                                    newClient.tipoPessoa = newClient.cnpj ? 'juridica' : 'fisica';
                                    db.clientes.push(newClient);
                                    importedCount++;
                                } else {
                                    skippedCount++;
                                }
                            });
                            saveDb();
                            renderClientes();
                            showNotification(`${importedCount} clientes importados com sucesso! ${skippedCount > 0 ? `(${skippedCount} linhas ignoradas)` : ''}`, 'success');
                        } else {
                            showNotification('Importação cancelada ou nenhum cliente válido encontrado.', 'info');
                        }
                    } catch (err) {
                        showNotification('Erro ao processar o arquivo. Verifique o formato.', 'error');
                        console.error("Excel import error:", err);
                    }
                    e.target.value = ''; 
                };
                reader.onerror = () => showNotification('Falha ao ler o arquivo.', 'error');
                reader.readAsArrayBuffer(file);
            });
            
            const findMatchingClients = (imovel) => {
                return db.clientes.filter(cliente => {
                    const profile = cliente.searchProfile_tipo || cliente.searchProfile_quartos || cliente.searchProfile_precoMin || cliente.searchProfile_precoMax;
                    if (!profile) return false;

                    const tipoMatch = !cliente.searchProfile_tipo || cliente.searchProfile_tipo === imovel.tipo;
                    const quartosMatch = !cliente.searchProfile_quartos || parseInt(imovel.quartos) >= parseInt(cliente.searchProfile_quartos);
                    const precoMinMatch = !cliente.searchProfile_precoMin || parseCurrency(imovel.valor) >= cliente.searchProfile_precoMin;
                    const precoMaxMatch = !cliente.searchProfile_precoMax || parseCurrency(imovel.valor) <= cliente.searchProfile_precoMax;
                    
                    return tipoMatch && quartosMatch && precoMinMatch && precoMaxMatch;
                });
            };

            const findMatchingProperties = (cliente) => {
                const profile = cliente.searchProfile_tipo || cliente.searchProfile_quartos || cliente.searchProfile_precoMin || cliente.searchProfile_precoMax;
                if (!profile) return [];

                return db.imoveis.filter(imovel => {
                    if (imovel.status !== 'Disponível') return false;

                    const tipoMatch = !cliente.searchProfile_tipo || cliente.searchProfile_tipo === imovel.tipo;
                    const quartosMatch = !cliente.searchProfile_quartos || parseInt(imovel.quartos) >= parseInt(cliente.searchProfile_quartos);
                    const precoMinMatch = !cliente.searchProfile_precoMin || parseCurrency(imovel.valor) >= cliente.searchProfile_precoMin;
                    const precoMaxMatch = !cliente.searchProfile_precoMax || parseCurrency(imovel.valor) <= cliente.searchProfile_precoMax;

                    return tipoMatch && quartosMatch && precoMinMatch && precoMaxMatch;
                });
            };

            const setupCompactViewToggle = (module) => {
                const toggleBtn = document.getElementById(`${module}-compact-view-toggle`);
                const table = document.getElementById(`${module}-table`);
                if (!toggleBtn || !table) return;

                toggleBtn.addEventListener('click', () => {
                    table.classList.toggle('compact-view');
                    const isCompact = table.classList.contains('compact-view');
                    toggleBtn.innerHTML = isCompact ? '<i class="fas fa-expand-arrows-alt"></i> Visão Padrão' : '<i class="fas fa-compress-arrows-alt"></i> Visão Compacta';
                    toggleBtn.classList.toggle('btn-primary', isCompact);
                    toggleBtn.classList.toggle('btn-outline-primary', !isCompact);
                });
            };
            
            const renderFavoritesModal = () => {
                const modalBody = document.getElementById('favorites-modal-body');
                let html = '';
                const favoriteProperties = db.imoveis.filter(i => imovelFavoritos.includes(i.id));

                if (favoriteProperties.length === 0) {
                    html = '<div class="empty-state"><i class="far fa-star"></i><p>Sua lista de favoritos está vazia.</p><p>Clique na estrela dos imóveis para adicioná-los aqui.</p></div>';
                } else {
                    html = `<div id="favorites-printable-area" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">`;
                    favoriteProperties.forEach(i => {
                        html += `
                            <div class="property-card" style="cursor:pointer;" onclick="viewImovelDetails('${i.id}'); closeModal('favorites-modal');">
                                <div class="property-card-img-wrapper" style="height: 140px;">
                                    <img src="${i.fotos?.[0] || 'https://via.placeholder.com/250x140.png?text=Sem+Foto'}" class="property-card-img">
                                </div>
                                <div class="property-card-body">
                                    <div class="property-card-price">${formatCurrency(i.valor)}</div>
                                    <h4 class="property-card-title">${i.endereco}</h4>
                                </div>
                                 <i class="fas fa-star favorite-star favorited" style="text-shadow: none; opacity: 1;" onclick="event.stopPropagation(); toggleFavorite('${i.id}', event); renderFavoritesModal();"></i>
                            </div>`;
                    });
                    html += `</div>`;
                }
                modalBody.innerHTML = html;
                openModal('favorites-modal');
            };
            
            const init = () => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('view') === 'property' && params.get('id')) {
                    loadDb(); 
                    renderPublicPropertyPage(params.get('id'));
                } else {
                    document.getElementById('app-view').style.display = 'block';
                    loadDb(); 
                    // checkAuth(); // Desabilitado para facilitar teste, reabilitar em produção
                    applyPermissions(currentUserRole);

                    updateNotificationCount(); 
                    updateFavoritesCount();
                    
                    renderDashboard(); 
                    renderClientes(); 
                    renderImoveis(); 
                    renderCorretores();
                    renderContratos();
                    renderFinanceiro();
                    renderAnalises();
                    loadConfigForms();
                    setupCalendarEventListeners();
                    setupBulkActions();
                    renderConfigCustomizations();
                    
                    document.querySelectorAll('.currency-input').forEach(input => {
                        input.addEventListener('input', e => formatInputAsCurrency(e.target));
                    });

                    document.querySelectorAll('#clientes-filter-text, #clientes-filter-spc').forEach(el => el.addEventListener('input', () => { pageState.clientes.currentPage = 1; renderClientes(); }));
                    document.getElementById('clientes-clear-filters').addEventListener('click', () => { document.getElementById('clientes-filter-text').value = ''; document.getElementById('clientes-filter-spc').value = ''; pageState.clientes.currentPage = 1; renderClientes(); });
                    document.querySelectorAll('#imoveis-filter-text, #imoveis-filter-tipo, #imoveis-filter-status, #imoveis-filter-quartos').forEach(el => el.addEventListener('input', () => { pageState.imoveis.currentPage = 1; renderImoveis(); }));
                    document.getElementById('imoveis-clear-filters').addEventListener('click', () => { document.getElementById('imoveis-filter-text').value = ''; document.getElementById('imoveis-filter-tipo').value = ''; document.getElementById('imoveis-filter-status').value = ''; document.getElementById('imoveis-filter-quartos').value = ''; pageState.imoveis.currentPage = 1; renderImoveis(); });
                    document.getElementById('corretores-filter').addEventListener('input', () => { pageState.corretores.currentPage = 1; renderCorretores(); });
                    document.getElementById('contratos-filter').addEventListener('input', () => { pageState.contratos.currentPage = 1; renderContratos(); });
                    document.querySelectorAll('#financeiro-filter-text, #financeiro-filter-cliente').forEach(el => el.addEventListener('input', () => { pageState.financeiro.currentPage = 1; renderFinanceiro(); }));
                    document.getElementById('financeiro-clear-filters').addEventListener('click', () => { document.getElementById('financeiro-filter-text').value = ''; document.getElementById('financeiro-filter-cliente').value = ''; pageState.financeiro.currentPage = 1; renderFinanceiro(); });

                    // Listener CORRIGIDO para o formulário de contrato
                    document.getElementById('contrato-form').addEventListener('change', e => {
                        const form = e.currentTarget;
                        const generateBtn = document.getElementById('generate-contract-from-template-btn');
                        const templateSelect = form.querySelector('#contrato-template-select');
                        
                        const locacaoFields = document.getElementById('locacao-fields');
                        const corretagemFields = document.getElementById('corretagem-fields');
                        const propostaFields = document.getElementById('proposta-fields');

                        if (e.target.name === 'tipo') {
                            const tipoContrato = e.target.value;
                            const filteredTemplates = db.contractTemplates.filter(t => t.type === tipoContrato);
                            const defaultText = filteredTemplates.length > 0 ? "Selecione um modelo..." : "Nenhum modelo para este tipo";
                            populateSelect('#contrato-template-select', filteredTemplates, 'name', 'id', defaultText);
                            
                            locacaoFields.style.display = 'none';
                            corretagemFields.style.display = 'none';
                            propostaFields.style.display = 'none';

                            if(tipoContrato === 'Locacao'){
                                locacaoFields.style.display = 'block';
                            } else if(tipoContrato === 'Corretagem') {
                                corretagemFields.style.display = 'block';
                            } else if(tipoContrato === 'Proposta') {
                                propostaFields.style.display = 'block';
                            }
                        }
                        generateBtn.disabled = !templateSelect.value;
                    });


                    document.getElementById('config-form').addEventListener('submit', (e) => { e.preventDefault(); db.config.companyName = document.querySelector('#config-form [name="companyName"]').value; db.config.companyCnpj = document.querySelector('#config-form [name="companyCnpj"]').value; saveDb(); showNotification('Configurações da empresa salvas!', 'success'); });
                    document.getElementById('goals-form').addEventListener('submit', (e) => { e.preventDefault(); db.config.salesGoal = parseCurrency(document.querySelector('#goals-form [name="salesGoal"]').value); db.config.contractsGoal = parseInt(document.querySelector('#goals-form [name="contractsGoal"]').value, 10); saveDb(); showNotification('Metas mensais salvas!', 'success'); renderAnalises(); });
                    document.getElementById('backup-btn').addEventListener('click', () => { db.lastBackup = new Date().toISOString(); saveDb(); const d = JSON.stringify(db); const b = new Blob([d], {type: "application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `backup_imobiliaria_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(u); showNotification('Backup gerado com sucesso!', 'success'); renderDashboard(); });
                    document.getElementById('restore-input').addEventListener('change', e => { if (!confirm('Restaurar dados substituirá todos os dados atuais! Continuar?')) return; const f = e.target.files[0]; const r = new FileReader(); r.onload = ev => { try { const rDb = JSON.parse(ev.target.result); localStorage.clear(); Object.keys(rDb).forEach(k => localStorage.setItem(`db_${k}`, JSON.stringify(rDb[k]))); showNotification('Dados restaurados com sucesso! A página será recarregada.', 'success'); setTimeout(() => location.reload(), 2000); } catch { showNotification('Arquivo de backup inválido.', 'error'); } }; r.readAsText(f); });
                    document.getElementById('clear-data-btn').addEventListener('click', () => { if(currentUserRole !== 'admin') { showNotification('Apenas administradores podem executar esta ação.', 'error'); return; } const conf = prompt('Esta ação é IRREVERSÍVEL. Para confirmar, digite "EXCLUIR" abaixo:'); if (conf === 'EXCLUIR') { localStorage.clear(); showNotification('Todos os dados foram apagados! A página será recarregada.', 'warning'); setTimeout(() => location.reload(), 2000); } else if(conf !== null) { showNotification('Ação de limpeza cancelada.', 'info'); } });
                    
                    document.getElementById('favorites-btn').addEventListener('click', renderFavoritesModal);
                    document.getElementById('generate-favorites-pdf').addEventListener('click', () => generatePdf('favorites-printable-area', 'Imoveis_Favoritos.pdf', 'PDF com favoritos gerado!'));
                    
                    document.getElementById('logout-btn').addEventListener('click', e => {
                        e.preventDefault();
                        if (confirm('Tem certeza que deseja sair do sistema?')) {
                            // Limpa o token de sessão para deslogar o usuário
                            sessionStorage.removeItem('sessionToken');
                            sessionStorage.removeItem('currentUser');
                            // Redireciona para a página de login
                            window.location.href = 'login.html';
                        }
                    });
                    
                    setupFormValidation('cliente-form');
                    setupFormValidation('corretor-form');
                    setupFormValidation('imovel-form');
                    setupFormValidation('contract-template-form');
                    setupCompactViewToggle('clientes');
                    setupCompactViewToggle('imoveis');

                    comissaoForm.dispatchEvent(new Event('input'));
                    handleNavigation('dashboard'); 
                    
                    const lastVersion = localStorage.getItem('appVersion');
                    if (lastVersion !== appVersion) {
                        openModal('whats-new-modal');
                        localStorage.setItem('appVersion', appVersion);
                    }

                    setInterval(checkUpcomingEvents, 30000); 
                    setInterval(() => {
                         if (document.getElementById('dashboard').classList.contains('active')) {
                             renderActionableItems();
                         }
                    }, 60000);
                    
                    document.getElementById('dashboard-period-select').addEventListener('change', (e) => {
                        renderDashboard(e.target.value);
                    });

                    document.getElementById('save-fin-simulation-btn').addEventListener('click', () => {
                        const clienteId = document.getElementById('fin-sim-cliente-select').value;
                        if (!clienteId) {
                            showNotification('Por favor, selecione um cliente para salvar a simulação.', 'error');
                            return;
                        }
                        const simulationData = {
                            id: generateId(),
                            clienteId: clienteId,
                            date: new Date().toISOString(),
                            type: 'Financiamento',
                            valorImovel: document.getElementById('fin-valor-imovel').value,
                            valorEntrada: document.getElementById('fin-valor-entrada').value,
                            prazoAnos: document.getElementById('fin-prazo-anos').value,
                            taxaJuros: document.getElementById('fin-taxa-juros').value,
                            results: {
                                priceParcela: document.getElementById('price-res-parcela').textContent,
                                priceTotal: document.getElementById('price-res-total-pago').textContent,
                                sacPrimeira: document.getElementById('sac-res-primeira-parcela').textContent,
                                sacUltima: document.getElementById('sac-res-ultima-parcela').textContent,
                                sacTotal: document.getElementById('sac-res-total-pago').textContent
                            }
                        };
                        if(!db.simulations) db.simulations = [];
                        db.simulations.push(simulationData);
                        saveDb();
                        showNotification(`Simulação salva com sucesso no dossiê do cliente!`, 'success');
                    });

                    document.getElementById('launch-commission-btn').addEventListener('click', () => {
                        const comissaoBruta = document.getElementById('com-res-total').textContent;
                        const valor = parseCurrency(comissaoBruta);
                        
                        if (valor <= 0) {
                            showNotification('Não há valor de comissão para lançar.', 'error');
                            return;
                        }
                        
                        const financeiroForm = document.getElementById('financeiro-form');
                        financeiroForm.reset();
                        document.querySelector('#financeiro-form [name="id"]').value = '';
                        document.getElementById('financeiro-modal-title').textContent = 'Novo Lançamento de Comissão';
                        
                        const valorVenda = document.getElementById('com-valor-venda').value;
                        
                        document.querySelector('#financeiro-form [name="descricao"]').value = `Comissão referente à venda de R$ ${valorVenda}`;
                        document.querySelector('#financeiro-form [name="valor"]').value = comissaoBruta.replace('R$', '').trim();
                        document.querySelector('#financeiro-form [name="data"]').valueAsDate = new Date();
                        document.querySelector('#financeiro-form [name="tipo"]').value = 'saida';
                        
                        const categorySelect = document.getElementById('financeiro-category-select');
                        categorySelect.innerHTML = db.config.financeCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                        categorySelect.value = 'Comissão de Venda';
                        
                        populateSelect('#financeiro-cliente-select', db.clientes, 'nome', 'id', 'Selecione o cliente da venda...');
                        
                        showNotification('Dados da comissão preenchidos. Confirme o lançamento.', 'info');
                        openModal('financeiro-modal');
                    });
                }
            };
            
            document.addEventListener('keydown', (e) => {
                if (document.querySelector('.modal[style*="display: flex"]') && e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(m => closeModal(m.id));
                }

                const activeEl = document.activeElement;
                const isInputActive = activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable;

                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                    const openModal = document.querySelector('.modal[style*="display: flex"]');
                    if(openModal) {
                        e.preventDefault();
                        const saveButton = openModal.querySelector('button[type="submit"]');
                        if (saveButton && !saveButton.disabled) saveButton.click();
                    }
                }
                
                if (isInputActive) return;

                if (e.altKey) {
                    switch(e.key.toLowerCase()) {
                        case 'c': e.preventDefault(); document.getElementById('novo-cliente-btn').click(); break;
                        case 'i': e.preventDefault(); document.getElementById('novo-imovel-btn').click(); break;
                        case 'r': e.preventDefault(); document.getElementById('novo-corretor-btn').click(); break;
                    }
                }
            });

            init();
        });
    </script>
</body>
</html>